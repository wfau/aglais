#
# <meta:header>
#   <meta:licence>
#     Copyright (c) 2019, ROE (http://www.roe.ac.uk/)
#
#     This information is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This information is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
#   </meta:licence>
# </meta:header>
#
#

# -----------------------------------------------------
# Update our base image.
#[user@desktop]

    source "${HOME}/atolmis.settings"
    pushd "${ATOLMIS_CODE:?}"

        gedit docker/fedora/Dockerfile &

        ~   # FROM fedora:31
        ~   # https://github.com/docker-library/repo-info/blob/master/repos/fedora/tag-details.md#fedora31
        ~   FROM fedora@sha256:d4f7df6b691d61af6cee7328f82f1d8afdef63bc38f58516858ae3045083924a

    popd

# -----------------------------------------------------
# Add patch to our base image.
#[user@desktop]

    source "${HOME}/atolmis.settings"
    pushd "${ATOLMIS_CODE:?}"

        gedit docker/fedora/Dockerfile &

            #
            # Install common admin tools.
            RUN dnf install -y \
                ....
                nano \
        +       patch \
                pwgen \
                ....

    popd

# -----------------------------------------------------
# Add the Octavia client to our OpenStack client.
#[user@desktop]

    source "${HOME}/atolmis.settings"
    pushd "${ATOLMIS_CODE:?}"

        gedit docker/openstack-client/Dockerfile &

            RUN dnf install -y python3-openstackclient
            RUN dnf install -y python3-magnumclient
        +   RUN dnf install -y python3-octaviaclient

    popd

# -----------------------------------------------------
# Create a patch to fix the encoding issue.
# https://bugs.launchpad.net/python-magnumclient/+bug/1812816
# https://storyboard.openstack.org/#!/story/2004902
# https://review.opendev.org/gitweb?p=openstack%2Fpython-magnumclient.git;a=commitdiff;h=3f7b994acd3eaac2321006b34cebfcb07d924934
#[user@desktop]

    # Create a temp directory for the patch.
    patchdir=$(mktemp -d)

    docker run \
        --rm -it \
        --volume "${patchdir}:/patchdir" \
        atolmis/openstack-client \
            bash

        # Create a backup copy.
        cp /usr/lib/python3.7/site-packages/magnumclient/common/utils.py \
           /usr/lib/python3.7/site-packages/magnumclient/common/utils.bak

        # Apply the fix.
        sed -i '
            /from oslo_serialization/ {
                i \
from oslo_serialization import base64
                }
            s/b64encode/encode_as_text/g
            ' /usr/lib/python3.7/site-packages/magnumclient/common/utils.py

        # Create a patch file.
        diff -c /usr/lib/python3.7/site-packages/magnumclient/common/utils.bak \
                /usr/lib/python3.7/site-packages/magnumclient/common/utils.py  \
        | tee /patchdir/encoding.patch

        # Exit the container.
        exit

# -----------------------------------------------------
# Test the patchfile.
#[user@desktop]

    docker run \
        --rm -it \
        --volume "${patchdir}:/patchdir" \
        atolmis/openstack-client \
            bash

        # Create a backup copy.
        cp /usr/lib/python3.7/site-packages/magnumclient/common/utils.py \
           /usr/lib/python3.7/site-packages/magnumclient/common/utils.bak

        # Apply the patch.
        patch -i /patchdir/encoding.patch \
            /usr/lib/python3.7/site-packages/magnumclient/common/utils.py

        # Check the result.
        diff /usr/lib/python3.7/site-packages/magnumclient/common/utils.bak \
             /usr/lib/python3.7/site-packages/magnumclient/common/utils.py

    >   26a27
    >   > from oslo_serialization import base64
    >   218,220c219,221
    >   <                       'key': base64.b64encode(certs['key']),
    >   <                       'cert': base64.b64encode(certs['cert']),
    >   <                       'ca': base64.b64encode(certs['ca'])})
    >   ---
    >   >                       'key': base64.encode_as_text(certs['key']),
    >   >                       'cert': base64.encode_as_text(certs['cert']),
    >   >                       'ca': base64.encode_as_text(certs['ca'])})
    >   253c254
    >   <                       'ca': base64.b64encode(certs['ca'])})
    >   ---
    >   >                       'ca': base64.encode_as_text(certs['ca'])})

# -----------------------------------------------------
# Add the patchfile to the Docker image.
#[user@desktop]

    source "${HOME}/atolmis.settings"
    pushd "${ATOLMIS_CODE:?}"

        cp ${patchdir}/encoding.patch \
           docker/openstack-client

        gedit docker/openstack-client/Dockerfile &

            RUN dnf install -y python3-openstackclient
            RUN dnf install -y python3-magnumclient
            RUN dnf install -y python3-octaviaclient

        +   # Apply the encoding fix.
        +   COPY encoding.patch /tmp
        +   RUN  patch -i /tmp/encoding.patch \
                 /usr/lib/python3.7/site-packages/magnumclient/common/utils.py

    popd


# -----------------------------------------------------
# Add the Kubernetes client to our OpenStack client.
#[user@desktop]

    source "${HOME}/atolmis.settings"
    pushd "${ATOLMIS_CODE:?}"

        gedit docker/openstack-client/Dockerfile &

        +   RUN dnf install -y kubernetes-client

    popd


# -----------------------------------------------------
# Build our containers.
#[user@desktop]

    source "${HOME}/atolmis.settings"
    pushd "${ATOLMIS_CODE:?}"

        buildtag=$(date '+%Y.%m.%d')
        buildtime=$(date '+%Y-%m-%dT%H:%M:%S')

        docker build \
            --build-arg "buildtag=${buildtag:?}" \
            --build-arg "buildtime=${buildtime:?}" \
            --tag atolmis/fedora:latest \
            --tag atolmis/fedora:${buildtag:?} \
            docker/fedora

        docker build \
            --build-arg "buildtag=${buildtag:?}" \
            --build-arg "buildtime=${buildtime:?}" \
            --tag atolmis/openssh-client:latest \
            --tag atolmis/openssh-client:${buildtag:?} \
            docker/openssh-client

        docker build \
            --build-arg "buildtag=${buildtag:?}" \
            --build-arg "buildtime=${buildtime:?}" \
            --tag atolmis/openstack-client:latest \
            --tag atolmis/openstack-client:${buildtag:?} \
            docker/openstack-client

        docker build \
            --build-arg "buildtag=${buildtag:?}" \
            --build-arg "buildtime=${buildtime:?}" \
            --tag atolmis/ansible-client:latest \
            --tag atolmis/ansible-client:${buildtag:?} \
            docker/ansible-client

        docker build \
            --build-arg "buildtag=${buildtag:?}" \
            --build-arg "buildtime=${buildtime:?}" \
            --tag atolmis/java:latest \
            --tag atolmis/java:${buildtag:?} \
            docker/java

        docker build \
            --build-arg "buildtag=${buildtag:?}" \
            --build-arg "buildtime=${buildtime:?}" \
            --tag atolmis/kafka:latest \
            --tag atolmis/kafka:${buildtag:?} \
            docker/kafka

    popd


# -----------------------------------------------------
# Create our cloud YAML file.
#[user@desktop]

cat > "${HOME}/cumulus.yaml" << EOF

clouds:
  cumulus:
    auth_url: 'https://cumulus.openstack.hpc.cam.ac.uk:5000/v3'
    auth_type: 'v3applicationcredential'
    application_credential_id: '$(secret 'cumulus.cam.ac.uk.CREDENTIAL_ID')'
    application_credential_secret: '$(secret 'cumulus.cam.ac.uk.CREDENTIAL_SECRET')'
    region_name: 'RegionOne'
    interface: 'public'
    identity_api_version: 3

EOF


# -----------------------------------------------------
# Create a container to work with.
#[user@desktop]

    docker run \
        --rm \
        --tty \
        --user "$(id -u)" \
        --interactive \
        --hostname openstacker \
        --env SSH_AUTH_SOCK=/tmp/ssh_auth_sock \
        --volume "${SSH_AUTH_SOCK}:/tmp/ssh_auth_sock" \
        --volume "${HOME}/cumulus.yaml:/etc/openstack/clouds.yaml" \
        atolmis/openstack-client \
        bash


# -----------------------------------------------------
# List our keypairs.
#[user@openstacker]

    openstack \
        --os-cloud gaia-dev \
        keypair list

    >   +----------------+-------------------------------------------------+
    >   | Name           | Fingerprint                                     |
    >   +----------------+-------------------------------------------------+
    >   | aglais-ansible | a4:8b:f3:0a:31:eb:93:b2:98:62:c5:d2:02:31:0f:b4 |
    >   +----------------+-------------------------------------------------+


# -----------------------------------------------------
# Get the ID for our keypair.
#[user@openstacker]

    keyname=$(
        openstack \
            --os-cloud cumulus \
            keypair list \
                --format json \
        | jq -r '.[0] | .Name'
        )

    echo "Key [${keyname:?}]"

    >   Key [aglais-ansible]


# -----------------------------------------------------
# List our flavours.
#[user@openstacker]

    openstack \
        --os-cloud cumulus \
        flavor list

    >   +--------------------------------------+-------------------+--------+------+-----------+-------+-----------+
    >   | ID                                   | Name              |    RAM | Disk | Ephemeral | VCPUs | Is Public |
    >   +--------------------------------------+-------------------+--------+------+-----------+-------+-----------+
    >   | 20061eba-9e88-494c-95a3-41ed77721244 | general.v1.small  |  22528 |   20 |         0 |     6 | True      |
    >   | 406a17e0-afd0-47d3-a6ad-8b19198bdd97 | general.v1.tiny   |   6144 |   12 |         0 |     2 | True      |
    >   | 8a821ef8-20b8-4bbb-990b-91198745e7a7 | general.v1.xlarge | 184320 |   20 |       340 |    28 | True      |
    >   | 996c1c8c-c934-411c-9631-b74eb2829631 | general.v1.medium |  46080 |   20 |        60 |    14 | True      |
    >   | c4c07f5a-260a-4f22-9530-a09a19aa490a | general.v1.large  |  92160 |   20 |       160 |    28 | True      |
    >   +--------------------------------------+-------------------+--------+------+-----------+-------+-----------+


# -----------------------------------------------------
# Get the flavor ID for tiny.
#[user@openstacker]

    flavorty=$(
        openstack \
            --os-cloud cumulus \
            flavor list \
                --format json \
        | jq -r '.[] | select(.Name | test("tiny")) | .ID'
        )

    echo "Flavor [${flavorty:?}]"

    >   Flavor [406a17e0-afd0-47d3-a6ad-8b19198bdd97]


# -----------------------------------------------------
# Get the flavor ID for small.
#[user@openstacker]

    flavorsm=$(
        openstack \
            --os-cloud cumulus \
            flavor list \
                --format json \
        | jq -r '.[] | select(.Name | test("small")) | .ID'
        )

    echo "Flavor [${flavorsm:?}]"

    >   Flavor [20061eba-9e88-494c-95a3-41ed77721244]


# -----------------------------------------------------
# List our cluster templates.
#[user@openstacker]

    openstack \
        --os-cloud cumulus \
        coe cluster template list

    >   +--------------------------------------+------------------------------+
    >   | uuid                                 | name                         |
    >   +--------------------------------------+------------------------------+
    >   | b9e6104d-d264-4980-9581-6073d25f732c | kubernetes-1.14.6_nginx_as   |
    >   | b75535d9-45dc-42ed-a43c-4644d617284a | kubernetes-1.14.6_traefik_as |
    >   | 41437926-8461-4fdf-ac1b-ff97325a79f8 | kubernetes-1.14.6_octavia_as |
    >   +--------------------------------------+------------------------------+


# -----------------------------------------------------
# Get the ID of the Octavia template.
#[user@openstacker]

    templateid=$(
        openstack \
            --os-cloud cumulus \
            coe cluster template list \
                --format json \
        | jq -r '.[] | select(.name | test("octavia")) | .uuid'
        )

    echo "Template [${templateid:?}]"

    >   Template [41437926-8461-4fdf-ac1b-ff97325a79f8]

# -----------------------------------------------------
# Create a new cluster.
#[user@openstacker]

    openstack \
        -v -v \
        --os-cloud cumulus \
        coe cluster create \
            --keypair "${keyname}" \
            --flavor  "${flavorsm}" \
            --node-count 1 \
            --master-count 1 \
            --master-flavor "${flavorsm}" \
            --cluster-template "${templateid}" \
            'albert'

    >   Request to create cluster e8820e82-81b7-4b91-a45b-e320df906316 accepted


    echo "Request to create cluster e8820e82-81b7-4b91-a45b-e320df906316 accepted" \
    | sed 's/.* \([^ ]*-[^ ]*\) .*/\1/'

    >   e8820e82-81b7-4b91-a45b-e320df906316


# -----------------------------------------------------
# List our clusters.
#[user@openstacker]

    openstack \
        --os-cloud cumulus \
        coe cluster list

    >   +--------------------------------------+--------+----------------+------------+--------------+---------------+
    >   | uuid                                 | name   | keypair        | node_count | master_count | status        |
    >   +--------------------------------------+--------+----------------+------------+--------------+---------------+
    >   | f8631637-a7a7-42fe-a230-54dc656a5a3b | albert | aglais-ansible |          3 |            1 | CREATE_FAILED |
    >   +--------------------------------------+--------+----------------+------------+--------------+---------------+


# -----------------------------------------------------
# Get the ID of our cluster.
#[user@openstacker]

    clusterid=$(
        openstack \
            --os-cloud cumulus \
            coe cluster list \
                --format json \
        | jq -r '.[0] | .uuid'
        )

    echo "Cluster [${clusterid:?}]"

    >   Cluster [f8631637-a7a7-42fe-a230-54dc656a5a3b]


# -----------------------------------------------------
# Show details for our cluster.
#[user@openstacker]

    openstack \
        --os-cloud cumulus \
        coe cluster show \
            "${clusterid:?}"

    >   +---------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    >   | Field               | Value                                                                                                                                                                                                                                                                                                                                                                                                  |
    >   +---------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    >   | status              | CREATE_FAILED                                                                                                                                                                                                                                                                                                                                                                                          |
    >   | cluster_template_id | 41437926-8461-4fdf-ac1b-ff97325a79f8                                                                                                                                                                                                                                                                                                                                                                   |
    >   | node_addresses      | []                                                                                                                                                                                                                                                                                                                                                                                                     |
    >   | uuid                | f8631637-a7a7-42fe-a230-54dc656a5a3b                                                                                                                                                                                                                                                                                                                                                                   |
    >   | stack_id            | None                                                                                                                                                                                                                                                                                                                                                                                                   |
    >   | status_reason       | Failed to create trustee or trust for Cluster: f8631637-a7a7-42fe-a230-54dc656a5a3b                                                                                                                                                                                                                                                                                                                    |
    >   | created_at          | 2019-11-20T03:25:59+00:00                                                                                                                                                                                                                                                                                                                                                                              |
    >   | updated_at          | 2019-11-20T03:26:00+00:00                                                                                                                                                                                                                                                                                                                                                                              |
    >   | coe_version         | None                                                                                                                                                                                                                                                                                                                                                                                                   |
    >   | labels              | {'tiller_enabled': 'true', 'kube_tag': 'v1.14.6', .... } |
    >   | faults              | {}                                                                                                                                                                                                                                                                                                                                                                                                     |
    >   | keypair             | aglais-ansible                                                                                                                                                                                                                                                                                                                                                                                         |
    >   | api_address         | None                                                                                                                                                                                                                                                                                                                                                                                                   |
    >   | master_addresses    | []                                                                                                                                                                                                                                                                                                                                                                                                     |
    >   | create_timeout      | 60                                                                                                                                                                                                                                                                                                                                                                                                     |
    >   | node_count          | 3                                                                                                                                                                                                                                                                                                                                                                                                      |
    >   | discovery_url       | None                                                                                                                                                                                                                                                                                                                                                                                                   |
    >   | master_count        | 1                                                                                                                                                                                                                                                                                                                                                                                                      |
    >   | container_version   | None                                                                                                                                                                                                                                                                                                                                                                                                   |
    >   | name                | albert                                                                                                                                                                                                                                                                                                                                                                                                 |
    >   | master_flavor_id    | 406a17e0-afd0-47d3-a6ad-8b19198bdd97                                                                                                                                                                                                                                                                                                                                                                   |
    >   | flavor_id           | 20061eba-9e88-494c-95a3-41ed77721244                                                                                                                                                                                                                                                                                                                                                                   |
    >   +---------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+


    # Similar error to yesterday.
    # Yesterday's fix was to use keypair ...
    # Do we have the keypair loaded in memory ?

    # Create using the Horizon GUI with the same params works OK.
    # Use the GUI created cluster for now and come back to this later ...


# -----------------------------------------------------
# List our clusters.
#[user@openstacker]

    openstack \
        --os-cloud cumulus \
        coe cluster list

    >   +--------------------------------------+--------+----------------+------------+--------------+--------------------+
    >   | uuid                                 | name   | keypair        | node_count | master_count | status             |
    >   +--------------------------------------+--------+----------------+------------+--------------+--------------------+
    >   | 887c67fc-0fb6-4970-a85e-29ae2c0f7382 | albert | aglais-ansible |          1 |            1 | CREATE_FAILED      |
    >   | a14a5393-0e46-48d7-9158-69153b15451a | albert | aglais-ansible |          1 |            1 | CREATE_IN_PROGRESS |
    >   +--------------------------------------+--------+----------------+------------+--------------+--------------------+


# -----------------------------------------------------
# Get the ID of our healthy cluster.
#[user@openstacker]

    clusterid=$(
        openstack \
            --os-cloud cumulus \
            coe cluster list \
                --format json \
        | jq -r '.[1] | .uuid'
        )

    echo "Cluster [${clusterid:?}]"

    >   Cluster [a14a5393-0e46-48d7-9158-69153b15451a]


# -----------------------------------------------------
# Show details for our cluster.
#[user@openstacker]

    openstack \
        --os-cloud cumulus \
        coe cluster show \
            "${clusterid:?}"

    >   +---------------------+---------------------------------------------------------------+
    >   | Field               | Value                                                         |
    >   +---------------------+---------------------------------------------------------------+
    >   | status              | CREATE_IN_PROGRESS                                            |
    >   | cluster_template_id | 41437926-8461-4fdf-ac1b-ff97325a79f8                          |
    >   | node_addresses      | []                                                            |
    >   | uuid                | a14a5393-0e46-48d7-9158-69153b15451a                          |
    >   | stack_id            | 31aec622-6814-463c-9a5d-23c28fa94a3c                          |
    >   | status_reason       | None                                                          |
    >   | created_at          | 2019-11-20T04:12:24+00:00                                     |
    >   | updated_at          | 2019-11-20T04:12:32+00:00                                     |
    >   | coe_version         | None                                                          |
    >   | labels              | { .... }                                                      |
    >   | faults              |                                                               |
    >   | keypair             | aglais-ansible                                                |
    >   | api_address         | None                                                          |
    >   | master_addresses    | []                                                            |
    >   | create_timeout      | 60                                                            |
    >   | node_count          | 1                                                             |
    >   | discovery_url       | https://discovery.etcd.io/49ab865da33a8c8d426079c3e0ca0059    |
    >   | master_count        | 1                                                             |
    >   | container_version   | None                                                          |
    >   | name                | albert                                                        |
    >   | master_flavor_id    | general.v1.small                                              |
    >   | flavor_id           | general.v1.small                                              |
    >   +---------------------+---------------------------------------------------------------+


    labels : {
        'tiller_enabled': 'true',
        'kube_tag': 'v1.14.6',
        'max_node_count': '5',
        'cloud_provider_tag': 'v1.14.0',
        'tiller_tag': 'v2.14.3',
        'monitoring_enabled': 'true',
        'cgroup_driver': 'cgroupfs',
        'min_node_count': '1',
        'master_lb_floating_ip_enabled': 'true',
        'ingress_controller': 'octavia',
        'heat_container_agent_tag': 'train-stable-1',
        'autoscaler_tag': 'v1.0',
        'auto_scaling_enabled': 'true'
        }


# -----------------------------------------------------
# List our networks.
#[user@openstacker]

    openstack \
        --os-cloud cumulus \
        network list

    >   +--------------------------------------+--------------------+----------------------------------------------------------------------------+
    >   | ID                                   | Name               | Subnets                                                                    |
    >   +--------------------------------------+--------------------+----------------------------------------------------------------------------+
    >   | 1a17cdb6-23dc-4f17-b7e4-d7f316bb560f | stv-aglais-network | a45354a2-a6de-4d25-8a6b-90dbda3a24e0                                       |
    >   | 29b18056-1dc0-4f81-85c5-03e7657a349a | private            | f185a147-218b-40b7-9bdd-fdbeac616139                                       |
    >   | a929e8db-1bf4-4a5f-a80c-fabd39d06a26 | internet           | 180dc961-c52f-461a-b241-8f7a30d022a5, 273123bb-70f6-4f51-a406-7fc4b446532d |
    >   | ecb791d5-1022-447a-a79c-8f38a0f5c990 | cumulus-internal   | 01b76c7c-3c1a-4c5c-9a5a-14bcf6c0c290                                       |
    >   +--------------------------------------+--------------------+----------------------------------------------------------------------------+


# -----------------------------------------------------
# List our routers.
#[user@openstacker]

    openstack \
        --os-cloud cumulus \
        router list

    >   +--------------------------------------+-----------------------------------------------------------------+--------+-------+----------------------------------+
    >   | ID                                   | Name                                                            | Status | State | Project                          |
    >   +--------------------------------------+-----------------------------------------------------------------+--------+-------+----------------------------------+
    >   | 6449a129-8722-43d8-888f-3c30c24f138f | albert-k3bqclinnoze-network-q23pe5ki6bqp-extrouter-btab43fb5nts | ACTIVE | UP    | 08e24c6d87f94740aa59c172462ed927 |
    >   | 9dd1eef8-715c-435e-86a1-553a15104266 | stv-aglais-router                                               | ACTIVE | UP    | 08e24c6d87f94740aa59c172462ed927 |
    >   +--------------------------------------+-----------------------------------------------------------------+--------+-------+----------------------------------+


# -----------------------------------------------------
# List our load balancers.
#[user@openstacker]

    openstack \
        --os-cloud cumulus \
        loadbalancer \
            list

    >   +--------------------------------------+--------------------------------------------------------------------+----------------------------------+-------------+---------------------+----------+
    >   | id                                   | name                                                               | project_id                       | vip_address | provisioning_status | provider |
    >   +--------------------------------------+--------------------------------------------------------------------+----------------------------------+-------------+---------------------+----------+
    >   | 232a3522-787b-4500-9160-4b843ec18c31 | albert-k3bqclinnoze-etcd_lb-z62cjoktj55o-loadbalancer-yhh3f363u6vu | 08e24c6d87f94740aa59c172462ed927 | 10.0.0.12   | ACTIVE              | amphora  |
    >   | b0624e31-2bd1-4858-a653-75e6593f59e3 | albert-k3bqclinnoze-api_lb-wxd6dop3542o-loadbalancer-i65ngflabfj3  | 08e24c6d87f94740aa59c172462ed927 | 10.0.0.16   | ACTIVE              | amphora  |
    >   +--------------------------------------+--------------------------------------------------------------------+----------------------------------+-------------+---------------------+----------+


# -----------------------------------------------------
# Get details of our 'api' load balancer.
#[user@openstacker]

    apibalancer=$(
        openstack \
            --os-cloud cumulus \
            loadbalancer \
                list \
                    --format json \
        | jq -r '.[] | select(.name | test("-api")) | .id'
        )

    openstack \
        --os-cloud cumulus \
        loadbalancer \
            show \
                "${apibalancer:?}"

    >   +---------------------+-------------------------------------------------------------------+
    >   | Field               | Value                                                             |
    >   +---------------------+-------------------------------------------------------------------+
    >   | admin_state_up      | True                                                              |
    >   | created_at          | 2019-11-20T04:12:47                                               |
    >   | description         |                                                                   |
    >   | flavor_id           | None                                                              |
    >   | id                  | b0624e31-2bd1-4858-a653-75e6593f59e3                              |
    >   | listeners           | d6e839db-97da-4fc8-8309-27d6921cd727                              |
    >   | name                | albert-k3bqclinnoze-api_lb-wxd6dop3542o-loadbalancer-i65ngflabfj3 |
    >   | operating_status    | ONLINE                                                            |
    >   | pools               | 1d6c307e-03f7-4ea2-a0fb-7190fad5bd5d                              |
    >   | project_id          | 08e24c6d87f94740aa59c172462ed927                                  |
    >   | provider            | amphora                                                           |
    >   | provisioning_status | ACTIVE                                                            |
    >   | updated_at          | 2019-11-20T04:18:47                                               |
    >   | vip_address         | 10.0.0.16                                                         |
    >   | vip_network_id      | 29b18056-1dc0-4f81-85c5-03e7657a349a                              |
    >   | vip_port_id         | 286072d5-2141-46cb-b3d1-7e02d21caa8c                              |
    >   | vip_qos_policy_id   | None                                                              |
    >   | vip_subnet_id       | f185a147-218b-40b7-9bdd-fdbeac616139                              |
    >   +---------------------+-------------------------------------------------------------------+


# -----------------------------------------------------
# Get details of our 'etcd' load balancer.
#[user@openstacker]

    etcbalancer=$(
        openstack \
            --os-cloud cumulus \
            loadbalancer \
                list \
                    --format json \
        | jq -r '.[] | select(.name | test("-etcd")) | .id'
        )

    openstack \
        --os-cloud cumulus \
        loadbalancer \
            show \
                "${etcbalancer:?}"

    >   +---------------------+--------------------------------------------------------------------+
    >   | Field               | Value                                                              |
    >   +---------------------+--------------------------------------------------------------------+
    >   | admin_state_up      | True                                                               |
    >   | created_at          | 2019-11-20T04:12:46                                                |
    >   | description         |                                                                    |
    >   | flavor_id           | None                                                               |
    >   | id                  | 232a3522-787b-4500-9160-4b843ec18c31                               |
    >   | listeners           | 6ced3a28-cdb2-49f0-8d47-f13364a39b7c                               |
    >   | name                | albert-k3bqclinnoze-etcd_lb-z62cjoktj55o-loadbalancer-yhh3f363u6vu |
    >   | operating_status    | ONLINE                                                             |
    >   | pools               | 04e0c75c-8806-46b9-b78e-f1c77f16e9ec                               |
    >   | project_id          | 08e24c6d87f94740aa59c172462ed927                                   |
    >   | provider            | amphora                                                            |
    >   | provisioning_status | ACTIVE                                                             |
    >   | updated_at          | 2019-11-20T04:18:41                                                |
    >   | vip_address         | 10.0.0.12                                                          |
    >   | vip_network_id      | 29b18056-1dc0-4f81-85c5-03e7657a349a                               |
    >   | vip_port_id         | 6a37a689-cfb9-418e-9281-e4fd8a7bd89c                               |
    >   | vip_qos_policy_id   | None                                                               |
    >   | vip_subnet_id       | f185a147-218b-40b7-9bdd-fdbeac616139                               |
    >   +---------------------+--------------------------------------------------------------------+


# -----------------------------------------------------
# Get config details for our cluster.
# https://github.com/cncf/k8s-conformance/tree/master/v1.11/openstack-magnum#create-kubernetes-cluster
#[user@openstacker]

    confdir=$(mktemp -d)

    openstack \
        --os-cloud cumulus \
        coe cluster config \
            --dir "${confdir}" \
            "${clusterid:?}"

    >   'SHELL'


    ls -al "${confdir}"

    >   ....
    >   -rw-r--r--. 1 1000 root 5313 Nov 20 04:27 config


    cat "${confdir}/config"

    >   apiVersion: v1
    >   clusters:
    >   - cluster:
    >       certificate-authority-data: LS0t....tLS0=
    >       server: https://128.232.227.135:6443
    >     name: albert
    >   contexts:
    >   - context:
    >       cluster: albert
    >       user: admin
    >     name: default
    >   current-context: default
    >   kind: Config
    >   preferences: {}
    >   users:
    >   - name: admin
    >     user:
    >       client-certificate-data: LS0t....tLS0=
    >       client-key-data: LS0t....tLQo=


# -----------------------------------------------------
# Check our kubectl settings.
#[user@openstacker]

    export HOME=$(mktemp -d)

    kubectl \
        --kubeconfig "${confdir}/config" \
        config  \
            get-contexts

    >   CURRENT   NAME      CLUSTER   AUTHINFO   NAMESPACE
    >   *         default   albert    admin


# -----------------------------------------------------
# Check we can connect to our cluster.
#[user@openstacker]

    kubectl \
        --kubeconfig "${confdir}/config" \
        cluster-info


    >   Kubernetes master is running at https://128.232.227.135:6443
    >   Heapster is running at https://128.232.227.135:6443/api/v1/namespaces/kube-system/services/heapster/proxy
    >   CoreDNS is running at https://128.232.227.135:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
    >   
    >   To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
























