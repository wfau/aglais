#
# <meta:header>
#   <meta:licence>
#     Copyright (c) 2020, ROE (http://www.roe.ac.uk/)
#
#     This information is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This information is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
#   </meta:licence>
# </meta:header>
#
#

    # Encountered conflicts when creating router for CephFS.
    # Attempt to delete everything and start clean.


# -----------------------------------------------------
# Create a container to work with.
#[user@desktop]

    source "${HOME:?}/aglais.env"

    podman run \
        --rm \
        --tty \
        --interactive \
        --hostname openstacker \
        --env "clouduser=${AGLAIS_USER:?}" \
        --env "cloudname=${AGLAIS_CLOUD:?}" \
        --volume "${HOME:?}/clouds.yaml:/tmp/clouds.yaml:ro,z" \
        atolmis/openstack-client \
        bash

# -----------------------------------------------------
# Link our clouds.cfg file.
# https://docs.openstack.org/python-openstackclient/pike/configuration/index.html#clouds-yaml
#[root@openstacker]

    mkdir -p "${HOME:?}/.config/openstack"
    pushd "${HOME:?}/.config/openstack"
        ln -sf /tmp/clouds.yaml
    popd

# -----------------------------------------------------
# List our clusters.
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        coe cluster list

    >   +--------------------------------------+---------+---------+------------+--------------+---------------+---------------+
    >   | uuid                                 | name    | keypair | node_count | master_count | status        | health_status |
    >   +--------------------------------------+---------+---------+------------+--------------+---------------+---------------+
    >   | ab708936-f205-4953-9ce0-50f9097fbecd | my-test | my-test |          1 |            1 | DELETE_FAILED | HEALTHY       |
    >   +--------------------------------------+---------+---------+------------+--------------+---------------+---------------+


# -----------------------------------------------------
# Try deleting our clusters.
#[user@openstacker]

    for clusterid in $(
        openstack \
            --os-cloud "${cloudname:?}" \
            coe cluster list \
                --format json \
        | jq -r '.[] | .uuid'
        )
        do
            echo "---- ----"
            echo "Cluster [${clusterid:?}]"

            openstack \
                --os-cloud "${cloudname:?}" \
                coe cluster delete \
                    "${clusterid:?}"

        done

    >   Request to delete cluster ab708936-f205-4953-9ce0-50f9097fbecd has been accepted.


# -----------------------------------------------------
# Check what is left ...
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        coe cluster list

    >   +--------------------------------------+---------+---------+------------+--------------+--------------------+---------------+
    >   | uuid                                 | name    | keypair | node_count | master_count | status             | health_status |
    >   +--------------------------------------+---------+---------+------------+--------------+--------------------+---------------+
    >   | ab708936-f205-4953-9ce0-50f9097fbecd | my-test | my-test |          1 |            1 | DELETE_IN_PROGRESS | HEALTHY       |
    >   +--------------------------------------+---------+---------+------------+--------------+--------------------+---------------+


    openstack \
        --os-cloud "${cloudname:?}" \
        stack list

    >   +--------------------------------------+----------------------+---------------+----------------------+----------------------+
    >   | ID                                   | Stack Name           | Stack Status  | Creation Time        | Updated Time         |
    >   +--------------------------------------+----------------------+---------------+----------------------+----------------------+
    >   | 33553b5b-7221-4898-8a3f-92c0c61da418 | my-test-lmck76anbakg | DELETE_FAILED | 2020-06-23T11:09:46Z | 2020-06-26T15:24:17Z |
    >   +--------------------------------------+----------------------+---------------+----------------------+----------------------+


    openstack \
        --os-cloud "${cloudname:?}" \
        server list

    >   -


    openstack \
        --os-cloud "${cloudname:?}" \
        volume list

    >   -


    openstack \
        --os-cloud "${cloudname:?}" \
        floating ip list

    >   -


    openstack \
        --os-cloud "${cloudname:?}" \
        security group list

    >   +--------------------------------------+---------+------------------------+----------------------------------+------+
    >   | ID                                   | Name    | Description            | Project                          | Tags |
    >   +--------------------------------------+---------+------------------------+----------------------------------+------+
    >   | aa63efff-7c67-4f29-ba7c-a1d85695407b | default | Default security group | 21b4ae3a2ea44bc5a9c14005ed2963af | []   |
    >   +--------------------------------------+---------+------------------------+----------------------------------+------+


    openstack \
        --os-cloud "${cloudname:?}" \
        keypair list

    >   +------------------+-------------------------------------------------+
    >   | Name             | Fingerprint                                     |
    >   +------------------+-------------------------------------------------+
    >   | zrq-gaia-keypair | a4:8b:f3:0a:31:eb:93:b2:98:62:c5:d2:02:31:0f:b4 |
    >   +------------------+-------------------------------------------------+



    openstack \
        --os-cloud "${cloudname:?}" \
        loadbalancer list

    >   -


    openstack \
        --os-cloud "${cloudname:?}" \
        router list

    >   +--------------------------------------+------------------------------------------------------------------+--------+-------+----------------------------------+
    >   | ID                                   | Name                                                             | Status | State | Project                          |
    >   +--------------------------------------+------------------------------------------------------------------+--------+-------+----------------------------------+
    >   | 682d9323-4741-4aca-ae18-4a2a5179fb3f | my-test-lmck76anbakg-network-vr2ukas2ycen-extrouter-zijow7edgqfh | ACTIVE | UP    | 21b4ae3a2ea44bc5a9c14005ed2963af |
    >   | a0ebbabf-dd40-4678-9b94-3b25eb83da0f | test-magnum-to-ceph                                              | ACTIVE | UP    | 21b4ae3a2ea44bc5a9c14005ed2963af |
    >   +--------------------------------------+------------------------------------------------------------------+--------+-------+----------------------------------+



    openstack \
        --os-cloud "${cloudname:?}" \
        network list

    >   +--------------------------------------+------------------+----------------------------------------------------------------------------+
    >   | ID                                   | Name             | Subnets                                                                    |
    >   +--------------------------------------+------------------+----------------------------------------------------------------------------+
    >   | 423a1e6d-6ec2-41b4-970b-85f39a795c0f | private          | f5b9c9f4-e9c4-491b-9828-1bf336c684ae                                       |
    >   | a929e8db-1bf4-4a5f-a80c-fabd39d06a26 | internet         | 180dc961-c52f-461a-b241-8f7a30d022a5, 273123bb-70f6-4f51-a406-7fc4b446532d |
    >   | ecb791d5-1022-447a-a79c-8f38a0f5c990 | cumulus-internal | 01b76c7c-3c1a-4c5c-9a5a-14bcf6c0c290                                       |
    >   +--------------------------------------+------------------+----------------------------------------------------------------------------+


    openstack \
        --os-cloud "${cloudname:?}" \
        port list

    >   +--------------------------------------+------+-------------------+---------------------------------------------------------------------------+--------+
    >   | ID                                   | Name | MAC Address       | Fixed IP Addresses                                                        | Status |
    >   +--------------------------------------+------+-------------------+---------------------------------------------------------------------------+--------+
    >   | 5ca16445-58a5-48c6-b737-684df3da905a |      | fa:16:3e:82:52:d8 | ip_address='10.0.0.1', subnet_id='f5b9c9f4-e9c4-491b-9828-1bf336c684ae'   | ACTIVE |
    >   | 701cfe36-a5f5-4374-a438-cb638e931866 |      | fa:16:3e:d6:98:2b | ip_address='10.0.0.3', subnet_id='f5b9c9f4-e9c4-491b-9828-1bf336c684ae'   | ACTIVE |
    >   | 742a195b-9717-41e4-bfa6-1f52ae70a8ed |      | fa:16:3e:cf:54:7d | ip_address='10.0.0.137', subnet_id='f5b9c9f4-e9c4-491b-9828-1bf336c684ae' | ACTIVE |
    >   | 8a0f9cff-30c6-49d4-81f6-cb479d6cc6f4 |      | fa:16:3e:4c:89:4a | ip_address='10.0.0.2', subnet_id='f5b9c9f4-e9c4-491b-9828-1bf336c684ae'   | ACTIVE |
    >   +--------------------------------------+------+-------------------+---------------------------------------------------------------------------+--------+


    openstack \
        --os-cloud "${cloudname:?}" \
        subnet list

    >   +--------------------------------------+-----------------------------------------------------------------------+--------------------------------------+---------------+
    >   | ID                                   | Name                                                                  | Network                              | Subnet        |
    >   +--------------------------------------+-----------------------------------------------------------------------+--------------------------------------+---------------+
    >   | 01b76c7c-3c1a-4c5c-9a5a-14bcf6c0c290 | cumulus-internal                                                      | ecb791d5-1022-447a-a79c-8f38a0f5c990 | 10.218.0.0/16 |
    >   | f5b9c9f4-e9c4-491b-9828-1bf336c684ae | my-test-lmck76anbakg-network-vr2ukas2ycen-private_subnet-ey45tlwqaadz | 423a1e6d-6ec2-41b4-970b-85f39a795c0f | 10.0.0.0/24   |
    >   +--------------------------------------+-----------------------------------------------------------------------+--------------------------------------+---------------+





# -----------------------------------------------------
# Release our ports and delete our routers
#[user@openstacker]

    for routerid in $(
        openstack \
            --os-cloud "${cloudname:?}" \
            router list \
                --format json \
        | jq -r '.[] | .ID'
        )
    do
        echo "---- ----"
        echo "Router [${routerid:?}]"

        for portid in $(
            openstack \
                --os-cloud "${cloudname:?}" \
                port list \
                    --router "${routerid:?}" \
                    --format json \
            | jq -r '.[] | .ID'
            )
        do
            echo "Port   [${portid:?}]"
            openstack \
                --os-cloud "${cloudname:?}" \
                router remove port \
                    "${routerid:?}" \
                    "${portid:?}"
        done

        openstack \
            --os-cloud "${cloudname:?}" \
            router delete \
                "${routerid:?}"

    done


    >   ---- ----
    >   Router [682d9323-4741-4aca-ae18-4a2a5179fb3f]
    >   Port   [5ca16445-58a5-48c6-b737-684df3da905a]
    >   ConflictException: 409: Client Error for url: https://cumulus.openstack.hpc.cam.ac.uk:9696/v2.0/routers/682d9323-4741-4aca-ae18-4a2a5179fb3f/remove_router_interface, Router interface for subnet f5b9c9f4-e9c4-491b-9828-1bf336c684ae on router 682d9323-4741-4aca-ae18-4a2a5179fb3f cannot be deleted, as it is required by one or more routes.
    >   Failed to delete router with name or ID '682d9323-4741-4aca-ae18-4a2a5179fb3f': ConflictException: 409: Client Error for url: https://cumulus.openstack.hpc.cam.ac.uk:9696/v2.0/routers/682d9323-4741-4aca-ae18-4a2a5179fb3f, Router 682d9323-4741-4aca-ae18-4a2a5179fb3f still has ports
    >   1 of 1 routers failed to delete.
    >   ---- ----
    >   Router [a0ebbabf-dd40-4678-9b94-3b25eb83da0f]
    >   Port   [742a195b-9717-41e4-bfa6-1f52ae70a8ed]

# -----------------------------------------------------
# ....
#[user@openstacker]

    #
    # Error message :
    # Router interface for subnet f5b9c9f4-e9c4-491b-9828-1bf336c684ae on router 682d9323-4741-4aca-ae18-4a2a5179fb3f cannot be deleted, as it is required by one or more routes.
    #

    openstack \
        --os-cloud "${cloudname:?}" \
        router list

    >   +--------------------------------------+------------------------------------------------------------------+--------+-------+----------------------------------+
    >   | ID                                   | Name                                                             | Status | State | Project                          |
    >   +--------------------------------------+------------------------------------------------------------------+--------+-------+----------------------------------+
    >   | 682d9323-4741-4aca-ae18-4a2a5179fb3f | my-test-lmck76anbakg-network-vr2ukas2ycen-extrouter-zijow7edgqfh | ACTIVE | UP    | 21b4ae3a2ea44bc5a9c14005ed2963af |
    >   +--------------------------------------+------------------------------------------------------------------+--------+-------+----------------------------------+


    openstack \
        --os-cloud "${cloudname:?}" \
        route list

    >   +--------------------------------------+------------------------------------------------------------------+--------+-------+----------------------------------+
    >   | ID                                   | Name                                                             | Status | State | Project                          |
    >   +--------------------------------------+------------------------------------------------------------------+--------+-------+----------------------------------+
    >   | 682d9323-4741-4aca-ae18-4a2a5179fb3f | my-test-lmck76anbakg-network-vr2ukas2ycen-extrouter-zijow7edgqfh | ACTIVE | UP    | 21b4ae3a2ea44bc5a9c14005ed2963af |
    >   +--------------------------------------+------------------------------------------------------------------+--------+-------+----------------------------------+


    openstack \
        --os-cloud "${cloudname:?}" \
        port list

    >   +--------------------------------------+------+-------------------+-------------------------------------------------------------------------+--------+
    >   | ID                                   | Name | MAC Address       | Fixed IP Addresses                                                      | Status |
    >   +--------------------------------------+------+-------------------+-------------------------------------------------------------------------+--------+
    >   | 5ca16445-58a5-48c6-b737-684df3da905a |      | fa:16:3e:82:52:d8 | ip_address='10.0.0.1', subnet_id='f5b9c9f4-e9c4-491b-9828-1bf336c684ae' | ACTIVE |
    >   | 701cfe36-a5f5-4374-a438-cb638e931866 |      | fa:16:3e:d6:98:2b | ip_address='10.0.0.3', subnet_id='f5b9c9f4-e9c4-491b-9828-1bf336c684ae' | ACTIVE |
    >   | 8a0f9cff-30c6-49d4-81f6-cb479d6cc6f4 |      | fa:16:3e:4c:89:4a | ip_address='10.0.0.2', subnet_id='f5b9c9f4-e9c4-491b-9828-1bf336c684ae' | ACTIVE |
    >   +--------------------------------------+------+-------------------+-------------------------------------------------------------------------+--------+


    openstack \
        --os-cloud "${cloudname:?}" \
        subnet list

    >   +--------------------------------------+-----------------------------------------------------------------------+--------------------------------------+---------------+
    >   | ID                                   | Name                                                                  | Network                              | Subnet        |
    >   +--------------------------------------+-----------------------------------------------------------------------+--------------------------------------+---------------+
    >   | 01b76c7c-3c1a-4c5c-9a5a-14bcf6c0c290 | cumulus-internal                                                      | ecb791d5-1022-447a-a79c-8f38a0f5c990 | 10.218.0.0/16 |
    >   | f5b9c9f4-e9c4-491b-9828-1bf336c684ae | my-test-lmck76anbakg-network-vr2ukas2ycen-private_subnet-ey45tlwqaadz | 423a1e6d-6ec2-41b4-970b-85f39a795c0f | 10.0.0.0/24   |
    >   +--------------------------------------+-----------------------------------------------------------------------+--------------------------------------+---------------+


    openstack \
        --os-cloud "${cloudname:?}" \
        network list

    >   +--------------------------------------+------------------+----------------------------------------------------------------------------+
    >   | ID                                   | Name             | Subnets                                                                    |
    >   +--------------------------------------+------------------+----------------------------------------------------------------------------+
    >   | 423a1e6d-6ec2-41b4-970b-85f39a795c0f | private          | f5b9c9f4-e9c4-491b-9828-1bf336c684ae                                       |
    >   | a929e8db-1bf4-4a5f-a80c-fabd39d06a26 | internet         | 180dc961-c52f-461a-b241-8f7a30d022a5, 273123bb-70f6-4f51-a406-7fc4b446532d |
    >   | ecb791d5-1022-447a-a79c-8f38a0f5c990 | cumulus-internal | 01b76c7c-3c1a-4c5c-9a5a-14bcf6c0c290                                       |
    >   +--------------------------------------+------------------+----------------------------------------------------------------------------+

# -----------------------------------------------------
# Try starting from a list of routers.
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        router list

    >   +--------------------------------------+------------------------------------------------------------------+--------+-------+----------------------------------+
    >   | ID                                   | Name                                                             | Status | State | Project                          |
    >   +--------------------------------------+------------------------------------------------------------------+--------+-------+----------------------------------+
    >   | 682d9323-4741-4aca-ae18-4a2a5179fb3f | my-test-lmck76anbakg-network-vr2ukas2ycen-extrouter-zijow7edgqfh | ACTIVE | UP    | 21b4ae3a2ea44bc5a9c14005ed2963af |
    >   +--------------------------------------+------------------------------------------------------------------+--------+-------+----------------------------------+


    for routerid in $(
        openstack \
            --os-cloud "${cloudname:?}" \
            router list \
                --format json \
        | jq -r '.[] | .ID'
        )
        do
            echo "---- ----"
            echo "Router [${routerid:?}]"
            openstack \
                --os-cloud "${cloudname:?}" \
                router show \
                    --format json \
                    "${routerid:?}"
        done

    >   ---- ----
    >   Router [682d9323-4741-4aca-ae18-4a2a5179fb3f]
    >   {
    >     "admin_state_up": true,
    >     "availability_zone_hints": [],
    >     "availability_zones": [
    >       "nova"
    >     ],
    >     "created_at": "2020-06-23T11:09:49Z",
    >     "description": "",
    >     "external_gateway_info": {
    >       "network_id": "a929e8db-1bf4-4a5f-a80c-fabd39d06a26",
    >       "enable_snat": true,
    >       "external_fixed_ips": [
    >         {
    >           "subnet_id": "273123bb-70f6-4f51-a406-7fc4b446532d",
    >           "ip_address": "128.232.227.195"
    >         }
    >       ]
    >     },
    >     "flavor_id": null,
    >     "id": "682d9323-4741-4aca-ae18-4a2a5179fb3f",
    >     "interfaces_info": [
    >       {
    >         "port_id": "5ca16445-58a5-48c6-b737-684df3da905a",
    >         "ip_address": "10.0.0.1",
    >         "subnet_id": "f5b9c9f4-e9c4-491b-9828-1bf336c684ae"
    >       }
    >     ],
    >     "location": {
    >       "cloud": "gaia-prod",
    >       "region_name": "RegionOne",
    >       "zone": null,
    >       "project": {
    >         "id": "21b4ae3a2ea44bc5a9c14005ed2963af",
    >         "name": null,
    >         "domain_id": null,
    >         "domain_name": null
    >       }
    >     },
    >     "name": "my-test-lmck76anbakg-network-vr2ukas2ycen-extrouter-zijow7edgqfh",
    >     "project_id": "21b4ae3a2ea44bc5a9c14005ed2963af",
    >     "revision_number": 12,
    >     "routes": [
    >       {
    >         "nexthop": "10.0.0.137",
    >         "destination": "10.206.0.0/16"
    >       }
    >     ],
    >     "status": "ACTIVE",
    >     "tags": [],
    >     "updated_at": "2020-06-25T17:38:34Z"
    >   }


    #
    # Which gives us a list of interfaces with ports and subnet IDs.
    #

    >     "interfaces_info": [
    >       {
    >         "port_id": "5ca16445-58a5-48c6-b737-684df3da905a",
    >         "ip_address": "10.0.0.1",
    >         "subnet_id": "f5b9c9f4-e9c4-491b-9828-1bf336c684ae"
    >       }
    >     ],


    #
    # The routes information is a bit thin.
    #


    >     "routes": [
    >       {
    >         "nexthop": "10.0.0.137",
    >         "destination": "10.206.0.0/16"
    >       }
    >     ],


# -----------------------------------------------------
# Try starting from a list of routes.
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        route list

    >   +--------------------------------------+------------------------------------------------------------------+--------+-------+----------------------------------+
    >   | ID                                   | Name                                                             | Status | State | Project                          |
    >   +--------------------------------------+------------------------------------------------------------------+--------+-------+----------------------------------+
    >   | 682d9323-4741-4aca-ae18-4a2a5179fb3f | my-test-lmck76anbakg-network-vr2ukas2ycen-extrouter-zijow7edgqfh | ACTIVE | UP    | 21b4ae3a2ea44bc5a9c14005ed2963af |
    >   +--------------------------------------+------------------------------------------------------------------+--------+-------+----------------------------------+


    for routeid in $(
        openstack \
            --os-cloud "${cloudname:?}" \
            route list \
                --format json \
        | jq -r '.[] | .ID'
        )
        do
            echo "---- ----"
            echo "Route [${routeid:?}]"
            openstack \
                --os-cloud "${cloudname:?}" \
                route show \
                    --format json \
                    "${routeid:?}"
        done

    >   ---- ----
    >   Route [682d9323-4741-4aca-ae18-4a2a5179fb3f]
    >   {
    >     "admin_state_up": true,
    >     "availability_zone_hints": [],
    >     "availability_zones": [
    >       "nova"
    >     ],
    >     "created_at": "2020-06-23T11:09:49Z",
    >     "description": "",
    >     "external_gateway_info": {
    >       "network_id": "a929e8db-1bf4-4a5f-a80c-fabd39d06a26",
    >       "enable_snat": true,
    >       "external_fixed_ips": [
    >         {
    >           "subnet_id": "273123bb-70f6-4f51-a406-7fc4b446532d",
    >           "ip_address": "128.232.227.195"
    >         }
    >       ]
    >     },
    >     "flavor_id": null,
    >     "id": "682d9323-4741-4aca-ae18-4a2a5179fb3f",
    >     "interfaces_info": [
    >       {
    >         "port_id": "5ca16445-58a5-48c6-b737-684df3da905a",
    >         "ip_address": "10.0.0.1",
    >         "subnet_id": "f5b9c9f4-e9c4-491b-9828-1bf336c684ae"
    >       }
    >     ],
    >     "location": {
    >       "cloud": "gaia-prod",
    >       "region_name": "RegionOne",
    >       "zone": null,
    >       "project": {
    >         "id": "21b4ae3a2ea44bc5a9c14005ed2963af",
    >         "name": null,
    >         "domain_id": null,
    >         "domain_name": null
    >       }
    >     },
    >     "name": "my-test-lmck76anbakg-network-vr2ukas2ycen-extrouter-zijow7edgqfh",
    >     "project_id": "21b4ae3a2ea44bc5a9c14005ed2963af",
    >     "revision_number": 12,
    >     "routes": [
    >       {
    >         "nexthop": "10.0.0.137",
    >         "destination": "10.206.0.0/16"
    >       }
    >     ],
    >     "status": "ACTIVE",
    >     "tags": [],
    >     "updated_at": "2020-06-25T17:38:34Z"
    >   }

    #
    # Both routeR and routE have the same info.
    #

# -----------------------------------------------------
# Try deleting the route.
#[user@openstacker]

    routeid=682d9323-4741-4aca-ae18-4a2a5179fb3f

    openstack \
        --os-cloud "${cloudname:?}" \
        route delete \
            "${routeid:?}"

    >   Failed to delete router with name or ID '682d9323-4741-4aca-ae18-4a2a5179fb3f':
    >       ConflictException: 409: Client Error for url: https://cumulus.openstack.hpc.cam.ac.uk:9696/v2.0/routers/682d9323-4741-4aca-ae18-4a2a5179fb3f,
    >           Router 682d9323-4741-4aca-ae18-4a2a5179fb3f still has ports
    >   1 of 1 routers failed to delete.

        # We tried to delete a routE, and Openstack said it failed to delete the routeR.

            "Router 682d9323-4741-4aca-ae18-4a2a5179fb3f still has ports"

        # So Openstack treats routE and routeR as the same thing.


# -----------------------------------------------------
# Try starting from a list of ports.
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        port list

    >   +--------------------------------------+------+-------------------+-------------------------------------------------------------------------+--------+
    >   | ID                                   | Name | MAC Address       | Fixed IP Addresses                                                      | Status |
    >   +--------------------------------------+------+-------------------+-------------------------------------------------------------------------+--------+
    >   | 5ca16445-58a5-48c6-b737-684df3da905a |      | fa:16:3e:82:52:d8 | ip_address='10.0.0.1', subnet_id='f5b9c9f4-e9c4-491b-9828-1bf336c684ae' | ACTIVE |
    >   | 701cfe36-a5f5-4374-a438-cb638e931866 |      | fa:16:3e:d6:98:2b | ip_address='10.0.0.3', subnet_id='f5b9c9f4-e9c4-491b-9828-1bf336c684ae' | ACTIVE |
    >   | 8a0f9cff-30c6-49d4-81f6-cb479d6cc6f4 |      | fa:16:3e:4c:89:4a | ip_address='10.0.0.2', subnet_id='f5b9c9f4-e9c4-491b-9828-1bf336c684ae' | ACTIVE |
    >   +--------------------------------------+------+-------------------+-------------------------------------------------------------------------+--------+


    for portid in $(
        openstack \
            --os-cloud "${cloudname:?}" \
            port list \
                --format json \
        | jq -r '.[] | .ID'
        )
        do
            echo "---- ----"
            echo "Port [${portid:?}]"
            openstack \
                --os-cloud "${cloudname:?}" \
                port show \
                    --format json \
                    "${portid:?}"
        done

    >   ---- ----
    >   Port [5ca16445-58a5-48c6-b737-684df3da905a]
    >   {
    >     "admin_state_up": true,
    >     "allowed_address_pairs": [],
    >     "binding_host_id": null,
    >     "binding_profile": null,
    >     "binding_vif_details": null,
    >     "binding_vif_type": null,
    >     "binding_vnic_type": "normal",
    >     "created_at": "2020-06-23T11:09:58Z",
    >     "data_plane_status": null,
    >     "description": "",
    >     "device_id": "682d9323-4741-4aca-ae18-4a2a5179fb3f",
    >     "device_owner": "network:ha_router_replicated_interface",
    >     "dns_assignment": [
    >       {
    >         "hostname": "host-10-0-0-1",
    >         "ip_address": "10.0.0.1",
    >         "fqdn": "host-10-0-0-1.iris.cumulus.local."
    >       }
    >     ],
    >     "dns_domain": null,
    >     "dns_name": "",
    >     "extra_dhcp_opts": [],
    >     "fixed_ips": [
    >       {
    >         "subnet_id": "f5b9c9f4-e9c4-491b-9828-1bf336c684ae",
    >         "ip_address": "10.0.0.1"
    >       }
    >     ],
    >     "id": "5ca16445-58a5-48c6-b737-684df3da905a",
    >     "ip_allocation": null,
    >     "location": {
    >       "cloud": "gaia-prod",
    >       "region_name": "RegionOne",
    >       "zone": null,
    >       "project": {
    >         "id": "21b4ae3a2ea44bc5a9c14005ed2963af",
    >         "name": null,
    >         "domain_id": null,
    >         "domain_name": null
    >       }
    >     },
    >     "mac_address": "fa:16:3e:82:52:d8",
    >     "name": "",
    >     "network_id": "423a1e6d-6ec2-41b4-970b-85f39a795c0f",
    >     "port_security_enabled": false,
    >     "project_id": "21b4ae3a2ea44bc5a9c14005ed2963af",
    >     "propagate_uplink_status": null,
    >     "qos_network_policy_id": null,
    >     "qos_policy_id": null,
    >     "resource_request": null,
    >     "revision_number": 8,
    >     "security_group_ids": [],
    >     "status": "ACTIVE",
    >     "tags": [],
    >     "trunk_details": null,
    >     "updated_at": "2020-06-23T11:10:27Z"
    >   }
    >   ---- ----
    >   Port [701cfe36-a5f5-4374-a438-cb638e931866]
    >   {
    >     "admin_state_up": true,
    >     "allowed_address_pairs": [],
    >     "binding_host_id": null,
    >     "binding_profile": null,
    >     "binding_vif_details": null,
    >     "binding_vif_type": null,
    >     "binding_vnic_type": "normal",
    >     "created_at": "2020-06-23T11:09:52Z",
    >     "data_plane_status": null,
    >     "description": "",
    >     "device_id": "dhcp37607fa3-c23c-5a22-ae91-c92033d7849e-423a1e6d-6ec2-41b4-970b-85f39a795c0f",
    >     "device_owner": "network:dhcp",
    >     "dns_assignment": [
    >       {
    >         "hostname": "host-10-0-0-3",
    >         "ip_address": "10.0.0.3",
    >         "fqdn": "host-10-0-0-3.iris.cumulus.local."
    >       }
    >     ],
    >     "dns_domain": null,
    >     "dns_name": "",
    >     "extra_dhcp_opts": [],
    >     "fixed_ips": [
    >       {
    >         "subnet_id": "f5b9c9f4-e9c4-491b-9828-1bf336c684ae",
    >         "ip_address": "10.0.0.3"
    >       }
    >     ],
    >     "id": "701cfe36-a5f5-4374-a438-cb638e931866",
    >     "ip_allocation": null,
    >     "location": {
    >       "cloud": "gaia-prod",
    >       "region_name": "RegionOne",
    >       "zone": null,
    >       "project": {
    >         "id": "21b4ae3a2ea44bc5a9c14005ed2963af",
    >         "name": null,
    >         "domain_id": null,
    >         "domain_name": null
    >       }
    >     },
    >     "mac_address": "fa:16:3e:d6:98:2b",
    >     "name": "",
    >     "network_id": "423a1e6d-6ec2-41b4-970b-85f39a795c0f",
    >     "port_security_enabled": false,
    >     "project_id": "21b4ae3a2ea44bc5a9c14005ed2963af",
    >     "propagate_uplink_status": null,
    >     "qos_network_policy_id": null,
    >     "qos_policy_id": null,
    >     "resource_request": null,
    >     "revision_number": 3,
    >     "security_group_ids": [],
    >     "status": "ACTIVE",
    >     "tags": [],
    >     "trunk_details": null,
    >     "updated_at": "2020-06-23T11:09:57Z"
    >   }
    >   ---- ----
    >   Port [8a0f9cff-30c6-49d4-81f6-cb479d6cc6f4]
    >   {
    >     "admin_state_up": true,
    >     "allowed_address_pairs": [],
    >     "binding_host_id": null,
    >     "binding_profile": null,
    >     "binding_vif_details": null,
    >     "binding_vif_type": null,
    >     "binding_vnic_type": "normal",
    >     "created_at": "2020-06-23T11:09:51Z",
    >     "data_plane_status": null,
    >     "description": "",
    >     "device_id": "dhcp0a3448f8-9bce-56c9-a82c-5d5b4b54ed62-423a1e6d-6ec2-41b4-970b-85f39a795c0f",
    >     "device_owner": "network:dhcp",
    >     "dns_assignment": [
    >       {
    >         "hostname": "host-10-0-0-2",
    >         "ip_address": "10.0.0.2",
    >         "fqdn": "host-10-0-0-2.iris.cumulus.local."
    >       }
    >     ],
    >     "dns_domain": null,
    >     "dns_name": "",
    >     "extra_dhcp_opts": [],
    >     "fixed_ips": [
    >       {
    >         "subnet_id": "f5b9c9f4-e9c4-491b-9828-1bf336c684ae",
    >         "ip_address": "10.0.0.2"
    >       }
    >     ],
    >     "id": "8a0f9cff-30c6-49d4-81f6-cb479d6cc6f4",
    >     "ip_allocation": null,
    >     "location": {
    >       "cloud": "gaia-prod",
    >       "region_name": "RegionOne",
    >       "zone": null,
    >       "project": {
    >         "id": "21b4ae3a2ea44bc5a9c14005ed2963af",
    >         "name": null,
    >         "domain_id": null,
    >         "domain_name": null
    >       }
    >     },
    >     "mac_address": "fa:16:3e:4c:89:4a",
    >     "name": "",
    >     "network_id": "423a1e6d-6ec2-41b4-970b-85f39a795c0f",
    >     "port_security_enabled": false,
    >     "project_id": "21b4ae3a2ea44bc5a9c14005ed2963af",
    >     "propagate_uplink_status": null,
    >     "qos_network_policy_id": null,
    >     "qos_policy_id": null,
    >     "resource_request": null,
    >     "revision_number": 3,
    >     "security_group_ids": [],
    >     "status": "ACTIVE",
    >     "tags": [],
    >     "trunk_details": null,
    >     "updated_at": "2020-06-23T11:09:56Z"
    >   }

    #
    # One of the ports related to HA router.
    #

    >     ....
    >     "device_id": "682d9323-4741-4aca-ae18-4a2a5179fb3f",
    >     "device_owner": "network:ha_router_replicated_interface",
    >     ....

    #
    # Two of the ports related to DHCP services.
    #

    >     ....
    >     "device_id": "dhcp37607fa3-c23c-5a22-ae91-c92033d7849e-423a1e6d-6ec2-41b4-970b-85f39a795c0f",
    >     "device_owner": "network:dhcp",
    >     ....
    >     "device_id": "dhcp0a3448f8-9bce-56c9-a82c-5d5b4b54ed62-423a1e6d-6ec2-41b4-970b-85f39a795c0f",
    >     "device_owner": "network:dhcp",
    >     ....


# -----------------------------------------------------
# Try deleting the port _not_ linked to the DHCP service.
#[user@openstacker]

    for portid in $(
        openstack \
            --os-cloud "${cloudname:?}" \
            port list \
                --format json \
        | jq -r '.[] | .ID'
        )
        do
            echo "---- ----"
            echo "Port  [${portid:?}]"
            portowner=$(
                openstack \
                    --os-cloud "${cloudname:?}" \
                    port show \
                        --format json \
                        "${portid:?}" \
                | jq -r '.device_owner'
                )
            echo "Owner [${portowner:?}]"
        done

    >   ---- ----
    >   Port  [5ca16445-58a5-48c6-b737-684df3da905a]
    >   Owner [network:ha_router_replicated_interface]
    >   ---- ----
    >   Port  [701cfe36-a5f5-4374-a438-cb638e931866]
    >   Owner [network:dhcp]
    >   ---- ----
    >   Port  [8a0f9cff-30c6-49d4-81f6-cb479d6cc6f4]
    >   Owner [network:dhcp]


    for portid in $(
        openstack \
            --os-cloud "${cloudname:?}" \
            port list \
                --format json \
        | jq -r '.[] | .ID'
        )
        do
            echo "---- ----"
            echo "Port  [${portid:?}]"
            portowner=$(
                openstack \
                    --os-cloud "${cloudname:?}" \
                    port show \
                        --format json \
                        "${portid:?}" \
                | jq -r '.device_owner'
                )
            echo "Owner [${portowner:?}]"
            if [ "${portowner:?}" != 'network:dhcp' ]
                then
                    echo "Match found [${portid:?}][${portowner:?}]"
                    openstack \
                        --os-cloud "${cloudname:?}" \
                        port delete \
                            "${portid:?}"

                fi
        done

    >   ---- ----
    >   Port  [5ca16445-58a5-48c6-b737-684df3da905a]
    >   Owner [network:ha_router_replicated_interface]
    >   Match found [5ca16445-58a5-48c6-b737-684df3da905a][network:ha_router_replicated_interface]
    >   Failed to delete port with name or ID '5ca16445-58a5-48c6-b737-684df3da905a': ConflictException: 409: Client Error for url: https://cumulus.openstack.hpc.cam.ac.uk:9696/v2.0/ports/5ca16445-58a5-48c6-b737-684df3da905a, Port 5ca16445-58a5-48c6-b737-684df3da905a cannot be deleted directly via the port API: has device owner network:ha_router_replicated_interface.
    >   1 of 1 ports failed to delete.
    >   ---- ----
    >   Port  [701cfe36-a5f5-4374-a438-cb638e931866]
    >   Owner [network:dhcp]
    >   ---- ----
    >   Port  [8a0f9cff-30c6-49d4-81f6-cb479d6cc6f4]
    >   Owner [network:dhcp]


    #
    # Can't delete the router, because it has ports.
    #

    >   ....
    >   Failed to delete router with name or ID '682d9323-4741-4aca-ae18-4a2a5179fb3f':
    >       ConflictException: 409: Client Error for url: https://cumulus.openstack.hpc.cam.ac.uk:9696/v2.0/routers/682d9323-4741-4aca-ae18-4a2a5179fb3f
    >           Router 682d9323-4741-4aca-ae18-4a2a5179fb3f still has ports
    >   ....

    #
    # Can't delete the port, because it is being used
    #

    >   ....
    >   Failed to delete port with name or ID '5ca16445-58a5-48c6-b737-684df3da905a':
    >       ConflictException: 409: Client Error for url: https://cumulus.openstack.hpc.cam.ac.uk:9696/v2.0/ports/5ca16445-58a5-48c6-b737-684df3da905a
    >           Port 5ca16445-58a5-48c6-b737-684df3da905a cannot be deleted directly via the port API: has device owner network:ha_router_replicated_interface.
    >   ....


# -----------------------------------------------------
# Try ....
#[user@openstacker]

    for routerid in $(
        openstack \
            --os-cloud "${cloudname:?}" \
            router list \
                --format json \
        | jq -r '.[] | .ID'
        )
        do
            echo "---- ----"
            echo "Router [${routerid:?}]"

            for portid in $(
                openstack \
                    --os-cloud "${cloudname:?}" \
                    port list \
                         --device-id "${routerid:?}" \
                        --format json \
                | jq -r '.[] | .ID'
                )
                do
                    echo "Port   [${portid:?}]"
                    openstack \
                        --os-cloud "${cloudname:?}" \
                        router remove port \
                            "${routerid:?}" \
                            "${portid:?}"
                done
        done


    >   ---- ----
    >   Router [682d9323-4741-4aca-ae18-4a2a5179fb3f]
    >   Port   [5ca16445-58a5-48c6-b737-684df3da905a]
    >       ConflictException: 409: Client Error for url: https://cumulus.openstack.hpc.cam.ac.uk:9696/v2.0/routers/682d9323-4741-4aca-ae18-4a2a5179fb3f/remove_router_interface,
    >       Router interface for subnet f5b9c9f4-e9c4-491b-9828-1bf336c684ae on router 682d9323-4741-4aca-ae18-4a2a5179fb3f cannot be deleted, as it is required by one or more routes.


# -----------------------------------------------------
# Try ....
#[user@openstacker]

    subnetid=f5b9c9f4-e9c4-491b-9828-1bf336c684ae

    openstack \
        --os-cloud "${cloudname:?}" \
        subnet delete \
            "${subnetid:?}"

    >   Failed to delete subnet with name or ID 'f5b9c9f4-e9c4-491b-9828-1bf336c684ae':
    >       ConflictException: 409: Client Error for url: https://cumulus.openstack.hpc.cam.ac.uk:9696/v2.0/subnets/f5b9c9f4-e9c4-491b-9828-1bf336c684ae,
    >           Unable to complete operation on subnet f5b9c9f4-e9c4-491b-9828-1bf336c684ae:
    >               One or more ports have an IP allocation from this subnet.
    >   1 of 1 subnets failed to delete.


    routerid=682d9323-4741-4aca-ae18-4a2a5179fb3f
    subnetid=f5b9c9f4-e9c4-491b-9828-1bf336c684ae

    openstack \
        --os-cloud "${cloudname:?}" \
        router remove subnet \
            "${routerid:?}" \
            "${subnetid:?}"


    >   ConflictException: 409: Client Error for url: https://cumulus.openstack.hpc.cam.ac.uk:9696/v2.0/routers/682d9323-4741-4aca-ae18-4a2a5179fb3f/remove_router_interface,
    >       Router interface for subnet f5b9c9f4-e9c4-491b-9828-1bf336c684ae on router 682d9323-4741-4aca-ae18-4a2a5179fb3f cannot be deleted, as it is required by one or more routes.


    openstack \
        --os-cloud "${cloudname:?}" \
        route delete \
            "${routerid:?}"


    >   Failed to delete router with name or ID '682d9323-4741-4aca-ae18-4a2a5179fb3f':
    >       ConflictException: 409: Client Error for url: https://cumulus.openstack.hpc.cam.ac.uk:9696/v2.0/routers/682d9323-4741-4aca-ae18-4a2a5179fb3f
    >           Router 682d9323-4741-4aca-ae18-4a2a5179fb3f still has ports
    >   1 of 1 routers failed to delete.

# -----------------------------------------------------
# Try ....
#[user@openstacker]

    portid=5ca16445-58a5-48c6-b737-684df3da905a
    routerid=682d9323-4741-4aca-ae18-4a2a5179fb3f
    subnetid=f5b9c9f4-e9c4-491b-9828-1bf336c684ae

    openstack \
        --os-cloud "${cloudname:?}" \
        router unset \
            --external-gateway \
            "${routerid:?}"

    openstack \
        --os-cloud "${cloudname:?}" \
        router show \
            --format json \
            "${routerid:?}"

    >   {
    >     "admin_state_up": true,
    >     "availability_zone_hints": [],
    >     "availability_zones": [
    >       "nova"
    >     ],
    >     "created_at": "2020-06-23T11:09:49Z",
    >     "description": "",
    >     "external_gateway_info": null,
    >     "flavor_id": null,
    >     "id": "682d9323-4741-4aca-ae18-4a2a5179fb3f",
    >     "interfaces_info": [
    >       {
    >         "port_id": "5ca16445-58a5-48c6-b737-684df3da905a",
    >         "ip_address": "10.0.0.1",
    >         "subnet_id": "f5b9c9f4-e9c4-491b-9828-1bf336c684ae"
    >       }
    >     ],
    >     "location": {
    >       "cloud": "gaia-prod",
    >       "region_name": "RegionOne",
    >       "zone": null,
    >       "project": {
    >         "id": "21b4ae3a2ea44bc5a9c14005ed2963af",
    >         "name": null,
    >         "domain_id": null,
    >         "domain_name": null
    >       }
    >     },
    >     "name": "my-test-lmck76anbakg-network-vr2ukas2ycen-extrouter-zijow7edgqfh",
    >     "project_id": "21b4ae3a2ea44bc5a9c14005ed2963af",
    >     "revision_number": 15,
    >     "routes": [
    >       {
    >         "nexthop": "10.0.0.137",
    >         "destination": "10.206.0.0/16"
    >       }
    >     ],
    >     "status": "ACTIVE",
    >     "tags": [],
    >     "updated_at": "2020-06-26T18:31:50Z"
    >   }


# -----------------------------------------------------
# Try ....
#[user@openstacker]

    portid=5ca16445-58a5-48c6-b737-684df3da905a
    routerid=682d9323-4741-4aca-ae18-4a2a5179fb3f
    subnetid=f5b9c9f4-e9c4-491b-9828-1bf336c684ae

    openstack \
        --os-cloud "${cloudname:?}" \
        router unset \
            --route 'destination=10.206.0.0/16,gateway=10.0.0.137' \
            "${routerid:?}"

    openstack \
        --os-cloud "${cloudname:?}" \
        router show \
            --format json \
            "${routerid:?}"

    >   {
    >     "admin_state_up": true,
    >     "availability_zone_hints": [],
    >     "availability_zones": [
    >       "nova"
    >     ],
    >     "created_at": "2020-06-23T11:09:49Z",
    >     "description": "",
    >     "external_gateway_info": null,
    >     "flavor_id": null,
    >     "id": "682d9323-4741-4aca-ae18-4a2a5179fb3f",
    >     "interfaces_info": [
    >       {
    >         "port_id": "5ca16445-58a5-48c6-b737-684df3da905a",
    >         "ip_address": "10.0.0.1",
    >         "subnet_id": "f5b9c9f4-e9c4-491b-9828-1bf336c684ae"
    >       }
    >     ],
    >     "location": {
    >       "cloud": "gaia-prod",
    >       "region_name": "RegionOne",
    >       "zone": null,
    >       "project": {
    >         "id": "21b4ae3a2ea44bc5a9c14005ed2963af",
    >         "name": null,
    >         "domain_id": null,
    >         "domain_name": null
    >       }
    >     },
    >     "name": "my-test-lmck76anbakg-network-vr2ukas2ycen-extrouter-zijow7edgqfh",
    >     "project_id": "21b4ae3a2ea44bc5a9c14005ed2963af",
    >     "revision_number": 16,
    >     "routes": [],
    >     "status": "ACTIVE",
    >     "tags": [],
    >     "updated_at": "2020-06-26T18:37:51Z"
    >   }


# -----------------------------------------------------
# Now try ....
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        router remove port \
            "${routerid:?}" \
            "${portid:?}"

    >   -


    openstack \
        --os-cloud "${cloudname:?}" \
        router delete \
            "${routerid:?}"

    >   -


    openstack \
        --os-cloud "${cloudname:?}" \
        router list

    >   -


# -----------------------------------------------------
# Check what is left ...
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        coe cluster list

    >   +--------------------------------------+---------+---------+------------+--------------+---------------+---------------+
    >   | uuid                                 | name    | keypair | node_count | master_count | status        | health_status |
    >   +--------------------------------------+---------+---------+------------+--------------+---------------+---------------+
    >   | ab708936-f205-4953-9ce0-50f9097fbecd | my-test | my-test |          1 |            1 | DELETE_FAILED | HEALTHY       |
    >   +--------------------------------------+---------+---------+------------+--------------+---------------+---------------+


    openstack \
        --os-cloud "${cloudname:?}" \
        stack list

    >   +--------------------------------------+----------------------+---------------+----------------------+----------------------+
    >   | ID                                   | Stack Name           | Stack Status  | Creation Time        | Updated Time         |
    >   +--------------------------------------+----------------------+---------------+----------------------+----------------------+
    >   | 33553b5b-7221-4898-8a3f-92c0c61da418 | my-test-lmck76anbakg | DELETE_FAILED | 2020-06-23T11:09:46Z | 2020-06-26T15:24:17Z |
    >   +--------------------------------------+----------------------+---------------+----------------------+----------------------+


    openstack \
        --os-cloud "${cloudname:?}" \
        server list

    >   -


    openstack \
        --os-cloud "${cloudname:?}" \
        volume list

    >   -


    openstack \
        --os-cloud "${cloudname:?}" \
        floating ip list

    >   -


    openstack \
        --os-cloud "${cloudname:?}" \
        loadbalancer list

    >   -


    openstack \
        --os-cloud "${cloudname:?}" \
        router list

    >   -


    openstack \
        --os-cloud "${cloudname:?}" \
        network list

    >   +--------------------------------------+------------------+----------------------------------------------------------------------------+
    >   | ID                                   | Name             | Subnets                                                                    |
    >   +--------------------------------------+------------------+----------------------------------------------------------------------------+
    >   | 423a1e6d-6ec2-41b4-970b-85f39a795c0f | private          | f5b9c9f4-e9c4-491b-9828-1bf336c684ae                                       |
    >   | a929e8db-1bf4-4a5f-a80c-fabd39d06a26 | internet         | 180dc961-c52f-461a-b241-8f7a30d022a5, 273123bb-70f6-4f51-a406-7fc4b446532d |
    >   | ecb791d5-1022-447a-a79c-8f38a0f5c990 | cumulus-internal | 01b76c7c-3c1a-4c5c-9a5a-14bcf6c0c290                                       |
    >   +--------------------------------------+------------------+----------------------------------------------------------------------------+


    openstack \
        --os-cloud "${cloudname:?}" \
        port list

    >   +--------------------------------------+------+-------------------+-------------------------------------------------------------------------+--------+
    >   | ID                                   | Name | MAC Address       | Fixed IP Addresses                                                      | Status |
    >   +--------------------------------------+------+-------------------+-------------------------------------------------------------------------+--------+
    >   | 701cfe36-a5f5-4374-a438-cb638e931866 |      | fa:16:3e:d6:98:2b | ip_address='10.0.0.3', subnet_id='f5b9c9f4-e9c4-491b-9828-1bf336c684ae' | ACTIVE |
    >   | 8a0f9cff-30c6-49d4-81f6-cb479d6cc6f4 |      | fa:16:3e:4c:89:4a | ip_address='10.0.0.2', subnet_id='f5b9c9f4-e9c4-491b-9828-1bf336c684ae' | ACTIVE |
    >   +--------------------------------------+------+-------------------+-------------------------------------------------------------------------+--------+


    openstack \
        --os-cloud "${cloudname:?}" \
        subnet list

    >   +--------------------------------------+-----------------------------------------------------------------------+--------------------------------------+---------------+
    >   | ID                                   | Name                                                                  | Network                              | Subnet        |
    >   +--------------------------------------+-----------------------------------------------------------------------+--------------------------------------+---------------+
    >   | 01b76c7c-3c1a-4c5c-9a5a-14bcf6c0c290 | cumulus-internal                                                      | ecb791d5-1022-447a-a79c-8f38a0f5c990 | 10.218.0.0/16 |
    >   | f5b9c9f4-e9c4-491b-9828-1bf336c684ae | my-test-lmck76anbakg-network-vr2ukas2ycen-private_subnet-ey45tlwqaadz | 423a1e6d-6ec2-41b4-970b-85f39a795c0f | 10.0.0.0/24   |
    >   +--------------------------------------+-----------------------------------------------------------------------+--------------------------------------+---------------+


# -----------------------------------------------------
# Try deleting the ports.
#[user@openstacker]

    for portid in $(
        openstack \
            --os-cloud "${cloudname:?}" \
            port list \
                --format json \
        | jq -r '.[] | .ID'
        )
        do
            echo "---- ----"
            echo "Port [${portid:?}]"
            openstack \
                --os-cloud "${cloudname:?}" \
                port delete \
                    "${portid:?}"
        done

    >   ---- ----
    >   Port [701cfe36-a5f5-4374-a438-cb638e931866]
    >   ---- ----
    >   Port [8a0f9cff-30c6-49d4-81f6-cb479d6cc6f4]

    # Yay :-)


    openstack \
        --os-cloud "${cloudname:?}" \
        port list

    >   +--------------------------------------+------+-------------------+-------------------------------------------------------------------------+--------+
    >   | ID                                   | Name | MAC Address       | Fixed IP Addresses                                                      | Status |
    >   +--------------------------------------+------+-------------------+-------------------------------------------------------------------------+--------+
    >   | 366a35fd-425e-4394-8639-371345559232 |      | fa:16:3e:ea:78:94 | ip_address='10.0.0.2', subnet_id='f5b9c9f4-e9c4-491b-9828-1bf336c684ae' | ACTIVE |
    >   | cb6dcaab-ffe3-4a0e-bf2d-57061782a194 |      | fa:16:3e:a2:47:9f | ip_address='10.0.0.3', subnet_id='f5b9c9f4-e9c4-491b-9828-1bf336c684ae' | ACTIVE |
    >   +--------------------------------------+------+-------------------+-------------------------------------------------------------------------+--------+

    # Waah :-(


# -----------------------------------------------------
# Try deleting the network.
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        network list

    >   +--------------------------------------+------------------+----------------------------------------------------------------------------+
    >   | ID                                   | Name             | Subnets                                                                    |
    >   +--------------------------------------+------------------+----------------------------------------------------------------------------+
    >   | 423a1e6d-6ec2-41b4-970b-85f39a795c0f | private          | f5b9c9f4-e9c4-491b-9828-1bf336c684ae                                       |
    >   | a929e8db-1bf4-4a5f-a80c-fabd39d06a26 | internet         | 180dc961-c52f-461a-b241-8f7a30d022a5, 273123bb-70f6-4f51-a406-7fc4b446532d |
    >   | ecb791d5-1022-447a-a79c-8f38a0f5c990 | cumulus-internal | 01b76c7c-3c1a-4c5c-9a5a-14bcf6c0c290                                       |
    >   +--------------------------------------+------------------+----------------------------------------------------------------------------+


    networkid=$(
        openstack \
            --os-cloud "${cloudname:?}" \
            network list \
                --format json \
        | jq -r '.[] | select(.Name == "private") | .ID'
        )

    openstack \
        --os-cloud "${cloudname:?}" \
        network delete \
            "${networkid:?}"

    >   -

    # Yay :-)


    openstack \
        --os-cloud "${cloudname:?}" \
        network list

    >   +--------------------------------------+------------------+----------------------------------------------------------------------------+
    >   | ID                                   | Name             | Subnets                                                                    |
    >   +--------------------------------------+------------------+----------------------------------------------------------------------------+
    >   | a929e8db-1bf4-4a5f-a80c-fabd39d06a26 | internet         | 180dc961-c52f-461a-b241-8f7a30d022a5, 273123bb-70f6-4f51-a406-7fc4b446532d |
    >   | ecb791d5-1022-447a-a79c-8f38a0f5c990 | cumulus-internal | 01b76c7c-3c1a-4c5c-9a5a-14bcf6c0c290                                       |
    >   +--------------------------------------+------------------+----------------------------------------------------------------------------+

    # Yay :-)


    openstack \
        --os-cloud "${cloudname:?}" \
        subnet list

    >   +--------------------------------------+------------------+--------------------------------------+---------------+
    >   | ID                                   | Name             | Network                              | Subnet        |
    >   +--------------------------------------+------------------+--------------------------------------+---------------+
    >   | 01b76c7c-3c1a-4c5c-9a5a-14bcf6c0c290 | cumulus-internal | ecb791d5-1022-447a-a79c-8f38a0f5c990 | 10.218.0.0/16 |
    >   +--------------------------------------+------------------+--------------------------------------+---------------+


    openstack \
        --os-cloud "${cloudname:?}" \
        port list

    >   -

    # Yay :-)



# -----------------------------------------------------
# Now try deleting the cluster ....
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        coe cluster list

    >   +--------------------------------------+---------+---------+------------+--------------+---------------+---------------+
    >   | uuid                                 | name    | keypair | node_count | master_count | status        | health_status |
    >   +--------------------------------------+---------+---------+------------+--------------+---------------+---------------+
    >   | ab708936-f205-4953-9ce0-50f9097fbecd | my-test | my-test |          1 |            1 | DELETE_FAILED | HEALTHY       |
    >   +--------------------------------------+---------+---------+------------+--------------+---------------+---------------+

    clusterid=$(
        openstack \
            --os-cloud "${cloudname:?}" \
            coe cluster list \
                --format json \
        | jq -r '.[] | .uuid'
        )

    openstack \
        --os-cloud "${cloudname:?}" \
        coe cluster delete \
            "${clusterid:?}"

    >   Request to delete cluster ab708936-f205-4953-9ce0-50f9097fbecd has been accepted.


    openstack \
        --os-cloud "${cloudname:?}" \
        coe cluster list

    >   -

    # Yay :-)


# -----------------------------------------------------
# Check what is left ...
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        coe cluster list

    >   -


    openstack \
        --os-cloud "${cloudname:?}" \
        stack list

    >   -


    openstack \
        --os-cloud "${cloudname:?}" \
        server list

    >   -


    openstack \
        --os-cloud "${cloudname:?}" \
        volume list

    >   -


    openstack \
        --os-cloud "${cloudname:?}" \
        floating ip list

    >   -


    openstack \
        --os-cloud "${cloudname:?}" \
        loadbalancer list

    >   -


    openstack \
        --os-cloud "${cloudname:?}" \
        router list

    >   -


    openstack \
        --os-cloud "${cloudname:?}" \
        port list

    >   -


    openstack \
        --os-cloud "${cloudname:?}" \
        subnet list

    >   +--------------------------------------+------------------+--------------------------------------+---------------+
    >   | ID                                   | Name             | Network                              | Subnet        |
    >   +--------------------------------------+------------------+--------------------------------------+---------------+
    >   | 01b76c7c-3c1a-4c5c-9a5a-14bcf6c0c290 | cumulus-internal | ecb791d5-1022-447a-a79c-8f38a0f5c990 | 10.218.0.0/16 |
    >   +--------------------------------------+------------------+--------------------------------------+---------------+


    openstack \
        --os-cloud "${cloudname:?}" \
        network list

    >   +--------------------------------------+------------------+----------------------------------------------------------------------------+
    >   | ID                                   | Name             | Subnets                                                                    |
    >   +--------------------------------------+------------------+----------------------------------------------------------------------------+
    >   | a929e8db-1bf4-4a5f-a80c-fabd39d06a26 | internet         | 180dc961-c52f-461a-b241-8f7a30d022a5, 273123bb-70f6-4f51-a406-7fc4b446532d |
    >   | ecb791d5-1022-447a-a79c-8f38a0f5c990 | cumulus-internal | 01b76c7c-3c1a-4c5c-9a5a-14bcf6c0c290                                       |
    >   +--------------------------------------+------------------+----------------------------------------------------------------------------+



