#
# <meta:header>
#   <meta:licence>
#     Copyright (c) 2020, ROE (http://www.roe.ac.uk/)
#
#     This information is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This information is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
#   </meta:licence>
# </meta:header>
#
#

    #
    # Our Terraform cluster is stuck - so we need to delete everything manually.
    # Turns out not everything we found was due to the Terraform cluster.
    # This ended up being a general delete and tidy ...
    #

# -----------------------------------------------------
# Just check it is still broken.
#[user@openstacker]

    terraform plan

    >   Refreshing Terraform state in-memory prior to plan...
    >   The refreshed state will be used to calculate this plan, but will not be
    >   persisted to local or remote state storage.
    >   
    >   module.cluster.openstack_compute_keypair_v2.keypair: Refreshing state... [id=my-test]
    >   module.cluster.data.openstack_containerinfra_clustertemplate_v1.clustertemplate: Refreshing state...
    >   module.cluster.openstack_containerinfra_cluster_v1.cluster: Refreshing state... [id=492e28e5-2b54-4450-95c9-f66f921d3e3b]
    >   
    >   Error: Error retrieving openstack_containerinfra_cluster_v1 492e28e5-2b54-4450-95c9-f66f921d3e3b: json: cannot unmarshal object into Go struct field Cluster.health_status_reason of type string


# -----------------------------------------------------
# List our clusters.
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        coe cluster list

    >   +--------------------------------------+----------+------------------+------------+--------------+-----------------+
    >   | uuid                                 | name     | keypair          | node_count | master_count | status          |
    >   +--------------------------------------+----------+------------------+------------+--------------+-----------------+
    >   | f5632b7e-87bd-46d6-820f-a20f1b66b6c8 | Augustus | zrq-gaia-keypair |          4 |            2 | CREATE_COMPLETE |
    >   | 492e28e5-2b54-4450-95c9-f66f921d3e3b | my-test  | my-test          |          1 |            1 | CREATE_COMPLETE |
    >   +--------------------------------------+----------+------------------+------------+--------------+-----------------+


# -----------------------------------------------------
# Show details for the Terraform cluster.
#[user@openstacker]

    clusterid=$(
        openstack \
        --os-cloud "${cloudname:?}" \
            coe cluster list \
                --format json \
        | jq -r '.[1] | .uuid'
        )


    openstack \
        --os-cloud "${cloudname:?}" \
        coe cluster \
            show \
            "${clusterid}"

    >   +---------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    >   | Field               | Value                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
    >   +---------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    >   | status              | CREATE_COMPLETE                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
    >   | cluster_template_id | d54167d9-495f-437e-88fe-d182b2a230ea                                                                                                                                                                                                                                                                                                                                                                                                                                     |
    >   | node_addresses      | ['10.0.0.105']                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
    >   | uuid                | 492e28e5-2b54-4450-95c9-f66f921d3e3b                                                                                                                                                                                                                                                                                                                                                                                                                                     |
    >   | stack_id            | a45bbe9a-088a-4ab1-8260-95f088c4f116                                                                                                                                                                                                                                                                                                                                                                                                                                     |
    >   | status_reason       | None                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
    >   | created_at          | 2020-06-10T17:35:43+00:00                                                                                                                                                                                                                                                                                                                                                                                                                                                |
    >   | updated_at          | 2020-06-10T17:41:40+00:00                                                                                                                                                                                                                                                                                                                                                                                                                                                |
    >   | coe_version         | v1.15.9                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
    >   | labels              | {'auto_healing_controller': 'magnum-auto-healer', 'max_node_count': '2', 'cloud_provider_tag': 'v1.15.0', 'etcd_tag': '3.3.17', 'monitoring_enabled': 'true', 'tiller_enabled': 'true', 'autoscaler_tag': 'v1.15.2', 'master_lb_floating_ip_enabled': 'true', 'min_node_count': '1', 'tiller_tag': 'v2.16.1', 'use_podman': 'true', 'auto_healing_enabled': 'true', 'heat_container_agent_tag': 'train-stable-1', 'kube_tag': 'v1.15.9', 'auto_scaling_enabled': 'true'} |
    >   | faults              |                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
    >   | keypair             | my-test                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
    >   | api_address         | https://128.232.227.226:6443                                                                                                                                                                                                                                                                                                                                                                                                                                             |
    >   | master_addresses    | ['10.0.0.193']                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
    >   | create_timeout      | None                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
    >   | node_count          | 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
    >   | discovery_url       | https://discovery.etcd.io/86fae31d722a068d13aaa444487f8562                                                                                                                                                                                                                                                                                                                                                                                                               |
    >   | master_count        | 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
    >   | container_version   | 1.12.6                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
    >   | name                | my-test                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
    >   | master_flavor_id    | general.v1.tiny                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
    >   | flavor_id           | general.v1.tiny                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
    >   +---------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+


# -----------------------------------------------------
# Delete the Terraform cluster.
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        coe cluster \
            delete \
            "${clusterid}"

    >   Request to delete cluster 492e28e5-2b54-4450-95c9-f66f921d3e3b has been accepted.


    openstack \
        --os-cloud "${cloudname:?}" \
        coe cluster list

    >   +--------------------------------------+----------+------------------+------------+--------------+--------------------+
    >   | uuid                                 | name     | keypair          | node_count | master_count | status             |
    >   +--------------------------------------+----------+------------------+------------+--------------+--------------------+
    >   | f5632b7e-87bd-46d6-820f-a20f1b66b6c8 | Augustus | zrq-gaia-keypair |          4 |            2 | CREATE_COMPLETE    |
    >   | 492e28e5-2b54-4450-95c9-f66f921d3e3b | my-test  | my-test          |          1 |            1 | DELETE_IN_PROGRESS |
    >   +--------------------------------------+----------+------------------+------------+--------------+--------------------+

    >   +--------------------------------------+----------+------------------+------------+--------------+-----------------+
    >   | uuid                                 | name     | keypair          | node_count | master_count | status          |
    >   +--------------------------------------+----------+------------------+------------+--------------+-----------------+
    >   | f5632b7e-87bd-46d6-820f-a20f1b66b6c8 | Augustus | zrq-gaia-keypair |          4 |            2 | CREATE_COMPLETE |
    >   +--------------------------------------+----------+------------------+------------+--------------+-----------------+


# -----------------------------------------------------
# List our resources.
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        server list

    >   +--------------------------------------+--------------------------------+--------+--------------------+-------------------------+------------------+
    >   | ID                                   | Name                           | Status | Networks           | Image                   | Flavor           |
    >   +--------------------------------------+--------------------------------+--------+--------------------+-------------------------+------------------+
    >   | 3d2d264c-6be5-4a6b-8fce-64d4659c0399 | augustus-kesse63tp4vo-node-0   | ACTIVE | private=10.0.0.217 | FedoraAtomic29-20191126 | general.v1.small |
    >   | 6dfea60b-4e70-4f53-b4fd-8e1cbbc9c3a5 | augustus-kesse63tp4vo-node-2   | ACTIVE | private=10.0.0.80  | FedoraAtomic29-20191126 | general.v1.small |
    >   | 2bb28081-70f4-4614-95b1-b062e4927da5 | augustus-kesse63tp4vo-node-1   | ACTIVE | private=10.0.0.114 | FedoraAtomic29-20191126 | general.v1.small |
    >   | 78112f6c-3b65-4270-b5f1-85122b5a7778 | augustus-kesse63tp4vo-node-3   | ACTIVE | private=10.0.0.142 | FedoraAtomic29-20191126 | general.v1.small |
    >   | e8c68499-a62f-4c15-9705-6fbdbe6a2c15 | augustus-kesse63tp4vo-master-0 | ACTIVE | private=10.0.0.145 | FedoraAtomic29-20191126 | general.v1.small |
    >   | ec2ee864-a859-4f68-8ff8-46a63dfa9861 | augustus-kesse63tp4vo-master-1 | ACTIVE | private=10.0.0.117 | FedoraAtomic29-20191126 | general.v1.small |
    >   +--------------------------------------+--------------------------------+--------+--------------------+-------------------------+------------------+


    openstack \
        --os-cloud "${cloudname:?}" \
        network list

    >   +--------------------------------------+----------------------------------+----------------------------------------------------------------------------+
    >   | ID                                   | Name                             | Subnets                                                                    |
    >   +--------------------------------------+----------------------------------+----------------------------------------------------------------------------+
    >   | 3b5b64f0-81db-4698-b34d-dfbe2aa4dfb8 | aglais-20200417-internal-network | c5f70b36-58b1-4ed5-9f2c-c9f1ec632c78                                       |
    >   | a929e8db-1bf4-4a5f-a80c-fabd39d06a26 | internet                         | 180dc961-c52f-461a-b241-8f7a30d022a5, 273123bb-70f6-4f51-a406-7fc4b446532d |
    >   | c0b551b6-d17e-44e0-b739-77c296a93c70 | private                          | 4c48086c-5c1a-4930-9601-0ad22ffec8e7                                       |
    >   | ecb791d5-1022-447a-a79c-8f38a0f5c990 | cumulus-internal                 | 01b76c7c-3c1a-4c5c-9a5a-14bcf6c0c290                                       |
    >   +--------------------------------------+----------------------------------+----------------------------------------------------------------------------+

    #
    # Checking on the Horizon GUI
    # The 'private' network is part of the 'augustus' cluster.
    # The 'aglais-20200417' network is not connected to anything.
    #


    openstack \
        --os-cloud "${cloudname:?}" \
        router list

    >   +--------------------------------------+-------------------------------------------------------------------+--------+-------+----------------------------------+
    >   | ID                                   | Name                                                              | Status | State | Project                          |
    >   +--------------------------------------+-------------------------------------------------------------------+--------+-------+----------------------------------+
    >   | 25a920fe-15ba-48e6-a5d8-6f7d87bb8ae5 | aglais-20200417-internal-network-router                           | ACTIVE | UP    | 21b4ae3a2ea44bc5a9c14005ed2963af |
    >   | 2b0c8fdc-b991-4969-8b4f-961b290ad23c | augustus-kesse63tp4vo-network-atprwlu6pkxq-extrouter-6jc4o5in3npr | ACTIVE | UP    | 21b4ae3a2ea44bc5a9c14005ed2963af |
    >   +--------------------------------------+-------------------------------------------------------------------+--------+-------+----------------------------------+


# -----------------------------------------------------
# Delete our router.
#[user@openstacker]

    for routerid in $(
        openstack \
            --os-cloud "${cloudname:?}" \
            router list \
                --format json \
        | jq -r '.[] | select(.Name | test("^aglais")) | .ID'
        )
        do
            echo "Router [${routerid:?}]"
            openstack \
                --os-cloud "${cloudname:?}" \
                router delete \
                    "${routerid:?}"
        done

    >   Router [25a920fe-15ba-48e6-a5d8-6f7d87bb8ae5]
    >   Failed to delete router with name or ID '25a920fe-15ba-48e6-a5d8-6f7d87bb8ae5': ConflictException: 409: Client Error for url: https://cumulus.openstack.hpc.cam.ac.uk:9696/v2.0/routers/25a920fe-15ba-48e6-a5d8-6f7d87bb8ae5, Router 25a920fe-15ba-48e6-a5d8-6f7d87bb8ae5 still has ports
    >   1 of 1 routers failed to delete.


# -----------------------------------------------------
# Release ports linked to our router.
# Using code copied from tear-down.sh in Ansible branch.
#[user@openstacker]

    regex='^aglais'

    for routerid in $(
        openstack \
            --os-cloud "${cloudname:?}" \
            router list \
                --format json \
        | jq -r '.[] | select(.Name | test("'${regex:?}'")) | .ID'
        )
    do
        echo "Router [${routerid:?}]"

        for portid in $(
            openstack \
                --os-cloud "${cloudname:?}" \
                port list \
                    --router "${routerid:?}" \
                    --format json \
            | jq -r '.[] | .ID'
            )
        do
            echo "Port   [${portid:?}]"
            openstack \
                --os-cloud "${cloudname:?}" \
                router remove port \
                    "${routerid:?}" \
                    "${portid:?}"
        done
    done

    >   Router [25a920fe-15ba-48e6-a5d8-6f7d87bb8ae5]
    >   Port   [283f9a1f-4537-4879-947e-4171b260c402]


# -----------------------------------------------------
# Delete our router.
#[user@openstacker]

    for routerid in $(
        openstack \
            --os-cloud "${cloudname:?}" \
            router list \
                --format json \
        | jq -r '.[] | select(.Name | test("'${regex:?}'")) | .ID'
        )
    do
        echo "Router [${routerid:?}]"
        openstack \
            --os-cloud "${cloudname:?}" \
            router delete \
                "${routerid:?}"
    done

    >   Router [25a920fe-15ba-48e6-a5d8-6f7d87bb8ae5]


# -----------------------------------------------------
# Delete our network.
#[user@openstacker]

    for networkid in $(
        openstack \
            --os-cloud "${cloudname:?}" \
            network list \
                --format json \
        | jq -r '.[] | select(.Name | test("'${regex:?}'")) | .ID'
        )
    do
        echo "Network [${networkid:?}]"
        openstack \
            --os-cloud "${cloudname:?}" \
            network delete \
                "${networkid:?}"
    done

    >   Network [3b5b64f0-81db-4698-b34d-dfbe2aa4dfb8]

# -----------------------------------------------------
# Delete our security groups.
#[user@openstacker]

    for groupid in $(
        openstack \
            --os-cloud "${cloudname:?}" \
            security group list \
                --format json \
        | jq -r '.[] | select(.Name | test("'${regex:?}'")) | .ID'
        )
    do
        echo "Group [${groupid:?}]"
        openstack \
            --os-cloud "${cloudname:?}" \
            security group delete \
                "${groupid:?}"
    done

    >   Group [56b13ce8-9969-4aa0-b80e-5ec615df5c2c]
    >   Group [a06c5efb-88c1-49a9-a4fe-663ad056d875]
    >   Group [afd1e589-30bd-4a79-b2e5-a0bdedbe404a]

# -----------------------------------------------------
# List the floating IP addresses.
#[user@openstacker]

    # Floating IP addresses don't have a name prefix to select them with.
    # One of the floating IP addresses has a reference to a server that no longer exists.

    openstack \
        --os-cloud "${cloudname:?}" \
        floating ip list

    >   +--------------------------------------+---------------------+------------------+--------------------------------------+--------------------------------------+----------------------------------+
    >   | ID                                   | Floating IP Address | Fixed IP Address | Port                                 | Floating Network                     | Project                          |
    >   +--------------------------------------+---------------------+------------------+--------------------------------------+--------------------------------------+----------------------------------+
    >   | acdb3fd1-8aca-469b-b1cb-2e68bb49edbb | 128.232.227.145     | None             | None                                 | a929e8db-1bf4-4a5f-a80c-fabd39d06a26 | 21b4ae3a2ea44bc5a9c14005ed2963af |
    >   | cdda57ab-4aee-4011-899f-2108c0142e60 | 128.232.227.236     | 10.0.0.106       | 8cf6bf1f-637e-40f2-9a53-51d77ae4c700 | a929e8db-1bf4-4a5f-a80c-fabd39d06a26 | 21b4ae3a2ea44bc5a9c14005ed2963af |
    >   +--------------------------------------+---------------------+------------------+--------------------------------------+--------------------------------------+----------------------------------+


    openstack \
        --os-cloud "${cloudname:?}" \
        port list

    >   +--------------------------------------+----------------------------------------------------------------------------------------------+-------------------+--------------------------------------------------------------------------------+--------+
    >   | ID                                   | Name                                                                                         | MAC Address       | Fixed IP Addresses                                                             | Status |
    >   +--------------------------------------+----------------------------------------------------------------------------------------------+-------------------+--------------------------------------------------------------------------------+--------+
    >   | 21ed4be7-ed50-4d9a-9b6a-c7150aa81c3c | augustus-kesse63tp4vo-kube_minions-xzit7xmx63yp-0-rfyzsjhvxzqz-kube_minion_eth0-663npz6jxxto | fa:16:3e:40:1d:58 | ip_address='10.0.0.217', subnet_id='4c48086c-5c1a-4930-9601-0ad22ffec8e7'      | ACTIVE |
    >   | 25bb66fa-b080-479a-ab74-97194a0a1e5e |                                                                                              | fa:16:3e:98:a1:ad | ip_address='10.0.0.3', subnet_id='4c48086c-5c1a-4930-9601-0ad22ffec8e7'        | ACTIVE |
    >   | 279ff023-43e4-4021-8a2c-970ab08412e0 | augustus-kesse63tp4vo-kube_minions-xzit7xmx63yp-2-khoum6mnbbvj-kube_minion_eth0-iz3me2zvfcfq | fa:16:3e:b9:4c:a0 | ip_address='10.0.0.80', subnet_id='4c48086c-5c1a-4930-9601-0ad22ffec8e7'       | ACTIVE |
    >   | 2831a248-3a2e-41fe-99d9-77ff091f0d60 |                                                                                              | fa:16:3e:4d:1d:ec | ip_address='10.0.0.2', subnet_id='4c48086c-5c1a-4930-9601-0ad22ffec8e7'        | ACTIVE |
    >   | 3a216056-95b0-463f-a9d2-fb24b1d72c6e | octavia-lb-vrrp-7439d1f6-9305-4aea-a81a-b60ac5abd49f                                         | fa:16:3e:81:3c:8c | ip_address='10.0.0.31', subnet_id='4c48086c-5c1a-4930-9601-0ad22ffec8e7'       | ACTIVE |
    >   | 709d1335-0e07-4478-83ce-6e1cf1167027 | octavia-lb-57f5400f-b252-439f-87ef-59e57f73e31d                                              | fa:16:3e:b0:da:29 | ip_address='10.0.0.135', subnet_id='4c48086c-5c1a-4930-9601-0ad22ffec8e7'      | DOWN   |
    >   | 8cf6bf1f-637e-40f2-9a53-51d77ae4c700 | octavia-lb-5a868203-a8c9-4398-8c73-ad9177a248cd                                              | fa:16:3e:62:57:0e | ip_address='10.0.0.106', subnet_id='4c48086c-5c1a-4930-9601-0ad22ffec8e7'      | DOWN   |
    >   | 9a4a2e48-b10d-4b19-b198-0b401377ae03 | augustus-kesse63tp4vo-kube_minions-xzit7xmx63yp-1-i3uyrqodfg4e-kube_minion_eth0-uzg7aueqkaaf | fa:16:3e:77:ee:67 | ip_address='10.0.0.114', subnet_id='4c48086c-5c1a-4930-9601-0ad22ffec8e7'      | ACTIVE |
    >   | a2036745-fabd-49bc-86d9-a9c12a7fbac5 | augustus-kesse63tp4vo-kube_minions-xzit7xmx63yp-3-ripihhmfwfom-kube_minion_eth0-bcptgrkkqgnf | fa:16:3e:69:48:6f | ip_address='10.0.0.142', subnet_id='4c48086c-5c1a-4930-9601-0ad22ffec8e7'      | ACTIVE |
    >   | a50678c8-b352-4bde-9d33-42268600bb73 | augustus-kesse63tp4vo-kube_masters-tuqkuwdgo3td-1-s5mipm7ikarn-kube_master_eth0-ydi6f64hxbc2 | fa:16:3e:86:bb:7c | ip_address='10.0.0.117', subnet_id='4c48086c-5c1a-4930-9601-0ad22ffec8e7'      | ACTIVE |
    >   | ae97abe7-8326-40a1-b0f0-1f8d96eadc8a |                                                                                              | fa:16:3e:b3:94:99 | ip_address='10.0.0.1', subnet_id='4c48086c-5c1a-4930-9601-0ad22ffec8e7'        | ACTIVE |
    >   | c5544fef-e27a-4ed3-8864-9b8713a50883 |                                                                                              | fa:16:3e:70:97:10 | ip_address='128.232.227.236', subnet_id='273123bb-70f6-4f51-a406-7fc4b446532d' | N/A    |
    >   | d1132701-ef1a-40c8-b798-4a3e7a1e0d6b | augustus-kesse63tp4vo-kube_masters-tuqkuwdgo3td-0-rt6bjkywpq3z-kube_master_eth0-633s2prpav2h | fa:16:3e:5e:57:36 | ip_address='10.0.0.145', subnet_id='4c48086c-5c1a-4930-9601-0ad22ffec8e7'      | ACTIVE |
    >   | f34afbc7-9621-4c5b-803f-607934c76404 | octavia-lb-vrrp-4e6c61bc-efb2-4ded-8538-866d2830c597                                         | fa:16:3e:4e:48:85 | ip_address='10.0.0.196', subnet_id='4c48086c-5c1a-4930-9601-0ad22ffec8e7'      | ACTIVE |
    >   +--------------------------------------+----------------------------------------------------------------------------------------------+-------------------+--------------------------------------------------------------------------------+--------+

    # DANGER WILL ROBINSON !!

    #
    # One of the floating IP addresses is not linked to anything.
    # .. which is the one we want to delete.
    #

    openstack \
        --os-cloud "${cloudname:?}" \
        floating ip list \
            --format json \
    | jq -r '.[] | select(.Port == null)'


    >   {
    >     "ID": "acdb3fd1-8aca-469b-b1cb-2e68bb49edbb",
    >     "Floating IP Address": "128.232.227.145",
    >     "Fixed IP Address": null,
    >     "Port": null,
    >     "Floating Network": "a929e8db-1bf4-4a5f-a80c-fabd39d06a26",
    >     "Project": "21b4ae3a2ea44bc5a9c14005ed2963af"
    >   }

    #
    # The other floating IP address is linked to an active port connected to the Octavia load balancer.
    # https://docs.openstack.org/octavia/latest/
    #

    openstack \
        --os-cloud "${cloudname:?}" \
        floating ip list \
            --format json \
    | jq -r '.[] | select(.Port != null)'

    >   {
    >     "ID": "cdda57ab-4aee-4011-899f-2108c0142e60",
    >     "Floating IP Address": "128.232.227.236",
    >     "Fixed IP Address": "10.0.0.106",
    >     "Port": "8cf6bf1f-637e-40f2-9a53-51d77ae4c700",
    >     "Floating Network": "a929e8db-1bf4-4a5f-a80c-fabd39d06a26",
    >     "Project": "21b4ae3a2ea44bc5a9c14005ed2963af"
    >   }

    portid=$(
        openstack \
            --os-cloud "${cloudname:?}" \
            floating ip list \
                --format json \
        | jq -r '.[] | select(.Port != null) | .Port'
        )

    openstack \
        --os-cloud "${cloudname:?}" \
        port show \
            "${portid:?}"

    >   +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    >   | Field                   | Value                                                                                                                                                                                       |
    >   +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    >   | admin_state_up          | DOWN                                                                                                                                                                                        |
    >   | allowed_address_pairs   |                                                                                                                                                                                             |
    >   | binding_host_id         | None                                                                                                                                                                                        |
    >   | binding_profile         | None                                                                                                                                                                                        |
    >   | binding_vif_details     | None                                                                                                                                                                                        |
    >   | binding_vif_type        | None                                                                                                                                                                                        |
    >   | binding_vnic_type       | normal                                                                                                                                                                                      |
    >   | created_at              | 2020-06-10T13:14:49Z                                                                                                                                                                        |
    >   | data_plane_status       | None                                                                                                                                                                                        |
    >   | description             |                                                                                                                                                                                             |
    >   | device_id               | lb-5a868203-a8c9-4398-8c73-ad9177a248cd                                                                                                                                                     |
    >   | device_owner            | Octavia                                                                                                                                                                                     |
    >   | dns_assignment          | fqdn='host-10-0-0-106.iris.cumulus.local.', hostname='host-10-0-0-106', ip_address='10.0.0.106'                                                                                             |
    >   | dns_domain              | None                                                                                                                                                                                        |
    >   | dns_name                |                                                                                                                                                                                             |
    >   | extra_dhcp_opts         |                                                                                                                                                                                             |
    >   | fixed_ips               | ip_address='10.0.0.106', subnet_id='4c48086c-5c1a-4930-9601-0ad22ffec8e7'                                                                                                                   |
    >   | id                      | 8cf6bf1f-637e-40f2-9a53-51d77ae4c700                                                                                                                                                        |
    >   | location                | Munch({'cloud': 'gaia-prod', 'region_name': 'RegionOne', 'zone': None, 'project': Munch({'id': '21b4ae3a2ea44bc5a9c14005ed2963af', 'name': None, 'domain_id': None, 'domain_name': None})}) |
    >   | mac_address             | fa:16:3e:62:57:0e                                                                                                                                                                           |
    >   | name                    | octavia-lb-5a868203-a8c9-4398-8c73-ad9177a248cd                                                                                                                                             |
    >   | network_id              | c0b551b6-d17e-44e0-b739-77c296a93c70                                                                                                                                                        |
    >   | port_security_enabled   | False                                                                                                                                                                                       |
    >   | project_id              | 21b4ae3a2ea44bc5a9c14005ed2963af                                                                                                                                                            |
    >   | propagate_uplink_status | None                                                                                                                                                                                        |
    >   | qos_policy_id           | None                                                                                                                                                                                        |
    >   | resource_request        | None                                                                                                                                                                                        |
    >   | revision_number         | 2                                                                                                                                                                                           |
    >   | security_group_ids      | 99049d9f-925c-427a-af8d-f36c2e72d34d                                                                                                                                                        |
    >   | status                  | DOWN                                                                                                                                                                                        |
    >   | tags                    |                                                                                                                                                                                             |
    >   | trunk_details           | None                                                                                                                                                                                        |
    >   | updated_at              | 2020-06-10T13:14:51Z                                                                                                                                                                        |
    >   +-------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

    # The danger is that the Horizon GUI doesn't understand this.
    # It uses the device_id to make a link to a server that doesn't exist.

    device_id = lb-5a868203-a8c9-4398-8c73-ad9177a248cd                                                                                                                                                     |

    https://cumulus.openstack.hpc.cam.ac.uk/project/instances/lb-5a868203-a8c9-4398-8c73-ad9177a248cd/

    # Which generates an error :

        Error: Unable to retrieve details for instance "lb-5a868203-a8c9-4398-8c73-ad9177a248cd"

    # Danger is we would see that as a broken link and release the floating IP address.
    # Which would either cause an error, or break the load balancer.

    # So, we should only release floating IP addresses that are NOT linked to a port.

    for addressid in $(
        openstack \
            --os-cloud "${cloudname:?}" \
            floating ip list \
                --format json \
        | jq -r '.[] | select(.Port == null) | .ID'
        )
    do
        echo "Address [${addressid:?}]"
        openstack \
            --os-cloud "${cloudname:?}" \
            floating ip delete \
                "${addressid:?}"
    done


    >   Address [acdb3fd1-8aca-469b-b1cb-2e68bb49edbb]


    # BUT the system lets us delete floating IP addresses that are still linked to a load balancer.

    for addressid in $(
        openstack \
            --os-cloud "${cloudname:?}" \
            floating ip list \
                --format json \
        | jq -r '.[] | select(.Port != null) | .ID'
        )
    do
        echo "Address [${addressid:?}]"
        openstack \
            --os-cloud "${cloudname:?}" \
            floating ip delete \
                "${addressid:?}"
    done

    >   Address [cdda57ab-4aee-4011-899f-2108c0142e60]

    #
    # So now we have a load balancer .. with no floating IP address.
    # Probably not a healthy state to be in.
    #

# -----------------------------------------------------
# List our load balancers.
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        loadbalancer list

    >   +--------------------------------------+----------------------------------------------------------------------+----------------------------------+-------------+---------------------+----------+
    >   | id                                   | name                                                                 | project_id                       | vip_address | provisioning_status | provider |
    >   +--------------------------------------+----------------------------------------------------------------------+----------------------------------+-------------+---------------------+----------+
    >   | 57f5400f-b252-439f-87ef-59e57f73e31d | augustus-kesse63tp4vo-etcd_lb-jdd2xwodpxmx-loadbalancer-xbnzvepknq4t | 21b4ae3a2ea44bc5a9c14005ed2963af | 10.0.0.135  | ACTIVE              | amphora  |
    >   | 5a868203-a8c9-4398-8c73-ad9177a248cd | augustus-kesse63tp4vo-api_lb-7ipow4bk4yxq-loadbalancer-flr4w3ycgoxp  | 21b4ae3a2ea44bc5a9c14005ed2963af | 10.0.0.106  | ACTIVE              | amphora  |
    >   +--------------------------------------+----------------------------------------------------------------------+----------------------------------+-------------+---------------------+----------+

    #
    # Both the load balancers are related to our Augustus cluster.
    # Neither have an external floating IP address.
    # So our cluster is not accessible from outside.
    #

# -----------------------------------------------------
# Check external access to our cluster.
#[user@openstacker]

    openstack \
    --os-cloud "${cloudname:?}" \
        coe cluster list

    >   +--------------------------------------+----------+------------------+------------+--------------+-----------------+
    >   | uuid                                 | name     | keypair          | node_count | master_count | status          |
    >   +--------------------------------------+----------+------------------+------------+--------------+-----------------+
    >   | f5632b7e-87bd-46d6-820f-a20f1b66b6c8 | Augustus | zrq-gaia-keypair |          4 |            2 | CREATE_COMPLETE |
    >   +--------------------------------------+----------+------------------+------------+--------------+-----------------+


    clusterid=$(
        openstack \
        --os-cloud "${cloudname:?}" \
            coe cluster list \
                --format json \
        | jq -r '.[0] | .uuid'
        )

    openstack \
        --os-cloud "${cloudname:?}" \
        coe cluster \
            show \
            "${clusterid}"

    >   +---------------------+------------------------------------------------------------------------------+
    >   | Field               | Value                                                                        |
    >   +---------------------+------------------------------------------------------------------------------+
    >   | status              | CREATE_COMPLETE                                                              |
    >   | cluster_template_id | 40963ffb-4439-49f8-8e80-f511fc11c4a9                                         |
    >   | node_addresses      | ['10.0.0.217', '10.0.0.114', '10.0.0.80', '10.0.0.142']                      |
    >   | uuid                | f5632b7e-87bd-46d6-820f-a20f1b66b6c8                                         |
    >   | stack_id            | dac570e0-6b43-46ea-82fb-d608c447852e                                         |
    >   | status_reason       | None                                                                         |
    >   | created_at          | 2020-06-10T13:14:22+00:00                                                    |
    >   | updated_at          | 2020-06-12T12:31:16+00:00                                                    |
    >   | coe_version         | v1.17.2                                                                      |
    >   | labels              | {'auto_healing_controller': 'magnum-auto-healer',.... 'min_node_count': '1'} |
    >   | faults              |                                                                              |
    >   | keypair             | zrq-gaia-keypair                                                             |
    >   | api_address         | https://128.232.227.236:6443                                                 |
    >   | master_addresses    | ['10.0.0.145', '10.0.0.117']                                                 |
    >   | create_timeout      | 60                                                                           |
    >   | node_count          | 4                                                                            |
    >   | discovery_url       | https://discovery.etcd.io/6f758613b3a07a5b5a4524cdbb4c7d27                   |
    >   | master_count        | 2                                                                            |
    >   | container_version   | 1.12.6                                                                       |
    >   | name                | Augustus                                                                     |
    >   | master_flavor_id    | 20061eba-9e88-494c-95a3-41ed77721244                                         |
    >   | flavor_id           | 20061eba-9e88-494c-95a3-41ed77721244                                         |
    >   +---------------------+------------------------------------------------------------------------------+


    openstack \
        --os-cloud "${cloudname:?}" \
        coe cluster \
            show \
            "${clusterid}" \
                --format json \
        | jq -r '.api_address'

    >   https://128.232.227.236:6443

    endpoint=$(
        openstack \
            --os-cloud "${cloudname:?}" \
            coe cluster \
                show \
                "${clusterid}" \
                    --format json \
            | jq -r '.api_address'
        )

    curl "${endpoint:?}"

    >   curl: (7) Failed to connect to 128.232.227.236 port 6443: Connection refused






