#
# <meta:header>
#   <meta:licence>
#     Copyright (c) 2020, ROE (http://www.roe.ac.uk/)
#
#     This information is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This information is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
#   </meta:licence>
# </meta:header>
#
#

    #
    # Create a script to delete everything our Ansible script created.
    #

    1) delete servers
    2) delete router ports
    3) delete routers
    4) delete networks
    5) delete security groups
    6) release floating IP addresses

# -----------------------------------------------------
# Create our cloud config file.
#[user@desktop]

    #
    # See 20200114-03-podman-volume.txt
    #

# -----------------------------------------------------
# Create a container to work with.
#[user@desktop]

    podman run \
        --rm \
        --tty \
        --interactive \
        --hostname openstacker \
        --volume "${HOME}/clouds.yaml:/etc/openstack/clouds.yaml:z" \
        atolmis/openstack-client \
        bash


# -----------------------------------------------------
# Set the cloud name.
#[user@openstacker]

    cloudname=gaia-prod

    buildname=aglais-20200131


# -----------------------------------------------------
# List all the servers.
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        server list

    >   +--------------------------------------+--------------------------+--------+-----------------------------------------------------+---------------+-----------------+
    >   | ID                                   | Name                     | Status | Networks                                            | Image         | Flavor          |
    >   +--------------------------------------+--------------------------+--------+-----------------------------------------------------+---------------+-----------------+
    >   | 39ae5a23-baec-489d-9af9-7713bbf618fd | aglais-20200131-worker04 | ACTIVE | aglais-20200131-internal=10.10.0.6                  | Fedora-30-1.2 | general.v1.tiny |
    >   | 49f66242-3b59-48da-bd27-97b53ea8ac9e | aglais-20200131-worker03 | ACTIVE | aglais-20200131-internal=10.10.0.5                  | Fedora-30-1.2 | general.v1.tiny |
    >   | d78700dd-048f-441a-b0b9-9831aaacf6fd | aglais-20200131-worker02 | ACTIVE | aglais-20200131-internal=10.10.0.33                 | Fedora-30-1.2 | general.v1.tiny |
    >   | 459856e3-16d3-4414-a55c-db55db0f0768 | aglais-20200131-worker01 | ACTIVE | aglais-20200131-internal=10.10.0.28                 | Fedora-30-1.2 | general.v1.tiny |
    >   | 2ff5948d-0d37-4022-9137-46e61e51adc6 | aglais-20200131-master02 | ACTIVE | aglais-20200131-internal=10.10.0.11                 | Fedora-30-1.2 | general.v1.tiny |
    >   | 6075e41e-0547-4ec5-89d6-617ff0160bfd | aglais-20200131-master01 | ACTIVE | aglais-20200131-internal=10.10.0.12                 | Fedora-30-1.2 | general.v1.tiny |
    >   | 2d1d2a6c-e724-49c9-89ea-3dbfda93716e | aglais-20200131-gateway  | ACTIVE | aglais-20200131-internal=10.10.0.4, 128.232.227.135 | Fedora-30-1.2 | general.v1.tiny |
    >   +--------------------------------------+--------------------------+--------+-----------------------------------------------------+---------------+-----------------+


# -----------------------------------------------------
# List all the volumes.
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        volume list

    >   -


# -----------------------------------------------------
# List all the networks.
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        network list

    >   +--------------------------------------+--------------------------+----------------------------------------------------------------------------+
    >   | ID                                   | Name                     | Subnets                                                                    |
    >   +--------------------------------------+--------------------------+----------------------------------------------------------------------------+
    >   | a929e8db-1bf4-4a5f-a80c-fabd39d06a26 | internet                 | 180dc961-c52f-461a-b241-8f7a30d022a5, 273123bb-70f6-4f51-a406-7fc4b446532d |
    >   | ecb791d5-1022-447a-a79c-8f38a0f5c990 | cumulus-internal         | 01b76c7c-3c1a-4c5c-9a5a-14bcf6c0c290                                       |
    >   | f40c1857-bfe3-4d20-ae13-cac40ae777e5 | aglais-20200131-internal | e76fe845-3448-45d3-b054-c9be831a9b4d                                       |
    >   +--------------------------------------+--------------------------+----------------------------------------------------------------------------+


# -----------------------------------------------------
# List all the subnets.
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        subnet list

    >   +--------------------------------------+---------------------------------+--------------------------------------+---------------+
    >   | ID                                   | Name                            | Network                              | Subnet        |
    >   +--------------------------------------+---------------------------------+--------------------------------------+---------------+
    >   | 01b76c7c-3c1a-4c5c-9a5a-14bcf6c0c290 | cumulus-internal                | ecb791d5-1022-447a-a79c-8f38a0f5c990 | 10.218.0.0/16 |
    >   | e76fe845-3448-45d3-b054-c9be831a9b4d | aglais-20200131-internal-subnet | f40c1857-bfe3-4d20-ae13-cac40ae777e5 | 10.10.0.0/16  |
    >   +--------------------------------------+---------------------------------+--------------------------------------+---------------+


# -----------------------------------------------------
# List all the routers.
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        router list

    >   +--------------------------------------+---------------------------------+--------+-------+----------------------------------+
    >   | ID                                   | Name                            | Status | State | Project                          |
    >   +--------------------------------------+---------------------------------+--------+-------+----------------------------------+
    >   | 603036fb-70bc-4b1b-9e4e-65c3664796a4 | aglais-20200131-internal-router | ACTIVE | UP    | 21b4ae3a2ea44bc5a9c14005ed2963af |
    >   +--------------------------------------+---------------------------------+--------+-------+----------------------------------+


# -----------------------------------------------------
# List all the security groups.
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        security group list

    >   +--------------------------------------+-------------------------+------------------------+----------------------------------+------+
    >   | ID                                   | Name                    | Description            | Project                          | Tags |
    >   +--------------------------------------+-------------------------+------------------------+----------------------------------+------+
    >   | 5f568ed9-4b65-4ed0-a9ec-c5bb33316d70 | aglais-20200131-workers |                        | 21b4ae3a2ea44bc5a9c14005ed2963af | []   |
    >   | 85b124c8-910e-44e1-af0e-67631c3340b0 | aglais-20200131-masters |                        | 21b4ae3a2ea44bc5a9c14005ed2963af | []   |
    >   | aa63efff-7c67-4f29-ba7c-a1d85695407b | default                 | Default security group | 21b4ae3a2ea44bc5a9c14005ed2963af | []   |
    >   | b7919468-9f05-4c11-908d-14af82c96247 | aglais-20200131-gateway |                        | 21b4ae3a2ea44bc5a9c14005ed2963af | []   |
    >   +--------------------------------------+-------------------------+------------------------+----------------------------------+------+


# -----------------------------------------------------
# List all the floating IP addresses.
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        floating ip list

    >   +--------------------------------------+---------------------+------------------+--------------------------------------+--------------------------------------+----------------------------------+
    >   | ID                                   | Floating IP Address | Fixed IP Address | Port                                 | Floating Network                     | Project                          |
    >   +--------------------------------------+---------------------+------------------+--------------------------------------+--------------------------------------+----------------------------------+
    >   | 29073d8c-e25d-40c6-b5ac-5ea69c8b3549 | 128.232.227.135     | 10.10.0.4        | 25f74392-4a0f-43e6-87c4-deafbfa8c202 | a929e8db-1bf4-4a5f-a80c-fabd39d06a26 | 21b4ae3a2ea44bc5a9c14005ed2963af |
    >   +--------------------------------------+---------------------+------------------+--------------------------------------+--------------------------------------+----------------------------------+


# -----------------------------------------------------
# List our servers (using the list select).
#[user@openstacker]

    for serverid in $(
        openstack \
            --os-cloud "${cloudname:?}" \
            server list \
                --name '^aglais.*' \
                --column ID \
                --format value
        )
    do
        echo "----"
        echo "Server ID [${serverid:?}]"
    done


# -----------------------------------------------------
# Delete our servers (using the list select).
#[user@openstacker]

    for serverid in $(
        openstack \
            --os-cloud "${cloudname:?}" \
            server list \
                --name '^aglais.*' \
                --column ID \
                --format value
        )
    do
        echo "----"
        echo "Server ID [${serverid:?}]"
        openstack \
            --os-cloud "${cloudname:?}" \
            server delete \
                "${serverid:?}"
    done


    >   ----
    >   Server ID [39ae5a23-baec-489d-9af9-7713bbf618fd]
    >   ----
    >   Server ID [49f66242-3b59-48da-bd27-97b53ea8ac9e]
    >   ----
    >   Server ID [d78700dd-048f-441a-b0b9-9831aaacf6fd]
    >   ----
    >   Server ID [459856e3-16d3-4414-a55c-db55db0f0768]
    >   ----
    >   Server ID [2ff5948d-0d37-4022-9137-46e61e51adc6]
    >   ----
    >   Server ID [6075e41e-0547-4ec5-89d6-617ff0160bfd]
    >   ----
    >   Server ID [2d1d2a6c-e724-49c9-89ea-3dbfda93716e]


# -----------------------------------------------------
# List our routers (using JQ select).
#[user@openstacker]

    for routerid in $(
        openstack \
            --os-cloud "${cloudname:?}" \
            router list \
                --format json \
        | jq -r '.[] | select(.Name | test("'${buildname:?}'")) | .ID'
        )
    do
        echo "----"
        echo "Router ID [${routerid:?}]"
    done


# -----------------------------------------------------
# Delete our routers (using JQ select).
#[user@openstacker]

    for routerid in $(
        openstack \
            --os-cloud "${cloudname:?}" \
            router list \
                --format json \
        | jq -r '.[] | select(.Name | test("'${buildname:?}'")) | .ID'
        )
    do
        echo "----"
        echo "Router ID [${routerid:?}]"
        openstack \
            --os-cloud "${cloudname:?}" \
            router delete \
                "${routerid:?}"

    done


    >   ----
    >   Router ID [603036fb-70bc-4b1b-9e4e-65c3664796a4]
    >   Failed to delete router with name or ID '603036fb-70bc-4b1b-9e4e-65c3664796a4': ConflictException: 409: Client Error for url: https://cumulus.openstack.hpc.cam.ac.uk:9696/v2.0/routers/603036fb-70bc-4b1b-9e4e-65c3664796a4, Router 603036fb-70bc-4b1b-9e4e-65c3664796a4 still has ports
    >   1 of 1 routers failed to delete.


# -----------------------------------------------------
# List our router ports (using JQ foo).
#[user@openstacker]

    for routerid in $(
        openstack \
            --os-cloud "${cloudname:?}" \
            router list \
                --format json \
        | jq -r '.[] | select(.Name | test("'${buildname:?}'")) | .ID'
        )
    do
        echo "----"
        echo "Router ID [${routerid:?}]"

        interfaces=$(
            openstack \
                --os-cloud "${cloudname:?}" \
                router show \
                    --format json \
                    "${routerid:?}" \
            | jq -r '.interfaces_info'
            )

        for portid in $(
            echo $interfaces | jq -r '.[] | .port_id'
            )
        do
            echo "Port ID [${portid:?}]"
        done
    done


    >   ----
    >   Router ID [603036fb-70bc-4b1b-9e4e-65c3664796a4]
    >   Port ID [6a3f60e7-7e11-4bf7-9e90-3224e1813090]


# -----------------------------------------------------
# List our router ports (the easy way).
#[user@openstacker]

    for routerid in $(
        openstack \
            --os-cloud "${cloudname:?}" \
            router list \
                --format json \
        | jq -r '.[] | select(.Name | test("'${buildname:?}'")) | .ID'
        )
    do
        echo "----"
        echo "Router ID [${routerid:?}]"

        for portid in $(
            openstack \
                --os-cloud "${cloudname:?}" \
                port list \
                    --router "${routerid:?}" \
                    --format json \
            | jq -r '.[] | .ID'
            )
        do
            echo "Port ID [${portid:?}]"
        done
    done

    >   ----
    >   Router ID [603036fb-70bc-4b1b-9e4e-65c3664796a4]
    >   Port ID [6a3f60e7-7e11-4bf7-9e90-3224e1813090]


# -----------------------------------------------------
# Delete our router ports (using JQ foo).
#[user@openstacker]

    for routerid in $(
        openstack \
            --os-cloud "${cloudname:?}" \
            router list \
                --format json \
        | jq -r '.[] | select(.Name | test("'${buildname:?}'")) | .ID'
        )
    do
        echo "----"
        echo "Router ID [${routerid:?}]"

        for portid in $(
            openstack \
                --os-cloud "${cloudname:?}" \
                port list \
                    --router "${routerid:?}" \
                    --format json \
            | jq -r '.[] | .ID'
            )
        do
            echo "Port ID [${portid:?}]"
            openstack \
                --os-cloud "${cloudname:?}" \
                port delete \
                    "${portid:?}"
        done
    done


    >   ----
    >   Router ID [603036fb-70bc-4b1b-9e4e-65c3664796a4]
    >   Port ID [6a3f60e7-7e11-4bf7-9e90-3224e1813090]
    >   Failed to delete port with name or ID '6a3f60e7-7e11-4bf7-9e90-3224e1813090': ConflictException: 409: Client Error for url: https://cumulus.openstack.hpc.cam.ac.uk:9696/v2.0/ports/6a3f60e7-7e11-4bf7-9e90-3224e1813090, Port 6a3f60e7-7e11-4bf7-9e90-3224e1813090 cannot be deleted directly via the port API: has device owner network:ha_router_replicated_interface.
    >   1 of 1 ports failed to delete.


# -----------------------------------------------------
# Show our router details.
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        router show \
            --format json \
            "${routerid:?}"            

    >   {
    >     "admin_state_up": "UP",
    >     "availability_zone_hints": "",
    >     "availability_zones": "nova",
    >     "created_at": "2020-01-31T01:59:40Z",
    >     "description": "",
    >     "external_gateway_info": "{\"network_id\": \"a929e8db-1bf4-4a5f-a80c-fabd39d06a26\", \"enable_snat\": true, \"external_fixed_ips\": [{\"subnet_id\": \"273123bb-70f6-4f51-a406-7fc4b446532d\", \"ip_address\": \"128.232.227.144\"}]}",
    >     "flavor_id": null,
    >     "id": "603036fb-70bc-4b1b-9e4e-65c3664796a4",
    >     "interfaces_info": "[{\"port_id\": \"6a3f60e7-7e11-4bf7-9e90-3224e1813090\", \"ip_address\": \"10.10.0.1\", \"subnet_id\": \"e76fe845-3448-45d3-b054-c9be831a9b4d\"}]",
    >     "location": {
    >       "cloud": "gaia-prod",
    >       "region_name": "RegionOne",
    >       "zone": null,
    >       "project": {
    >         "id": "21b4ae3a2ea44bc5a9c14005ed2963af",
    >         "name": null,
    >         "domain_id": null,
    >         "domain_name": null
    >       }
    >     },
    >     "name": "aglais-20200131-internal-router",
    >     "project_id": "21b4ae3a2ea44bc5a9c14005ed2963af",
    >     "revision_number": 9,
    >     "routes": "",
    >     "status": "ACTIVE",
    >     "tags": "",
    >     "updated_at": "2020-01-31T01:59:49Z"
    >   }


# -----------------------------------------------------
# Show our port details.
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        port show \
            --format json \
            "${portid:?}"            

    >          
    >   {
    >     "admin_state_up": "UP",
    >     "allowed_address_pairs": "",
    >     "binding_host_id": null,
    >     "binding_profile": null,
    >     "binding_vif_details": null,
    >     "binding_vif_type": null,
    >     "binding_vnic_type": "normal",
    >     "created_at": "2020-01-31T01:59:48Z",
    >     "data_plane_status": null,
    >     "description": "",
    >     "device_id": "603036fb-70bc-4b1b-9e4e-65c3664796a4",
    >     "device_owner": "network:ha_router_replicated_interface",
    >     "dns_assignment": "fqdn='host-10-10-0-1.iris.cumulus.local.', hostname='host-10-10-0-1', ip_address='10.10.0.1'",
    >     "dns_domain": null,
    >     "dns_name": "",
    >     "extra_dhcp_opts": "",
    >     "fixed_ips": "ip_address='10.10.0.1', subnet_id='e76fe845-3448-45d3-b054-c9be831a9b4d'",
    >     "id": "6a3f60e7-7e11-4bf7-9e90-3224e1813090",
    >     "location": {
    >       "cloud": "gaia-prod",
    >       "region_name": "RegionOne",
    >       "zone": null,
    >       "project": {
    >         "id": "21b4ae3a2ea44bc5a9c14005ed2963af",
    >         "name": null,
    >         "domain_id": null,
    >         "domain_name": null
    >       }
    >     },
    >     "mac_address": "fa:16:3e:6a:2e:22",
    >     "name": "",
    >     "network_id": "f40c1857-bfe3-4d20-ae13-cac40ae777e5",
    >     "port_security_enabled": false,
    >     "project_id": "21b4ae3a2ea44bc5a9c14005ed2963af",
    >     "propagate_uplink_status": null,
    >     "qos_policy_id": null,
    >     "resource_request": null,
    >     "revision_number": 6,
    >     "security_group_ids": "",
    >     "status": "ACTIVE",
    >     "tags": "",
    >     "trunk_details": null,
    >     "updated_at": "2020-01-31T02:00:24Z"
    >   }


# -----------------------------------------------------
# Remove the port from the router.
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        router remove port \
            "${routerid:?}" \
            "${portid:?}"            


# -----------------------------------------------------
# Delete the port.
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        port delete \
            "${portid:?}"

    >   Failed to delete port with name or ID '6a3f60e7-7e11-4bf7-9e90-3224e1813090': No Port found for 6a3f60e7-7e11-4bf7-9e90-3224e1813090
    >   1 of 1 ports failed to delete.

    #
    # Looks like it has gone anyway.
    #

    openstack \
        --os-cloud "${cloudname:?}" \
        port list

    >   +--------------------------------------+------+-------------------+--------------------------------------------------------------------------+--------+
    >   | ID                                   | Name | MAC Address       | Fixed IP Addresses                                                       | Status |
    >   +--------------------------------------+------+-------------------+--------------------------------------------------------------------------+--------+
    >   | 5e5d570b-71d7-4b26-a353-d5ffecea1a78 |      | fa:16:3e:e1:8c:06 | ip_address='10.10.0.2', subnet_id='e76fe845-3448-45d3-b054-c9be831a9b4d' | ACTIVE |
    >   | a1c54dd6-9bba-41a9-8dfb-91762f43ae70 |      | fa:16:3e:4d:ee:f1 | ip_address='10.10.0.3', subnet_id='e76fe845-3448-45d3-b054-c9be831a9b4d' | ACTIVE |
    >   +--------------------------------------+------+-------------------+--------------------------------------------------------------------------+--------+


# -----------------------------------------------------
# Check the details of the remaining ports.
#[user@openstacker]

    for portid in $(
        openstack \
            --os-cloud "${cloudname:?}" \
            port list \
                --format json \
        | jq -r '.[] | .ID'
        )
    do
        openstack \
            --os-cloud "${cloudname:?}" \
            port show \
                --format json \
                "${portid:?}"            
    done


    >   {
    >     "admin_state_up": "UP",
    >     "allowed_address_pairs": "",
    >     "binding_host_id": null,
    >     "binding_profile": null,
    >     "binding_vif_details": null,
    >     "binding_vif_type": null,
    >     "binding_vnic_type": "normal",
    >     "created_at": "2020-01-31T01:59:37Z",
    >     "data_plane_status": null,
    >     "description": "",
    >     "device_id": "dhcp37607fa3-c23c-5a22-ae91-c92033d7849e-f40c1857-bfe3-4d20-ae13-cac40ae777e5",
    >     "device_owner": "network:dhcp",
    >     "dns_assignment": "fqdn='host-10-10-0-2.iris.cumulus.local.', hostname='host-10-10-0-2', ip_address='10.10.0.2'",
    >     "dns_domain": null,
    >     "dns_name": "",
    >     "extra_dhcp_opts": "",
    >     "fixed_ips": "ip_address='10.10.0.2', subnet_id='e76fe845-3448-45d3-b054-c9be831a9b4d'",
    >     "id": "5e5d570b-71d7-4b26-a353-d5ffecea1a78",
    >     "location": {
    >       "cloud": "gaia-prod",
    >       "region_name": "RegionOne",
    >       "zone": null,
    >       "project": {
    >         "id": "21b4ae3a2ea44bc5a9c14005ed2963af",
    >         "name": null,
    >         "domain_id": null,
    >         "domain_name": null
    >       }
    >     },
    >     "mac_address": "fa:16:3e:e1:8c:06",
    >     "name": "",
    >     "network_id": "f40c1857-bfe3-4d20-ae13-cac40ae777e5",
    >     "port_security_enabled": false,
    >     "project_id": "21b4ae3a2ea44bc5a9c14005ed2963af",
    >     "propagate_uplink_status": null,
    >     "qos_policy_id": null,
    >     "resource_request": null,
    >     "revision_number": 3,
    >     "security_group_ids": "",
    >     "status": "ACTIVE",
    >     "tags": "",
    >     "trunk_details": null,
    >     "updated_at": "2020-01-31T01:59:46Z"
    >   }
    >   {
    >     "admin_state_up": "UP",
    >     "allowed_address_pairs": "",
    >     "binding_host_id": null,
    >     "binding_profile": null,
    >     "binding_vif_details": null,
    >     "binding_vif_type": null,
    >     "binding_vnic_type": "normal",
    >     "created_at": "2020-01-31T01:59:37Z",
    >     "data_plane_status": null,
    >     "description": "",
    >     "device_id": "dhcp0a3448f8-9bce-56c9-a82c-5d5b4b54ed62-f40c1857-bfe3-4d20-ae13-cac40ae777e5",
    >     "device_owner": "network:dhcp",
    >     "dns_assignment": "fqdn='host-10-10-0-3.iris.cumulus.local.', hostname='host-10-10-0-3', ip_address='10.10.0.3'",
    >     "dns_domain": null,
    >     "dns_name": "",
    >     "extra_dhcp_opts": "",
    >     "fixed_ips": "ip_address='10.10.0.3', subnet_id='e76fe845-3448-45d3-b054-c9be831a9b4d'",
    >     "id": "a1c54dd6-9bba-41a9-8dfb-91762f43ae70",
    >     "location": {
    >       "cloud": "gaia-prod",
    >       "region_name": "RegionOne",
    >       "zone": null,
    >       "project": {
    >         "id": "21b4ae3a2ea44bc5a9c14005ed2963af",
    >         "name": null,
    >         "domain_id": null,
    >         "domain_name": null
    >       }
    >     },
    >     "mac_address": "fa:16:3e:4d:ee:f1",
    >     "name": "",
    >     "network_id": "f40c1857-bfe3-4d20-ae13-cac40ae777e5",
    >     "port_security_enabled": false,
    >     "project_id": "21b4ae3a2ea44bc5a9c14005ed2963af",
    >     "propagate_uplink_status": null,
    >     "qos_policy_id": null,
    >     "resource_request": null,
    >     "revision_number": 3,
    >     "security_group_ids": "",
    >     "status": "ACTIVE",
    >     "tags": "",
    >     "trunk_details": null,
    >     "updated_at": "2020-01-31T01:59:48Z"
    >   }

    #
    # Both have
    #   "device_owner": "network:dhcp"
    #
    # Suggests they were allocated as part of the network and subnet.
    #


# -----------------------------------------------------
# Delete our routers (using JQ select).
#[user@openstacker]

    for routerid in $(
        openstack \
            --os-cloud "${cloudname:?}" \
            router list \
                --format json \
        | jq -r '.[] | select(.Name | test("'${buildname:?}'")) | .ID'
        )
    do
        echo "----"
        echo "Router ID [${routerid:?}]"
        openstack \
            --os-cloud "${cloudname:?}" \
            router delete \
                "${routerid:?}"

    done


    >   ----
    >   Router ID [603036fb-70bc-4b1b-9e4e-65c3664796a4]


# -----------------------------------------------------
# List all the networks.
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        network list

    >   +--------------------------------------+--------------------------+----------------------------------------------------------------------------+
    >   | ID                                   | Name                     | Subnets                                                                    |
    >   +--------------------------------------+--------------------------+----------------------------------------------------------------------------+
    >   | a929e8db-1bf4-4a5f-a80c-fabd39d06a26 | internet                 | 180dc961-c52f-461a-b241-8f7a30d022a5, 273123bb-70f6-4f51-a406-7fc4b446532d |
    >   | ecb791d5-1022-447a-a79c-8f38a0f5c990 | cumulus-internal         | 01b76c7c-3c1a-4c5c-9a5a-14bcf6c0c290                                       |
    >   | f40c1857-bfe3-4d20-ae13-cac40ae777e5 | aglais-20200131-internal | e76fe845-3448-45d3-b054-c9be831a9b4d                                       |
    >   +--------------------------------------+--------------------------+----------------------------------------------------------------------------+


# -----------------------------------------------------
# List our networks.
#[user@openstacker]

    for networkid in $(
        openstack \
            --os-cloud "${cloudname:?}" \
            network list \
                --format json \
        | jq -r '.[] | select(.Name | test("'${buildname:?}'")) | .ID'
        )
    do
        echo "----"
        echo "Network ID [${networkid:?}]"
    done

    >   ----
    >   Network ID [f40c1857-bfe3-4d20-ae13-cac40ae777e5]


# -----------------------------------------------------
# Delete our networks.
#[user@openstacker]

    for networkid in $(
        openstack \
            --os-cloud "${cloudname:?}" \
            network list \
                --format json \
        | jq -r '.[] | select(.Name | test("'${buildname:?}'")) | .ID'
        )
    do
        echo "----"
        echo "Network ID [${networkid:?}]"
        openstack \
            --os-cloud "${cloudname:?}" \
            network delete \
                "${networkid:?}"
    done

    >   ----
    >   Network ID [f40c1857-bfe3-4d20-ae13-cac40ae777e5]


# -----------------------------------------------------
# List all the subnets.
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        subnet list

    >   -


# -----------------------------------------------------
# List all the security groups.
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        security group list

    >   +--------------------------------------+-------------------------+------------------------+----------------------------------+------+
    >   | ID                                   | Name                    | Description            | Project                          | Tags |
    >   +--------------------------------------+-------------------------+------------------------+----------------------------------+------+
    >   | 5f568ed9-4b65-4ed0-a9ec-c5bb33316d70 | aglais-20200131-workers |                        | 21b4ae3a2ea44bc5a9c14005ed2963af | []   |
    >   | 85b124c8-910e-44e1-af0e-67631c3340b0 | aglais-20200131-masters |                        | 21b4ae3a2ea44bc5a9c14005ed2963af | []   |
    >   | aa63efff-7c67-4f29-ba7c-a1d85695407b | default                 | Default security group | 21b4ae3a2ea44bc5a9c14005ed2963af | []   |
    >   | b7919468-9f05-4c11-908d-14af82c96247 | aglais-20200131-gateway |                        | 21b4ae3a2ea44bc5a9c14005ed2963af | []   |
    >   +--------------------------------------+-------------------------+------------------------+----------------------------------+------+


# -----------------------------------------------------
# List our security groups.
#[user@openstacker]

    for groupid in $(
        openstack \
            --os-cloud "${cloudname:?}" \
            security group list \
                --format json \
        | jq -r '.[] | select(.Name | test("'${buildname:?}'")) | .ID'
        )
    do
        echo "----"
        echo "Group ID [${groupid:?}]"
    done

    >   ----
    >   Group ID [5f568ed9-4b65-4ed0-a9ec-c5bb33316d70]
    >   ----
    >   Group ID [85b124c8-910e-44e1-af0e-67631c3340b0]
    >   ----
    >   Group ID [b7919468-9f05-4c11-908d-14af82c96247]


# -----------------------------------------------------
# Delete our security groups.
#[user@openstacker]

    for groupid in $(
        openstack \
            --os-cloud "${cloudname:?}" \
            security group list \
                --format json \
        | jq -r '.[] | select(.Name | test("'${buildname:?}'")) | .ID'
        )
    do
        echo "----"
        echo "Group ID [${groupid:?}]"
        openstack \
            --os-cloud "${cloudname:?}" \
            security group delete \
                "${groupid:?}"
    done

    >   ----
    >   Group ID [5f568ed9-4b65-4ed0-a9ec-c5bb33316d70]
    >   ----
    >   Group ID [85b124c8-910e-44e1-af0e-67631c3340b0]
    >   ----
    >   Group ID [b7919468-9f05-4c11-908d-14af82c96247]


# -----------------------------------------------------
# List all the floating IP addresses.
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        floating ip list


# -----------------------------------------------------
# Release all the floating IP addresses.
#[user@openstacker]

    for addressid in $(
        openstack \
            --os-cloud "${cloudname:?}" \
            floating ip list \
                --format json \
        | jq -r '.[] | .ID'
        )
    do
        echo "----"
        echo "Address ID [${addressid:?}]"
        openstack \
            --os-cloud "${cloudname:?}" \
            floating ip delete \
                "${addressid:?}"
    done

    >   ----
    >   Address ID [29073d8c-e25d-40c6-b5ac-5ea69c8b3549]


# -----------------------------------------------------
# List all the servers.
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        server list

    >   -


# -----------------------------------------------------
# List all the volumes.
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        volume list

    >   -


# -----------------------------------------------------
# List all the networks.
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        network list

    >   +--------------------------------------+------------------+----------------------------------------------------------------------------+
    >   | ID                                   | Name             | Subnets                                                                    |
    >   +--------------------------------------+------------------+----------------------------------------------------------------------------+
    >   | a929e8db-1bf4-4a5f-a80c-fabd39d06a26 | internet         | 180dc961-c52f-461a-b241-8f7a30d022a5, 273123bb-70f6-4f51-a406-7fc4b446532d |
    >   | ecb791d5-1022-447a-a79c-8f38a0f5c990 | cumulus-internal | 01b76c7c-3c1a-4c5c-9a5a-14bcf6c0c290                                       |
    >   +--------------------------------------+------------------+----------------------------------------------------------------------------+


# -----------------------------------------------------
# List all the subnets.
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        subnet list

    >   +--------------------------------------+------------------+--------------------------------------+---------------+
    >   | ID                                   | Name             | Network                              | Subnet        |
    >   +--------------------------------------+------------------+--------------------------------------+---------------+
    >   | 01b76c7c-3c1a-4c5c-9a5a-14bcf6c0c290 | cumulus-internal | ecb791d5-1022-447a-a79c-8f38a0f5c990 | 10.218.0.0/16 |
    >   +--------------------------------------+------------------+--------------------------------------+---------------+


# -----------------------------------------------------
# List all the routers.
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        router list

    >   -


# -----------------------------------------------------
# List all the security groups.
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        security group list

    >   +--------------------------------------+---------+------------------------+----------------------------------+------+
    >   | ID                                   | Name    | Description            | Project                          | Tags |
    >   +--------------------------------------+---------+------------------------+----------------------------------+------+
    >   | aa63efff-7c67-4f29-ba7c-a1d85695407b | default | Default security group | 21b4ae3a2ea44bc5a9c14005ed2963af | []   |
    >   +--------------------------------------+---------+------------------------+----------------------------------+------+


# -----------------------------------------------------
# List all the security group rules.
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        security group rule list


    >   +--------------------------------------+-------------+----------+------------+--------------------------------------+--------------------------------------+
    >   | ID                                   | IP Protocol | IP Range | Port Range | Remote Security Group                | Security Group                       |
    >   +--------------------------------------+-------------+----------+------------+--------------------------------------+--------------------------------------+
    >   | 279b0f75-9616-4c90-8b0c-3f50095a6466 | None        | None     |            | None                                 | aa63efff-7c67-4f29-ba7c-a1d85695407b |
    >   | 8030c738-9c73-4986-bc9c-c37a0bf494ab | None        | None     |            | None                                 | aa63efff-7c67-4f29-ba7c-a1d85695407b |
    >   | 96a19fbc-8fd6-435a-b67d-85c125d32fb8 | None        | None     |            | aa63efff-7c67-4f29-ba7c-a1d85695407b | aa63efff-7c67-4f29-ba7c-a1d85695407b |
    >   | d1c20193-10a9-4e78-90c7-9cbbf8825171 | None        | None     |            | aa63efff-7c67-4f29-ba7c-a1d85695407b | aa63efff-7c67-4f29-ba7c-a1d85695407b |
    >   +--------------------------------------+-------------+----------+------------+--------------------------------------+--------------------------------------+


# -----------------------------------------------------
# Show all the security group rules.
#[user@openstacker]

    for ruleid in $(
        openstack \
            --os-cloud "${cloudname:?}" \
            security group rule list \
                --format json \
        | jq -r '.[] | .ID'
        )
    do
        echo "----"
        echo "Rule ID [${ruleid:?}]"
        openstack \
            --os-cloud "${cloudname:?}" \
            security group rule show \
                "${ruleid:?}"
    done

    >   ----
    >   Rule ID [279b0f75-9616-4c90-8b0c-3f50095a6466]
    >   +-------------------+-----------------------------------------+
    >   | Field             | Value                                   |
    >   +-------------------+-----------------------------------------+
    >   | created_at        | 2019-11-20T13:52:48Z                    |
    >   | description       | None                                    |
    >   | direction         | egress                                  |
    >   | ether_type        | IPv6                                    |
    >   | id                | 279b0f75-9616-4c90-8b0c-3f50095a6466    |
    >   | location          | Munch( .... )                           |
    >   | name              | None                                    |
    >   | port_range_max    | None                                    |
    >   | port_range_min    | None                                    |
    >   | project_id        | 21b4ae3a2ea44bc5a9c14005ed2963af        |
    >   | protocol          | None                                    |
    >   | remote_group_id   | None                                    |
    >   | remote_ip_prefix  | None                                    |
    >   | revision_number   | 0                                       |
    >   | security_group_id | aa63efff-7c67-4f29-ba7c-a1d85695407b    |
    >   | tags              | []                                      |
    >   | updated_at        | 2019-11-20T13:52:48Z                    |
    >   +-------------------+-----------------------------------------+

    >   ----
    >   Rule ID [8030c738-9c73-4986-bc9c-c37a0bf494ab]
    >   +-------------------+-----------------------------------------+
    >   | Field             | Value                                   |
    >   +-------------------+-----------------------------------------+
    >   | created_at        | 2019-11-20T13:52:48Z                    |
    >   | description       | None                                    |
    >   | direction         | egress                                  |
    >   | ether_type        | IPv4                                    |
    >   | id                | 8030c738-9c73-4986-bc9c-c37a0bf494ab    |
    >   | location          | Munch( .... )                           |
    >   | name              | None                                    |
    >   | port_range_max    | None                                    |
    >   | port_range_min    | None                                    |
    >   | project_id        | 21b4ae3a2ea44bc5a9c14005ed2963af        |
    >   | protocol          | None                                    |
    >   | remote_group_id   | None                                    |
    >   | remote_ip_prefix  | None                                    |
    >   | revision_number   | 0                                       |
    >   | security_group_id | aa63efff-7c67-4f29-ba7c-a1d85695407b    |
    >   | tags              | []                                      |
    >   | updated_at        | 2019-11-20T13:52:48Z                    |
    >   +-------------------+-----------------------------------------+

    >   ----
    >   Rule ID [96a19fbc-8fd6-435a-b67d-85c125d32fb8]
    >   +-------------------+-----------------------------------------+
    >   | Field             | Value                                   |
    >   +-------------------+-----------------------------------------+
    >   | created_at        | 2019-11-20T13:52:48Z                    |
    >   | description       | None                                    |
    >   | direction         | ingress                                 |
    >   | ether_type        | IPv6                                    |
    >   | id                | 96a19fbc-8fd6-435a-b67d-85c125d32fb8    |
    >   | location          | Munch( .... )                           |
    >   | name              | None                                    |
    >   | port_range_max    | None                                    |
    >   | port_range_min    | None                                    |
    >   | project_id        | 21b4ae3a2ea44bc5a9c14005ed2963af        |
    >   | protocol          | None                                    |
    >   | remote_group_id   | aa63efff-7c67-4f29-ba7c-a1d85695407b    |
    >   | remote_ip_prefix  | None                                    |
    >   | revision_number   | 0                                       |
    >   | security_group_id | aa63efff-7c67-4f29-ba7c-a1d85695407b    |
    >   | tags              | []                                      |
    >   | updated_at        | 2019-11-20T13:52:48Z                    |
    >   +-------------------+-----------------------------------------+

    >   ----
    >   Rule ID [d1c20193-10a9-4e78-90c7-9cbbf8825171]
    >   +-------------------+-----------------------------------------+
    >   | Field             | Value                                   |
    >   +-------------------+-----------------------------------------+
    >   | created_at        | 2019-11-20T13:52:48Z                    |
    >   | description       | None                                    |
    >   | direction         | ingress                                 |
    >   | ether_type        | IPv4                                    |
    >   | id                | d1c20193-10a9-4e78-90c7-9cbbf8825171    |
    >   | location          | Munch( .... )                           |
    >   | name              | None                                    |
    >   | port_range_max    | None                                    |
    >   | port_range_min    | None                                    |
    >   | project_id        | 21b4ae3a2ea44bc5a9c14005ed2963af        |
    >   | protocol          | None                                    |
    >   | remote_group_id   | aa63efff-7c67-4f29-ba7c-a1d85695407b    |
    >   | remote_ip_prefix  | None                                    |
    >   | revision_number   | 0                                       |
    >   | security_group_id | aa63efff-7c67-4f29-ba7c-a1d85695407b    |
    >   | tags              | []                                      |
    >   | updated_at        | 2019-11-20T13:52:48Z                    |
    >   +-------------------+-----------------------------------------+
    >   [root@openstacker /]# 


# -----------------------------------------------------
# List all the floating IP addresses.
#[user@openstacker]

    openstack \
        --os-cloud "${cloudname:?}" \
        floating ip list

    >   -

