#
# <meta:header>
#   <meta:licence>
#     Copyright (c) 2019, ROE (http://www.roe.ac.uk/)
#
#     This information is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This information is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
#   </meta:licence>
# </meta:header>
#
#

# -----------------------------------------------------
# Configure our OpenStack settings.
# https://docs.openstack.org/keystone/queens/user/application_credentials.html
# https://cumulus.openstack.hpc.cam.ac.uk/identity/application_credentials/
#[user@desktop]

        cat > "${HOME}/cumulus.settings" << EOF

export OS_AUTH_TYPE=v3applicationcredential
export OS_AUTH_URL=https://cumulus.openstack.hpc.cam.ac.uk:5000/v3
export OS_IDENTITY_API_VERSION=3
export OS_REGION_NAME=RegionOne
export OS_INTERFACE=public
export OS_APPLICATION_CREDENTIAL_ID=$(secret 'cumulus.cam.ac.uk.CREDENTIAL_ID')
export OS_APPLICATION_CREDENTIAL_SECRET=$(secret 'cumulus.cam.ac.uk.CREDENTIAL_SECRET')

EOF

# -----------------------------------------------------
# Build our Docker images.
#[user@desktop]

    buildtag=$(date +'%Y.%m.%d')

    source "${HOME}/aglais.settings"

    pushd  "${AGLAIS_CODE}"
        pushd src/docker

            export buildtag
            docker-compose \
                --file images.yml \
                build

        popd
    popd

    >   ....
    >   ....

# -----------------------------------------------------
# Create a container using our own uid.
#[user@desktop]

    docker run \
        --rm \
        --tty \
        --user "$(id -u)" \
        --interactive \
        --hostname ansible \
        --env SSH_AUTH_SOCK=/tmp/ssh_auth_sock \
        --volume "${SSH_AUTH_SOCK}:/tmp/ssh_auth_sock" \
        --volume "${HOME}/cumulus.settings:/etc/aglais/cumulus.settings" \
        --volume "${HOME}/.ssh/cumulus.cam.ac.uk.rsa.pub:/tmp/cumulus.cam.ac.uk.rsa.pub" \
        --volume "${AGLAIS_CODE}/src/ansible:/var/local/aglais/ansible" \
        aglais/ansible-client:${buildtag:?} \
        bash


    >   ....


# -----------------------------------------------------
# Load our OpenStack settings.
#[user@ansible]

    source '/etc/aglais/cumulus.settings'


# -----------------------------------------------------
# Test our first playbook.
#[user@ansible]

    ANSIBLE_CODE=/var/local/aglais/ansible

    ansible-playbook "${ANSIBLE_CODE}/hello-world.yml"

    >   Unhandled error:
    >    Traceback (most recent call last):
    >     File "/usr/lib/python3.7/site-packages/ansible/utils/path.py", line 77, in makedirs_safe
    >       os.makedirs(b_rpath, mode)
    >     File "/usr/lib64/python3.7/os.py", line 211, in makedirs
    >       makedirs(head, exist_ok=exist_ok)
    >     File "/usr/lib64/python3.7/os.py", line 221, in makedirs
    >       mkdir(name, mode)
    >   PermissionError: [Errno 13] Permission denied: b'/.ansible'
    >   
    >   During handling of the above exception, another exception occurred:
    >   
    >   Traceback (most recent call last):
    >     File "/usr/lib/python3.7/site-packages/ansible/config/manager.py", line 523, in update_config_data
    >       value, origin = self.get_config_value_and_origin(config, configfile)
    >     File "/usr/lib/python3.7/site-packages/ansible/config/manager.py", line 467, in get_config_value_and_origin
    >       value = ensure_type(value, defs[config].get('type'), origin=origin)
    >     File "/usr/lib/python3.7/site-packages/ansible/config/manager.py", line 110, in ensure_type
    >       makedirs_safe(value, 0o700)
    >     File "/usr/lib/python3.7/site-packages/ansible/utils/path.py", line 82, in makedirs_safe
    >       raise AnsibleError("Unable to create local directories(%s): %s" % (to_native(rpath), to_native(e)))
    >   ansible.errors.AnsibleError: Unable to create local directories(/.ansible/tmp): [Errno 13] Permission denied: b'/.ansible'

    # Ansible needs a user's home directory, and barfs if it isn't there.


# -----------------------------------------------------
# Create a container running as root.
#[user@desktop]

    docker run \
        --rm \
        --tty \
        --interactive \
        --hostname ansible \
        --env SSH_AUTH_SOCK=/tmp/ssh_auth_sock \
        --volume "${SSH_AUTH_SOCK}:/tmp/ssh_auth_sock" \
        --volume "${HOME}/cumulus.settings:/etc/aglais/cumulus.settings" \
        --volume "${HOME}/.ssh/cumulus.cam.ac.uk.rsa.pub:/tmp/cumulus.cam.ac.uk.rsa.pub" \
        --volume "${AGLAIS_CODE}/src/ansible:/var/local/aglais/ansible" \
        aglais/ansible-client:${buildtag:?} \
        bash


    >   ....


# -----------------------------------------------------
# Load our OpenStack settings.
#[root@ansible]

    source '/etc/aglais/cumulus.settings'


# -----------------------------------------------------
# Create a hello world playbook.
#[root@ansible]


    cat > "/tmp/hello-world.yml" << EOF

- hosts: localhost
  tasks:
    - name: Echo "Hello World"
      command: echo "Hello World"

EOF

# -----------------------------------------------------
# Test our hello world playbook.
#[root@ansible]

    ansible-playbook "/tmp/hello-world.yml"

    >   [WARNING]: provided hosts list is empty, only localhost is available. Note that the implicit localhost does not match 'all'
    >   
    >   PLAY [localhost] *******************************************************************************
    >   
    >   TASK [Gathering Facts] *************************************************************************
    >   ok: [localhost]
    >   
    >   TASK [Echo "Hello World"] **********************************************************************
    >   changed: [localhost]
    >   
    >   PLAY RECAP *************************************************************************************
    >   localhost: ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0


# -----------------------------------------------------
# Create our clouds YAML file.
# https://docs.openstack.org/python-openstackclient/latest/configuration/index.html#clouds-yaml
#[root@ansible]

    # clouds.yaml is a configuration file that contains everything needed to connect to one or more clouds.
    # It may contain private information and is generally considered private to a user.

cat > ${HOME}/clouds.yaml << EOF

clouds:
  cumulus:
    auth:
      auth_url: ${OS_AUTH_URL}
      auth_type: ${OS_AUTH_TYPE}
      application_credential_id: ${OS_APPLICATION_CREDENTIAL_ID}
      application_credential_secret: ${OS_APPLICATION_CREDENTIAL_SECRET}
    region_name: ${OS_REGION_NAME}
    interface: ${OS_INTERFACE}
    identity_api_version: ${OS_IDENTITY_API_VERSION}

EOF


# -----------------------------------------------------
# Create a playbook to create our OpenStack keypair.
# https://docs.ansible.com/ansible/latest/modules/list_of_cloud_modules.html#openstack
#[root@ansible]

    cat > "/tmp/01-create-keypair.yml" << EOF
---
- name: Deploy a ssh keypair
  hosts: localhost
  tasks:
    - name: create keypair
      os_keypair:
        cloud: cumulus
        state: present
        name: 'cumulus-cam-ac-uk-rsa'
        public_key_file: '/tmp/cumulus.cam.ac.uk.rsa.pub'
        wait: yes

EOF

    ansible-playbook "/tmp/01-create-keypair.yml"

    >   [WARNING]: provided hosts list is empty, only localhost is available. Note that the implicit localhost does not match 'all'
    >   
    >   PLAY [Deploy a ssh keypair] ********************************************************************
    >   
    >   TASK [Gathering Facts] *************************************************************************
    >   ok: [localhost]
    >   
    >   TASK [create keypair] **************************************************************************
    >   fatal: [localhost]: FAILED! => {"changed": false, "msg": "openstacksdk is required for this module"}
    >   
    >   PLAY RECAP *************************************************************************************
    >   localhost: ok=1    changed=0    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0

    #
    # The OpenStack Ansible module uses the Python OpenStack client.


# -----------------------------------------------------
# Update the ansible-client Dockerfile to extend the openstack-client image.
#[user@desktop]

    source "${HOME}/aglais.settings"

    pushd  "${AGLAIS_CODE}"
        pushd src/docker

            gedit ansible-client/Dockerfile &

            -   FROM aglais/fedora:2019.08.06
            +   FROM aglais/openstack-client:2019.08.06

        popd
    popd


# -----------------------------------------------------
# Build our Docker images.
#[user@desktop]

    buildtag=$(date +'%Y.%m.%d')

    source "${HOME}/aglais.settings"

    pushd  "${AGLAIS_CODE}"
        pushd src/docker

            export buildtag
            docker-compose \
                --file images.yml \
                build

        popd
    popd

    >   Building fedora
    >   Step 1/9 : FROM fedora@sha256:d39a02a0f13c1df3bbcb0ccea4021c53b8e0bfd87f701a5115e18ec089814e70
    >   ....
    >   ....

# -----------------------------------------------------
# Create a container running as root.
#[user@desktop]

    docker run \
        --rm \
        --tty \
        --interactive \
        --hostname ansible \
        --env SSH_AUTH_SOCK=/tmp/ssh_auth_sock \
        --volume "${SSH_AUTH_SOCK}:/tmp/ssh_auth_sock" \
        --volume "${HOME}/cumulus.settings:/etc/aglais/cumulus.settings" \
        --volume "${HOME}/.ssh/cumulus.cam.ac.uk.rsa.pub:/tmp/cumulus.cam.ac.uk.rsa.pub" \
        --volume "${AGLAIS_CODE}/src/ansible:/var/local/aglais/ansible" \
        aglais/ansible-client:${buildtag:?} \
        bash


    >   ....

# -----------------------------------------------------
# Load our OpenStack settings.
#[root@ansible]

    source '/etc/aglais/cumulus.settings'

# -----------------------------------------------------
# Create our clouds YAML file.
# https://docs.openstack.org/python-openstackclient/latest/configuration/index.html#clouds-yaml
#[root@ansible]

    # clouds.yaml is a configuration file that contains everything needed to connect to one or more clouds.
    # It may contain private information and is generally considered private to a user.

    # Move this outside the container ?
    # Out it in our home directory and mnount as a volume ?

cat > ${HOME}/clouds.yaml << EOF

clouds:
  iris-gaia:
    cloud: cumulus
      auth:
        auth_url: ${OS_AUTH_URL:?}
        auth_type: ${OS_AUTH_TYPE:?}
        application_credential_id: ${OS_APPLICATION_CREDENTIAL_ID:?}
        application_credential_secret: ${OS_APPLICATION_CREDENTIAL_SECRET:?}
      region_name: ${OS_REGION_NAME:?}
      interface: ${OS_INTERFACE:?}
      identity_api_version: ${OS_IDENTITY_API_VERSION:?}
EOF


# -----------------------------------------------------
# Create a playbook to create our OpenStack keypair.
# https://docs.ansible.com/ansible/latest/modules/list_of_cloud_modules.html#openstack
#[root@ansible]

    cat > "/tmp/01-create-keypair.yml" << EOF
---
- name: Deploy a ssh keypair
  hosts: localhost
  tasks:
    - name: create keypair
      os_keypair:
        cloud: cumulus
        state: present
        name: 'cumulus-cam-ac-uk-rsa'
        public_key_file: '/tmp/cumulus.cam.ac.uk.rsa.pub'
        wait: yes

EOF

# -----------------------------------------------------
# Run our playbook ...
#[root@ansible]

    ansible-playbook "/tmp/01-create-keypair.yml"

    >   PLAY [Deploy a ssh keypair] ********************************************************************
    >   
    >   TASK [Gathering Facts] *************************************************************************
    >   ok: [localhost]
    >   
    >   TASK [create keypair] **************************************************************************
    >   fatal: [localhost]: FAILED! => {"changed": false, "msg": "Cloud cumulus was not found."}
    >   
    >   PLAY RECAP *************************************************************************************
    >   localhost: ok=1    changed=0    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0


# -----------------------------------------------------
# Move our config file ..
#[root@ansible]

    mkdir "${HOME}/.config"
    mkdir "${HOME}/.config/openstack"

    mv "${HOME}/clouds.yaml" \
       "${HOME}/.config/openstack"


# -----------------------------------------------------
# Run our playbook ...
#[root@ansible]

    ansible-playbook "/tmp/01-create-keypair.yml"

    >   PLAY [Deploy a ssh keypair] ********************************************************************
    >   
    >   TASK [Gathering Facts] *************************************************************************
    >   ok: [localhost]
    >   
    >   TASK [create keypair] **************************************************************************
    >   fatal: [localhost]: FAILED! => {
    >       "changed": false,
    >       "module_stderr": "/root/.ansible/tmp/ansible-tmp-1565112520.0395522-163113690827807/AnsiballZ_os_keypair.py:18:
    >           DeprecationWarning: the imp module is deprecated in favour of importlib; see the module's documentation for alternative uses
    >               import imp
    >           Traceback (most recent call last):
    >               ....
    >               ....
    >               self.get_mark())
    >   yaml.scanner.ScannerError: mapping values are not allowed here
    >               in \"/root/.config/openstack/clouds.yaml\", line 5, column 11"
    >   
    >   
    >   PLAY RECAP *************************************************************************************
    >   localhost: ok=1    changed=0    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0

# -----------------------------------------------------
# Edit our config file ...
#[root@ansible]

    vi ${HOME}/.config/openstack/clouds.yaml

        clouds:
    -     iris-gaia:
    -       cloud: cumulus
    +     cumulus:
              auth:
                auth_url: https://cumulus.openstack.hpc.cam.ac.uk:5000/v3
                auth_type: v3applicationcredential
                application_credential_id: ################
                application_credential_secret: ################
              region_name: RegionOne
              interface: public
              identity_api_version: 3

# -----------------------------------------------------
# Run our playbook ...
#[root@ansible]

    ansible-playbook "/tmp/01-create-keypair.yml"

    >   PLAY [Deploy a ssh keypair] ********************************************************************
    >   
    >   TASK [Gathering Facts] *************************************************************************
    >   ok: [localhost]
    >   
    >   TASK [create keypair] **************************************************************************
    >   fatal: [localhost]: FAILED! => {
    >       "changed": false,
    >       "module_stderr": "/root/.ansible/tmp/ansible-tmp-1565113046.9420643-67303553783106/AnsiballZ_os_keypair.py:18:
    >           DeprecationWarning: the imp module is deprecated in favour of importlib; see the module's documentation for alternative uses
    >               import imp
    >           Traceback (most recent call last):
    >               ....
    >               ....
    >           TypeError: __init__() got an unexpected keyword argument 'auth_type'
    >               ....
    >   
    >   
    >   PLAY RECAP *************************************************************************************
    >   localhost: ok=1    changed=0    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0


# -----------------------------------------------------
# Edit our config file ...
#[root@ansible]

    vi ${HOME}/.config/openstack/clouds.yaml

        clouds:
          cumulus:
              auth:
                auth_url: https://cumulus.openstack.hpc.cam.ac.uk:5000/v3
    -           auth_type: v3applicationcredential
                application_credential_id: ################
                application_credential_secret: ################
              region_name: RegionOne
              interface: public
              identity_api_version: 3


# -----------------------------------------------------
# Run our playbook ...
#[root@ansible]

    ansible-playbook "/tmp/01-create-keypair.yml"


    >   PLAY [Deploy a ssh keypair] ********************************************************************
    >   
    >   TASK [Gathering Facts] *************************************************************************
    >   ok: [localhost]
    >   
    >   TASK [create keypair] **************************************************************************
    >   fatal: [localhost]: FAILED! => {
    >       "changed": false,
    >       "module_stderr": "/root/.ansible/tmp/ansible-tmp-1565113372.787666-174726761465633/AnsiballZ_os_keypair.py:18:
    >           DeprecationWarning: the imp module is deprecated in favour of importlib; see the module's documentation for alternative uses
    >               import imp
    >           Traceback (most recent call last):
    >               ....
    >               ....
    >           TypeError: __init__() got an unexpected keyword argument 'application_credential_id'
    >               ....
    >   
    >   PLAY RECAP *************************************************************************************
    >   localhost: ok=1    changed=0    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0


# -----------------------------------------------------
# Edit our config file ...
#[root@ansible]

    # https://docs.openstack.org/python-openstackclient/latest/cli/man/openstack.html#manpage
    # https://docs.openstack.org/python-openstackclient/latest/configuration/index.html#clouds-yaml
    # http://jaormx.github.io/2018/spawning-your-first-instance-with-ansible/

    vi ${HOME}/.config/openstack/clouds.yaml

        clouds:
          cumulus:
            auth:
              auth_url: "https://cumulus.openstack.hpc.cam.ac.uk:5000/v3"
              application_credential_id: "################"
              application_credential_secret: "################"
            region_name: "RegionOne"
            interface: "public"
            identity_api_version: 3
            auth_type: "v3applicationcredential"


# -----------------------------------------------------
# Run our playbook ...
#[root@ansible]

    ansible-playbook "/tmp/01-create-keypair.yml"

    >   PLAY [Deploy a ssh keypair] ********************************************************************
    >   
    >   TASK [Gathering Facts] *************************************************************************
    >   ok: [localhost]
    >   
    >   TASK [create keypair] **************************************************************************
    >   changed: [localhost]
    >   
    >   PLAY RECAP *************************************************************************************
    >   localhost: ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

    #
    # Works !! :-D
    #


# -----------------------------------------------------
# Create a playbook to create a security group
# https://docs.ansible.com/ansible/latest/modules/list_of_cloud_modules.html#openstack
#[root@ansible]

    cat > "/tmp/02-create-security.yml" << EOF

- name: Create a security group
  hosts: localhost
  tasks:
    - name: create security group
      os_security_group:
        cloud: cumulus
        state: present
        name: 'public-access'

    - name: create security group rule for SSH
      os_security_group_rule:
        cloud: cumulus
        state: present
        security_group: 'public-access'
        direction: 'ingress'
        protocol:  'tcp'
        ethertype: 'IPv4'
        port_range_min: 22
        port_range_max: 22
        remote_ip_prefix: '0.0.0.0/0'

    - name: create security group rule for SSH
      os_security_group_rule:
        cloud: cumulus
        state: present
        security_group: 'public-access'
        direction: 'ingress'
        protocol:  'tcp'
        ethertype: 'IPv6'
        port_range_min: 22
        port_range_max: 22
        remote_ip_prefix: '::/0'

EOF

# -----------------------------------------------------
# Run our playbook ...
#[root@ansible]

    ansible-playbook "/tmp/02-create-security.yml"

    >   PLAY [Create a security group] *****************************************************************
    >   
    >   TASK [Gathering Facts] *************************************************************************
    >   ok: [localhost]
    >   
    >   TASK [create security group] *******************************************************************
    >   changed: [localhost]
    >   
    >   TASK [create security group rule for SSH] ******************************************************
    >   changed: [localhost]
    >   
    >   TASK [create security group rule for SSH] ******************************************************
    >   changed: [localhost]
    >   
    >   PLAY RECAP *************************************************************************************
    >   localhost: ok=4    changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0


# -----------------------------------------------------
# Create an instance.
# https://docs.ansible.com/ansible/latest/modules/list_of_cloud_modules.html#openstack
#[root@ansible]

    cat > "/tmp/03-create-instance.yml" << EOF

- name: Create a server instance
  hosts: localhost
  tasks:
    - name: create instance
      os_server:
        cloud: cumulus
        state: present
        name:  '$(date)'
        image: 'Fedora-30-1.2'
        flavor: 'general.v1.small'
        network: 'cumulus-internal'
        key_name: 'cumulus-cam-ac-uk-rsa'
        security_groups: 'public-access'
        auto_ip: yes
      register:
        'node-one'

EOF

# -----------------------------------------------------
# Run our playbook ...
#[root@ansible]

    ansible-playbook "/tmp/03-create-instance.yml"

    >   PLAY [Create a server instance] ****************************************************************
    >   
    >   TASK [Gathering Facts] *************************************************************************
    >   ok: [localhost]
    >   
    >   TASK [create instance] *************************************************************************
    >   changed: [localhost]
    >   
    >   PLAY RECAP *************************************************************************************
    >   localhost: ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0


    #
    # Networking is mildly broken.
    # Both fixed and floating addresses are on the 10.0.0.0 network.
    # Security group not in the right place.
    #


# -----------------------------------------------------
# Create an instance.
# https://docs.ansible.com/ansible/latest/modules/list_of_cloud_modules.html#openstack
#[root@ansible]

    cat > "/tmp/03-create-instance.yml" << EOF

- name: Create a server instance
  hosts: localhost
  tasks:
    - name: create instance
      os_server:
        cloud: cumulus
        state: present
        name:  '$(date)'
        image: 'Fedora-30-1.2'
        flavor: 'general.v1.small'
        network: 'cumulus-internal'
        key_name: 'cumulus-cam-ac-uk-rsa'
        auto_ip: no
      register:
        instance

    - debug:
        var: instance

    - debug:
        var: instance.id

EOF

# -----------------------------------------------------
# Run our playbook ...
#[root@ansible]

    ansible-playbook "/tmp/03-create-instance.yml"

    >   PLAY [Create a server instance] ****************************************************************
    >   
    >   TASK [Gathering Facts] *************************************************************************
    >   ok: [localhost]
    >   
    >   TASK [create instance] *************************************************************************
    >   changed: [localhost]
    >   
    >   TASK [debug] ***********************************************************************************
    >   ok: [localhost] => {
    >       "instance": {
    >           "changed": true,
    >           "failed": false,
    >           "id": "5a4cdec0-171c-4608-b2a0-adc803da6c54",
    >           "openstack": {
    >               "OS-DCF:diskConfig": "MANUAL",
    >               "OS-EXT-AZ:availability_zone": "nova",
    >               "OS-EXT-STS:power_state": 1,
    >               "OS-EXT-STS:task_state": null,
    >               "OS-EXT-STS:vm_state": "active",
    >               "OS-SRV-USG:launched_at": "2019-08-07T03:35:40.000000",
    >               "OS-SRV-USG:terminated_at": null,
    >               "accessIPv4": "",
    >               "accessIPv6": "",
    >               "addresses": {
    >                   "cumulus-internal": [
    >                       {
    >                           "OS-EXT-IPS-MAC:mac_addr": "fa:16:3e:0a:ed:9c",
    >                           "OS-EXT-IPS:type": "fixed",
    >                           "addr": "10.218.1.4",
    >                           "version": 4
    >                       }
    >                   ]
    >               },
    >               "adminPass": "pwMS23ke9wiH",
    >               "az": "nova",
    >               "cloud": "cumulus",
    >               "config_drive": "",
    >               "created": "2019-08-07T03:35:05Z",
    >               "disk_config": "MANUAL",
    >               "flavor": {
    >                   "id": "20061eba-9e88-494c-95a3-41ed77721244",
    >                   "name": "general.v1.small"
    >               },
    >               "has_config_drive": false,
    >               "hostId": "b1ba3949dcc565d98633faddb39946d8509b4dff58db4c0929c93bea",
    >               "host_id": "b1ba3949dcc565d98633faddb39946d8509b4dff58db4c0929c93bea",
    >               "id": "5a4cdec0-171c-4608-b2a0-adc803da6c54",
    >               "image": {
    >                   "id": "ade3a5aa-a6a3-4761-8eed-083e5ce1f117",
    >                   "name": "Fedora-30-1.2"
    >               },
    >               "interface_ip": "",
    >               "key_name": "cumulus-cam-ac-uk-rsa",
    >               "launched_at": "2019-08-07T03:35:40.000000",
    >               "location": {
    >                   "cloud": "cumulus",
    >                   "project": {
    >                       "domain_id": null,
    >                       "domain_name": null,
    >                       "id": "08e24c6d87f94740aa59c172462ed927",
    >                       "name": null
    >                   },
    >                   "region_name": "RegionOne",
    >                   "zone": "nova"
    >               },
    >               "metadata": {},
    >               "name": "Wed Aug  7 03:34:55 UTC 2019",
    >               "networks": {},
    >               "os-extended-volumes:volumes_attached": [],
    >               "power_state": 1,
    >               "private_v4": "10.218.1.4",
    >               "progress": 0,
    >               "project_id": "08e24c6d87f94740aa59c172462ed927",
    >               "properties": {
    >                   "OS-DCF:diskConfig": "MANUAL",
    >                   "OS-EXT-AZ:availability_zone": "nova",
    >                   "OS-EXT-STS:power_state": 1,
    >                   "OS-EXT-STS:task_state": null,
    >                   "OS-EXT-STS:vm_state": "active",
    >                   "OS-SRV-USG:launched_at": "2019-08-07T03:35:40.000000",
    >                   "OS-SRV-USG:terminated_at": null,
    >                   "os-extended-volumes:volumes_attached": []
    >               },
    >               "public_v4": "",
    >               "public_v6": "",
    >               "region": "RegionOne",
    >               "security_groups": [
    >                   {
    >                       "description": "Default security group",
    >                       "id": "d917cfec-af58-4ee0-8730-62867d79a323",
    >                       "location": {
    >                           "cloud": "cumulus",
    >                           "project": {
    >                               "domain_id": null,
    >                               "domain_name": null,
    >                               "id": "08e24c6d87f94740aa59c172462ed927",
    >                               "name": null
    >                           },
    >                           "region_name": "RegionOne",
    >                           "zone": null
    >                       },
    >                       "name": "default",
    >                       "project_id": "08e24c6d87f94740aa59c172462ed927",
    >                       "properties": {},
    >                       "security_group_rules": [
    >                           {
    >                               "direction": "ingress",
    >                               "ethertype": "IPv4",
    >                               "group": {
    >                                   "name": "default",
    >                                   "tenant_id": "08e24c6d87f94740aa59c172462ed927"
    >                               },
    >                               "id": "872936f4-f84a-468e-b460-133c146900d2",
    >                               "location": {
    >                                   "cloud": "cumulus",
    >                                   "project": {
    >                                       "domain_id": null,
    >                                       "domain_name": null,
    >                                       "id": "08e24c6d87f94740aa59c172462ed927",
    >                                       "name": null
    >                                   },
    >                                   "region_name": "RegionOne",
    >                                   "zone": null
    >                               },
    >                               "port_range_max": null,
    >                               "port_range_min": null,
    >                               "project_id": "",
    >                               "properties": {
    >                                   "group": {
    >                                       "name": "default",
    >                                       "tenant_id": "08e24c6d87f94740aa59c172462ed927"
    >                                   }
    >                               },
    >                               "protocol": null,
    >                               "remote_group_id": null,
    >                               "remote_ip_prefix": null,
    >                               "security_group_id": "d917cfec-af58-4ee0-8730-62867d79a323",
    >                               "tenant_id": ""
    >                           },
    >                           {
    >                               "direction": "ingress",
    >                               "ethertype": "IPv4",
    >                               "group": {
    >                                   "name": "default",
    >                                   "tenant_id": "08e24c6d87f94740aa59c172462ed927"
    >                               },
    >                               "id": "a3da14c5-8251-40f1-95fb-abef1bf7a38c",
    >                               "location": {
    >                                   "cloud": "cumulus",
    >                                   "project": {
    >                                       "domain_id": null,
    >                                       "domain_name": null,
    >                                       "id": "08e24c6d87f94740aa59c172462ed927",
    >                                       "name": null
    >                                   },
    >                                   "region_name": "RegionOne",
    >                                   "zone": null
    >                               },
    >                               "port_range_max": null,
    >                               "port_range_min": null,
    >                               "project_id": "",
    >                               "properties": {
    >                                   "group": {
    >                                       "name": "default",
    >                                       "tenant_id": "08e24c6d87f94740aa59c172462ed927"
    >                                   }
    >                               },
    >                               "protocol": null,
    >                               "remote_group_id": null,
    >                               "remote_ip_prefix": null,
    >                               "security_group_id": "d917cfec-af58-4ee0-8730-62867d79a323",
    >                               "tenant_id": ""
    >                           }
    >                       ],
    >                       "tenant_id": "08e24c6d87f94740aa59c172462ed927"
    >                   }
    >               ],
    >               "status": "ACTIVE",
    >               "task_state": null,
    >               "tenant_id": "08e24c6d87f94740aa59c172462ed927",
    >               "terminated_at": null,
    >               "updated": "2019-08-07T03:35:40Z",
    >               "user_id": "98169f87de174ad4ac98c32e59646488",
    >               "vm_state": "active",
    >               "volumes": []
    >           },
    >           "server": {
    >               "OS-DCF:diskConfig": "MANUAL",
    >               "OS-EXT-AZ:availability_zone": "nova",
    >               "OS-EXT-STS:power_state": 1,
    >               "OS-EXT-STS:task_state": null,
    >               "OS-EXT-STS:vm_state": "active",
    >               "OS-SRV-USG:launched_at": "2019-08-07T03:35:40.000000",
    >               "OS-SRV-USG:terminated_at": null,
    >               "accessIPv4": "",
    >               "accessIPv6": "",
    >               "addresses": {
    >                   "cumulus-internal": [
    >                       {
    >                           "OS-EXT-IPS-MAC:mac_addr": "fa:16:3e:0a:ed:9c",
    >                           "OS-EXT-IPS:type": "fixed",
    >                           "addr": "10.218.1.4",
    >                           "version": 4
    >                       }
    >                   ]
    >               },
    >               "adminPass": "pwMS23ke9wiH",
    >               "az": "nova",
    >               "cloud": "cumulus",
    >               "config_drive": "",
    >               "created": "2019-08-07T03:35:05Z",
    >               "disk_config": "MANUAL",
    >               "flavor": {
    >                   "id": "20061eba-9e88-494c-95a3-41ed77721244",
    >                   "name": "general.v1.small"
    >               },
    >               "has_config_drive": false,
    >               "hostId": "b1ba3949dcc565d98633faddb39946d8509b4dff58db4c0929c93bea",
    >               "host_id": "b1ba3949dcc565d98633faddb39946d8509b4dff58db4c0929c93bea",
    >               "id": "5a4cdec0-171c-4608-b2a0-adc803da6c54",
    >               "image": {
    >                   "id": "ade3a5aa-a6a3-4761-8eed-083e5ce1f117",
    >                   "name": "Fedora-30-1.2"
    >               },
    >               "interface_ip": "",
    >               "key_name": "cumulus-cam-ac-uk-rsa",
    >               "launched_at": "2019-08-07T03:35:40.000000",
    >               "location": {
    >                   "cloud": "cumulus",
    >                   "project": {
    >                       "domain_id": null,
    >                       "domain_name": null,
    >                       "id": "08e24c6d87f94740aa59c172462ed927",
    >                       "name": null
    >                   },
    >                   "region_name": "RegionOne",
    >                   "zone": "nova"
    >               },
    >               "metadata": {},
    >               "name": "Wed Aug  7 03:34:55 UTC 2019",
    >               "networks": {},
    >               "os-extended-volumes:volumes_attached": [],
    >               "power_state": 1,
    >               "private_v4": "10.218.1.4",
    >               "progress": 0,
    >               "project_id": "08e24c6d87f94740aa59c172462ed927",
    >               "properties": {
    >                   "OS-DCF:diskConfig": "MANUAL",
    >                   "OS-EXT-AZ:availability_zone": "nova",
    >                   "OS-EXT-STS:power_state": 1,
    >                   "OS-EXT-STS:task_state": null,
    >                   "OS-EXT-STS:vm_state": "active",
    >                   "OS-SRV-USG:launched_at": "2019-08-07T03:35:40.000000",
    >                   "OS-SRV-USG:terminated_at": null,
    >                   "os-extended-volumes:volumes_attached": []
    >               },
    >               "public_v4": "",
    >               "public_v6": "",
    >               "region": "RegionOne",
    >               "security_groups": [
    >                   {
    >                       "description": "Default security group",
    >                       "id": "d917cfec-af58-4ee0-8730-62867d79a323",
    >                       "location": {
    >                           "cloud": "cumulus",
    >                           "project": {
    >                               "domain_id": null,
    >                               "domain_name": null,
    >                               "id": "08e24c6d87f94740aa59c172462ed927",
    >                               "name": null
    >                           },
    >                           "region_name": "RegionOne",
    >                           "zone": null
    >                       },
    >                       "name": "default",
    >                       "project_id": "08e24c6d87f94740aa59c172462ed927",
    >                       "properties": {},
    >                       "security_group_rules": [
    >                           {
    >                               "direction": "ingress",
    >                               "ethertype": "IPv4",
    >                               "group": {
    >                                   "name": "default",
    >                                   "tenant_id": "08e24c6d87f94740aa59c172462ed927"
    >                               },
    >                               "id": "872936f4-f84a-468e-b460-133c146900d2",
    >                               "location": {
    >                                   "cloud": "cumulus",
    >                                   "project": {
    >                                       "domain_id": null,
    >                                       "domain_name": null,
    >                                       "id": "08e24c6d87f94740aa59c172462ed927",
    >                                       "name": null
    >                                   },
    >                                   "region_name": "RegionOne",
    >                                   "zone": null
    >                               },
    >                               "port_range_max": null,
    >                               "port_range_min": null,
    >                               "project_id": "",
    >                               "properties": {
    >                                   "group": {
    >                                       "name": "default",
    >                                       "tenant_id": "08e24c6d87f94740aa59c172462ed927"
    >                                   }
    >                               },
    >                               "protocol": null,
    >                               "remote_group_id": null,
    >                               "remote_ip_prefix": null,
    >                               "security_group_id": "d917cfec-af58-4ee0-8730-62867d79a323",
    >                               "tenant_id": ""
    >                           },
    >                           {
    >                               "direction": "ingress",
    >                               "ethertype": "IPv4",
    >                               "group": {
    >                                   "name": "default",
    >                                   "tenant_id": "08e24c6d87f94740aa59c172462ed927"
    >                               },
    >                               "id": "a3da14c5-8251-40f1-95fb-abef1bf7a38c",
    >                               "location": {
    >                                   "cloud": "cumulus",
    >                                   "project": {
    >                                       "domain_id": null,
    >                                       "domain_name": null,
    >                                       "id": "08e24c6d87f94740aa59c172462ed927",
    >                                       "name": null
    >                                   },
    >                                   "region_name": "RegionOne",
    >                                   "zone": null
    >                               },
    >                               "port_range_max": null,
    >                               "port_range_min": null,
    >                               "project_id": "",
    >                               "properties": {
    >                                   "group": {
    >                                       "name": "default",
    >                                       "tenant_id": "08e24c6d87f94740aa59c172462ed927"
    >                                   }
    >                               },
    >                               "protocol": null,
    >                               "remote_group_id": null,
    >                               "remote_ip_prefix": null,
    >                               "security_group_id": "d917cfec-af58-4ee0-8730-62867d79a323",
    >                               "tenant_id": ""
    >                           }
    >                       ],
    >                       "tenant_id": "08e24c6d87f94740aa59c172462ed927"
    >                   }
    >               ],
    >               "status": "ACTIVE",
    >               "task_state": null,
    >               "tenant_id": "08e24c6d87f94740aa59c172462ed927",
    >               "terminated_at": null,
    >               "updated": "2019-08-07T03:35:40Z",
    >               "user_id": "98169f87de174ad4ac98c32e59646488",
    >               "vm_state": "active",
    >               "volumes": []
    >           }
    >       }
    >   }
    >   
    >   TASK [debug] ***********************************************************************************
    >   ok: [localhost] => {
    >       "instance.id": "5a4cdec0-171c-4608-b2a0-adc803da6c54"
    >   }
    >   
    >   PLAY RECAP *************************************************************************************
    >   localhost: ok=4    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0



# -----------------------------------------------------
# Create an instance and add a public IP address.
# https://docs.ansible.com/ansible/latest/modules/list_of_cloud_modules.html#openstack
#[root@ansible]

    cat > "/tmp/04-create-instance.yml" << EOF

- name: Create a server instance
  hosts: localhost
  tasks:
    - name: create instance
      os_server:
        cloud: 'cumulus'
        state: present
        name:  '$(date)'
        image: 'Fedora-30-1.2'
        flavor: 'general.v1.small'
        network: 'cumulus-internal'
        key_name: 'cumulus-cam-ac-uk-rsa'
        auto_ip: no
      register:
        instance

    - debug:
        var: instance.id

    - name: create floating
      os_floating_ip:
        cloud: 'cumulus'
        state: present
        server: '{{ instance.id }}'
        network: 'internet'
        nat_destination: 'cumulus-internal'
      register:
        floating

    - debug:
        var: floating

EOF

# -----------------------------------------------------
# Run our playbook ...
#[root@ansible]

    ansible-playbook "/tmp/04-create-instance.yml"

    >   PLAY [Create a server instance] ****************************************************************
    >   
    >   TASK [Gathering Facts] *************************************************************************
    >   ok: [localhost]
    >   
    >   TASK [create instance] *************************************************************************
    >   changed: [localhost]
    >   
    >   TASK [debug] ***********************************************************************************
    >   ok: [localhost] => {
    >       "instance.id": "636e432c-8f75-437c-a722-283291505c73"
    >   }
    >   
    >   TASK [create floating] *************************************************************************
    >   changed: [localhost]
    >   
    >   TASK [debug] ***********************************************************************************
    >   ok: [localhost] => {
    >       "floating": {
    >           "changed": true,
    >           "failed": false,
    >           "floating_ip": {
    >               "attached": true,
    >               "created_at": "2019-08-07T04:17:00Z",
    >               "description": "",
    >               "fixed_ip_address": "10.218.1.8",
    >               "floating_ip_address": "128.232.224.73",
    >               "floating_network_id": "a929e8db-1bf4-4a5f-a80c-fabd39d06a26",
    >               "id": "c60accf1-124e-4f57-9bfb-53b7932b1be7",
    >               "location": {
    >                   "cloud": "cumulus",
    >                   "project": {
    >                       "domain_id": null,
    >                       "domain_name": null,
    >                       "id": "08e24c6d87f94740aa59c172462ed927",
    >                       "name": null
    >                   },
    >                   "region_name": "RegionOne",
    >                   "zone": null
    >               },
    >               "network": "a929e8db-1bf4-4a5f-a80c-fabd39d06a26",
    >               "port": "338289a0-3f95-4351-884d-180851af1e15",
    >               "port_details": {
    >                   "admin_state_up": true,
    >                   "device_id": "636e432c-8f75-437c-a722-283291505c73",
    >                   "device_owner": "compute:nova",
    >                   "mac_address": "fa:16:3e:c1:aa:e7",
    >                   "name": "",
    >                   "network_id": "ecb791d5-1022-447a-a79c-8f38a0f5c990",
    >                   "status": "ACTIVE"
    >               },
    >               "port_id": "338289a0-3f95-4351-884d-180851af1e15",
    >               "project_id": "08e24c6d87f94740aa59c172462ed927",
    >               "properties": {
    >                   "port_details": {
    >                       "admin_state_up": true,
    >                       "device_id": "636e432c-8f75-437c-a722-283291505c73",
    >                       "device_owner": "compute:nova",
    >                       "mac_address": "fa:16:3e:c1:aa:e7",
    >                       "name": "",
    >                       "network_id": "ecb791d5-1022-447a-a79c-8f38a0f5c990",
    >                       "status": "ACTIVE"
    >                   },
    >                   "tags": []
    >               },
    >               "revision_number": 0,
    >               "router": "88ec6e37-f6fa-421f-89ea-f2400c1c523a",
    >               "router_id": "88ec6e37-f6fa-421f-89ea-f2400c1c523a",
    >               "status": "DOWN",
    >               "tags": [],
    >               "tenant_id": "08e24c6d87f94740aa59c172462ed927",
    >               "updated_at": "2019-08-07T04:17:00Z"
    >           }
    >       }
    >   }
    >   
    >   PLAY RECAP *************************************************************************************
    >   localhost: ok=5    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0



# -----------------------------------------------------
# Create an instance and add a public IP address.
# https://docs.ansible.com/ansible/latest/modules/list_of_cloud_modules.html#openstack
#[root@ansible]

    cat > "/tmp/05-create-instance.yml" << EOF

- name: Create a server instance
  hosts: localhost
  tasks:
    - name: create instance
      os_server:
        cloud: 'cumulus'
        state: present
        name:  '$(date)'
        image: 'Fedora-30-1.2'
        flavor: 'general.v1.small'
        network: 'cumulus-internal'
        key_name: 'cumulus-cam-ac-uk-rsa'
        auto_ip: no
      register:
        instance

    - debug:
        var: instance.id

    - name: create floating
      os_floating_ip:
        cloud: 'cumulus'
        state: present
        server: '{{ instance.id }}'
        network: 'internet'
        nat_destination: 'cumulus-internal'
      register:
        floating

    - name: create security group
      os_security_group:
        cloud: cumulus
        state: present
        name: 'public-access'
      register:
        public_access

    - name: create security group rule for SSH
      os_security_group_rule:
        cloud: cumulus
        state: present
        security_group: 'public-access'
        direction: 'ingress'
        protocol:  'tcp'
        ethertype: 'IPv4'
        port_range_min: 22
        port_range_max: 22
        remote_ip_prefix: '0.0.0.0/0'

    - name: create security group rule for SSH
      os_security_group_rule:
        cloud: cumulus
        state: present
        security_group: 'public-access'
        direction: 'ingress'
        protocol:  'tcp'
        ethertype: 'IPv6'
        port_range_min: 22
        port_range_max: 22
        remote_ip_prefix: '::/0'

    - os_port:
        state: present
        name: '{{ floating.floating_ip.port }}'
        security_groups:
          - '{{ public_access.id }}'

    - debug:
        var: floating.floating_ip.floating_ip_address

    - debug:
        var: instance

EOF

# -----------------------------------------------------
# Run our playbook ...
#[root@ansible]

    ansible-playbook "/tmp/05-create-instance.yml"

    >   PLAY [Create a server instance] ****************************************************************
    >   
    >   TASK [Gathering Facts] *************************************************************************
    >   ok: [localhost]
    >   
    >   TASK [create instance] *************************************************************************
    >   changed: [localhost]
    >   
    >   TASK [debug] ***********************************************************************************
    >   ok: [localhost] => {
    >       "instance.id": "96ac2938-9a11-4a81-85fe-b91023f50c38"
    >   }
    >   
    >   TASK [create floating] *************************************************************************
    >   changed: [localhost]
    >   
    >   TASK [create security group] *******************************************************************
    >   ok: [localhost]
    >   
    >   TASK [create security group rule for SSH] ******************************************************
    >   ok: [localhost]
    >   
    >   TASK [create security group rule for SSH] ******************************************************
    >   ok: [localhost]
    >   
    >   TASK [os_port] *********************************************************************************
    >   changed: [localhost]
    >   
    >   TASK [debug] ***********************************************************************************
    >   ok: [localhost] => {
    >       "floating.floating_ip.floating_ip_address": "128.232.224.74"
    >   }
    >   
    >   TASK [debug] ***********************************************************************************
    >   ok: [localhost] => {
    >       "instance": {
    >           "changed": true,
    >           "failed": false,
    >           "id": "96ac2938-9a11-4a81-85fe-b91023f50c38",
    >           "openstack": {
    >               "OS-DCF:diskConfig": "MANUAL",
    >               "OS-EXT-AZ:availability_zone": "nova",
    >               "OS-EXT-STS:power_state": 1,
    >               "OS-EXT-STS:task_state": null,
    >               "OS-EXT-STS:vm_state": "active",
    >               "OS-SRV-USG:launched_at": "2019-08-07T04:42:25.000000",
    >               "OS-SRV-USG:terminated_at": null,
    >               "accessIPv4": "",
    >               "accessIPv6": "",
    >               "addresses": {
    >                   "cumulus-internal": [
    >                       {
    >                           "OS-EXT-IPS-MAC:mac_addr": "fa:16:3e:17:1a:f1",
    >                           "OS-EXT-IPS:type": "fixed",
    >                           "addr": "10.218.1.23",
    >                           "version": 4
    >                       }
    >                   ]
    >               },
    >               "adminPass": "P8niaakQ5VqT",
    >               "az": "nova",
    >               "cloud": "cumulus",
    >               "config_drive": "",
    >               "created": "2019-08-07T04:41:55Z",
    >               "disk_config": "MANUAL",
    >               "flavor": {
    >                   "id": "20061eba-9e88-494c-95a3-41ed77721244",
    >                   "name": "general.v1.small"
    >               },
    >               "has_config_drive": false,
    >               "hostId": "cd41c18e5a01e7cda831219c0798120e8d200c1267bbd3290899364e",
    >               "host_id": "cd41c18e5a01e7cda831219c0798120e8d200c1267bbd3290899364e",
    >               "id": "96ac2938-9a11-4a81-85fe-b91023f50c38",
    >               "image": {
    >                   "id": "ade3a5aa-a6a3-4761-8eed-083e5ce1f117",
    >                   "name": "Fedora-30-1.2"
    >               },
    >               "interface_ip": "",
    >               "key_name": "cumulus-cam-ac-uk-rsa",
    >               "launched_at": "2019-08-07T04:42:25.000000",
    >               "location": {
    >                   "cloud": "cumulus",
    >                   "project": {
    >                       "domain_id": null,
    >                       "domain_name": null,
    >                       "id": "08e24c6d87f94740aa59c172462ed927",
    >                       "name": null
    >                   },
    >                   "region_name": "RegionOne",
    >                   "zone": "nova"
    >               },
    >               "metadata": {},
    >               "name": "Wed Aug  7 04:41:49 UTC 2019",
    >               "networks": {},
    >               "os-extended-volumes:volumes_attached": [],
    >               "power_state": 1,
    >               "private_v4": "10.218.1.23",
    >               "progress": 0,
    >               "project_id": "08e24c6d87f94740aa59c172462ed927",
    >               "properties": {
    >                   "OS-DCF:diskConfig": "MANUAL",
    >                   "OS-EXT-AZ:availability_zone": "nova",
    >                   "OS-EXT-STS:power_state": 1,
    >                   "OS-EXT-STS:task_state": null,
    >                   "OS-EXT-STS:vm_state": "active",
    >                   "OS-SRV-USG:launched_at": "2019-08-07T04:42:25.000000",
    >                   "OS-SRV-USG:terminated_at": null,
    >                   "os-extended-volumes:volumes_attached": []
    >               },
    >               "public_v4": "",
    >               "public_v6": "",
    >               "region": "RegionOne",
    >               "security_groups": [
    >                   {
    >                       "description": "Default security group",
    >                       "id": "d917cfec-af58-4ee0-8730-62867d79a323",
    >                       "location": {
    >                           "cloud": "cumulus",
    >                           "project": {
    >                               "domain_id": null,
    >                               "domain_name": null,
    >                               "id": "08e24c6d87f94740aa59c172462ed927",
    >                               "name": null
    >                           },
    >                           "region_name": "RegionOne",
    >                           "zone": null
    >                       },
    >                       "name": "default",
    >                       "project_id": "08e24c6d87f94740aa59c172462ed927",
    >                       "properties": {},
    >                       "security_group_rules": [
    >                           {
    >                               "direction": "ingress",
    >                               "ethertype": "IPv4",
    >                               "group": {
    >                                   "name": "default",
    >                                   "tenant_id": "08e24c6d87f94740aa59c172462ed927"
    >                               },
    >                               "id": "872936f4-f84a-468e-b460-133c146900d2",
    >                               "location": {
    >                                   "cloud": "cumulus",
    >                                   "project": {
    >                                       "domain_id": null,
    >                                       "domain_name": null,
    >                                       "id": "08e24c6d87f94740aa59c172462ed927",
    >                                       "name": null
    >                                   },
    >                                   "region_name": "RegionOne",
    >                                   "zone": null
    >                               },
    >                               "port_range_max": null,
    >                               "port_range_min": null,
    >                               "project_id": "",
    >                               "properties": {
    >                                   "group": {
    >                                       "name": "default",
    >                                       "tenant_id": "08e24c6d87f94740aa59c172462ed927"
    >                                   }
    >                               },
    >                               "protocol": null,
    >                               "remote_group_id": null,
    >                               "remote_ip_prefix": null,
    >                               "security_group_id": "d917cfec-af58-4ee0-8730-62867d79a323",
    >                               "tenant_id": ""
    >                           },
    >                           {
    >                               "direction": "ingress",
    >                               "ethertype": "IPv4",
    >                               "group": {
    >                                   "name": "default",
    >                                   "tenant_id": "08e24c6d87f94740aa59c172462ed927"
    >                               },
    >                               "id": "a3da14c5-8251-40f1-95fb-abef1bf7a38c",
    >                               "location": {
    >                                   "cloud": "cumulus",
    >                                   "project": {
    >                                       "domain_id": null,
    >                                       "domain_name": null,
    >                                       "id": "08e24c6d87f94740aa59c172462ed927",
    >                                       "name": null
    >                                   },
    >                                   "region_name": "RegionOne",
    >                                   "zone": null
    >                               },
    >                               "port_range_max": null,
    >                               "port_range_min": null,
    >                               "project_id": "",
    >                               "properties": {
    >                                   "group": {
    >                                       "name": "default",
    >                                       "tenant_id": "08e24c6d87f94740aa59c172462ed927"
    >                                   }
    >                               },
    >                               "protocol": null,
    >                               "remote_group_id": null,
    >                               "remote_ip_prefix": null,
    >                               "security_group_id": "d917cfec-af58-4ee0-8730-62867d79a323",
    >                               "tenant_id": ""
    >                           }
    >                       ],
    >                       "tenant_id": "08e24c6d87f94740aa59c172462ed927"
    >                   }
    >               ],
    >               "status": "ACTIVE",
    >               "task_state": null,
    >               "tenant_id": "08e24c6d87f94740aa59c172462ed927",
    >               "terminated_at": null,
    >               "updated": "2019-08-07T04:42:26Z",
    >               "user_id": "98169f87de174ad4ac98c32e59646488",
    >               "vm_state": "active",
    >               "volumes": []
    >           },
    >           "server": {
    >               "OS-DCF:diskConfig": "MANUAL",
    >               "OS-EXT-AZ:availability_zone": "nova",
    >               "OS-EXT-STS:power_state": 1,
    >               "OS-EXT-STS:task_state": null,
    >               "OS-EXT-STS:vm_state": "active",
    >               "OS-SRV-USG:launched_at": "2019-08-07T04:42:25.000000",
    >               "OS-SRV-USG:terminated_at": null,
    >               "accessIPv4": "",
    >               "accessIPv6": "",
    >               "addresses": {
    >                   "cumulus-internal": [
    >                       {
    >                           "OS-EXT-IPS-MAC:mac_addr": "fa:16:3e:17:1a:f1",
    >                           "OS-EXT-IPS:type": "fixed",
    >                           "addr": "10.218.1.23",
    >                           "version": 4
    >                       }
    >                   ]
    >               },
    >               "adminPass": "P8niaakQ5VqT",
    >               "az": "nova",
    >               "cloud": "cumulus",
    >               "config_drive": "",
    >               "created": "2019-08-07T04:41:55Z",
    >               "disk_config": "MANUAL",
    >               "flavor": {
    >                   "id": "20061eba-9e88-494c-95a3-41ed77721244",
    >                   "name": "general.v1.small"
    >               },
    >               "has_config_drive": false,
    >               "hostId": "cd41c18e5a01e7cda831219c0798120e8d200c1267bbd3290899364e",
    >               "host_id": "cd41c18e5a01e7cda831219c0798120e8d200c1267bbd3290899364e",
    >               "id": "96ac2938-9a11-4a81-85fe-b91023f50c38",
    >               "image": {
    >                   "id": "ade3a5aa-a6a3-4761-8eed-083e5ce1f117",
    >                   "name": "Fedora-30-1.2"
    >               },
    >               "interface_ip": "",
    >               "key_name": "cumulus-cam-ac-uk-rsa",
    >               "launched_at": "2019-08-07T04:42:25.000000",
    >               "location": {
    >                   "cloud": "cumulus",
    >                   "project": {
    >                       "domain_id": null,
    >                       "domain_name": null,
    >                       "id": "08e24c6d87f94740aa59c172462ed927",
    >                       "name": null
    >                   },
    >                   "region_name": "RegionOne",
    >                   "zone": "nova"
    >               },
    >               "metadata": {},
    >               "name": "Wed Aug  7 04:41:49 UTC 2019",
    >               "networks": {},
    >               "os-extended-volumes:volumes_attached": [],
    >               "power_state": 1,
    >               "private_v4": "10.218.1.23",
    >               "progress": 0,
    >               "project_id": "08e24c6d87f94740aa59c172462ed927",
    >               "properties": {
    >                   "OS-DCF:diskConfig": "MANUAL",
    >                   "OS-EXT-AZ:availability_zone": "nova",
    >                   "OS-EXT-STS:power_state": 1,
    >                   "OS-EXT-STS:task_state": null,
    >                   "OS-EXT-STS:vm_state": "active",
    >                   "OS-SRV-USG:launched_at": "2019-08-07T04:42:25.000000",
    >                   "OS-SRV-USG:terminated_at": null,
    >                   "os-extended-volumes:volumes_attached": []
    >               },
    >               "public_v4": "",
    >               "public_v6": "",
    >               "region": "RegionOne",
    >               "security_groups": [
    >                   {
    >                       "description": "Default security group",
    >                       "id": "d917cfec-af58-4ee0-8730-62867d79a323",
    >                       "location": {
    >                           "cloud": "cumulus",
    >                           "project": {
    >                               "domain_id": null,
    >                               "domain_name": null,
    >                               "id": "08e24c6d87f94740aa59c172462ed927",
    >                               "name": null
    >                           },
    >                           "region_name": "RegionOne",
    >                           "zone": null
    >                       },
    >                       "name": "default",
    >                       "project_id": "08e24c6d87f94740aa59c172462ed927",
    >                       "properties": {},
    >                       "security_group_rules": [
    >                           {
    >                               "direction": "ingress",
    >                               "ethertype": "IPv4",
    >                               "group": {
    >                                   "name": "default",
    >                                   "tenant_id": "08e24c6d87f94740aa59c172462ed927"
    >                               },
    >                               "id": "872936f4-f84a-468e-b460-133c146900d2",
    >                               "location": {
    >                                   "cloud": "cumulus",
    >                                   "project": {
    >                                       "domain_id": null,
    >                                       "domain_name": null,
    >                                       "id": "08e24c6d87f94740aa59c172462ed927",
    >                                       "name": null
    >                                   },
    >                                   "region_name": "RegionOne",
    >                                   "zone": null
    >                               },
    >                               "port_range_max": null,
    >                               "port_range_min": null,
    >                               "project_id": "",
    >                               "properties": {
    >                                   "group": {
    >                                       "name": "default",
    >                                       "tenant_id": "08e24c6d87f94740aa59c172462ed927"
    >                                   }
    >                               },
    >                               "protocol": null,
    >                               "remote_group_id": null,
    >                               "remote_ip_prefix": null,
    >                               "security_group_id": "d917cfec-af58-4ee0-8730-62867d79a323",
    >                               "tenant_id": ""
    >                           },
    >                           {
    >                               "direction": "ingress",
    >                               "ethertype": "IPv4",
    >                               "group": {
    >                                   "name": "default",
    >                                   "tenant_id": "08e24c6d87f94740aa59c172462ed927"
    >                               },
    >                               "id": "a3da14c5-8251-40f1-95fb-abef1bf7a38c",
    >                               "location": {
    >                                   "cloud": "cumulus",
    >                                   "project": {
    >                                       "domain_id": null,
    >                                       "domain_name": null,
    >                                       "id": "08e24c6d87f94740aa59c172462ed927",
    >                                       "name": null
    >                                   },
    >                                   "region_name": "RegionOne",
    >                                   "zone": null
    >                               },
    >                               "port_range_max": null,
    >                               "port_range_min": null,
    >                               "project_id": "",
    >                               "properties": {
    >                                   "group": {
    >                                       "name": "default",
    >                                       "tenant_id": "08e24c6d87f94740aa59c172462ed927"
    >                                   }
    >                               },
    >                               "protocol": null,
    >                               "remote_group_id": null,
    >                               "remote_ip_prefix": null,
    >                               "security_group_id": "d917cfec-af58-4ee0-8730-62867d79a323",
    >                               "tenant_id": ""
    >                           }
    >                       ],
    >                       "tenant_id": "08e24c6d87f94740aa59c172462ed927"
    >                   }
    >               ],
    >               "status": "ACTIVE",
    >               "task_state": null,
    >               "tenant_id": "08e24c6d87f94740aa59c172462ed927",
    >               "terminated_at": null,
    >               "updated": "2019-08-07T04:42:26Z",
    >               "user_id": "98169f87de174ad4ac98c32e59646488",
    >               "vm_state": "active",
    >               "volumes": []
    >           }
    >       }
    >   }
    >   
    >   PLAY RECAP *************************************************************************************
    >   localhost: ok=10   changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0


# -----------------------------------------------------
# Check we can loign via ssh.
#[user@desktop]

    ssh fedora@128.232.224.74 \
        '
        date
        hostname
        '

    >   The authenticity of host '128.232.224.74 (128.232.224.74)' can't be established.
    >   ECDSA key fingerprint is SHA256:w58Ls3IrO6ggWF0EtC2Dx1Z1Mh5o48WfFMG/nDJmgEw.
    >   Are you sure you want to continue connecting (yes/no)? yes
    >   Warning: Permanently added '128.232.224.74' (ECDSA) to the list of known hosts.
    >   Wed  7 Aug 04:48:53 UTC 2019
    >   wed-aug--7-044149-utc-2019.novalocal


    ssh fedora@128.232.224.74 \
        '
        date
        hostname
        '

    >   Wed  7 Aug 04:49:23 UTC 2019
    >   wed-aug--7-044149-utc-2019.novalocal


# -----------------------------------------------------
# Create an instance and add a public IP address.
# https://docs.ansible.com/ansible/latest/modules/list_of_cloud_modules.html#openstack
#[root@ansible]

    cat > "/tmp/06-create-servers.yml" << EOF

- name: Create servers
  hosts: localhost
  tasks:

    - name: create security group
      os_security_group:
        cloud: cumulus
        state: present
        name: 'public-access'
      register:
        public_access

    - name: create rule for IPv4 SSH
      os_security_group_rule:
        cloud: cumulus
        state: present
        security_group: 'public-access'
        direction: 'ingress'
        protocol:  'tcp'
        ethertype: 'IPv4'
        port_range_min: 22
        port_range_max: 22
        remote_ip_prefix: '0.0.0.0/0'

    - name: create for IPv6 SSH
      os_security_group_rule:
        cloud: cumulus
        state: present
        security_group: 'public-access'
        direction: 'ingress'
        protocol:  'tcp'
        ethertype: 'IPv6'
        port_range_min: 22
        port_range_max: 22
        remote_ip_prefix: '::/0'

    - name: create instance
      os_server:
        cloud: 'cumulus'
        state: present
        image: 'Fedora-30-1.2'
        flavor: 'general.v1.small'
        network: 'cumulus-internal'
        key_name: 'cumulus-cam-ac-uk-rsa'
        auto_ip: no
      register:
        instance

    - name: create floating
      os_floating_ip:
        cloud: 'cumulus'
        state: present
        server: '{{ instance.id }}'
        network: 'internet'
        nat_destination: 'cumulus-internal'
      register:
        floating

    - name: attach floating
      os_port:
        state: present
        name: '{{ floating.floating_ip.port }}'
        security_groups:
          - '{{ public_access.id }}'

    - debug:
        var: floating.floating_ip.floating_ip_address

    - name: add to group
      add_host:
        name: '{{ floating.floating_ip.floating_ip_address }}'
        groups:
            servers

EOF

# -----------------------------------------------------
# Run our playbook ...
#[root@ansible]

    ansible-playbook "/tmp/06-create-servers.yml"





































